<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-Z</title>
    <link rel="icon" href="https://firebasestorage.googleapis.com/v0/b/genz-abb36.appspot.com/o/photo_2025-03-09_13-00-43.jpg?alt=media&token=e3d3c543-164c-4c79-8cd1-0a9c710fb002">
    <link href="https://fonts.googleapis.com/css2?family=Billabong&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <style>
        input, textarea, select, button {
            font-size: 16px;
            touch-action: manipulation;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: white;
            position: relative;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }
        header {
            background-color: white;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s ease;
        }
        
        h1 {
            margin: 0;
            font-size: 1.4em;
            font-family: 'Billabong', cursive;
            color: #007bff;
            border: 2px solid #007bff;
            padding: 4px;
            border-radius: 12px;
            font-weight: bold;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .divider {
            height: 0.6px;
            background-color: #007bff;
            width: 100%;
            margin-top: 5px;
            transition: background-color 0.3s ease;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            padding: 5px 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .button-container::-webkit-scrollbar {
            display: none;
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            margin: 0 3px;
            font-size: 0.8em;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }
        .button i {
            margin-right: 2px;
        }
        .notification {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #0056b3;
            font-weight: bold;
            transition: color 0.3s ease;
            padding: 3px 0;
            max-height: 30px;
            overflow: hidden;
        }
        .share-icon {
            color: #007bff;
            cursor: pointer;
            font-size: 1.3em;
            border: 1px solid #007bff;
            border-radius: 7px;
            padding: 4px;
            background-color: white;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        footer {
            background-color: white;
            color: black;
            padding: 10px 15px;
            margin-top: auto;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
        }
        .logo {
            color: #007bff;
            font-size: 1.6em;
            margin-right: 10px;
            border: 1px solid #007bff;
            border-radius: 10px;
            padding: 5px;
            background-color: rgba(0, 119, 190, 0.1);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .logo:hover {
            background-color: #007bff;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            margin: 50% auto;
            padding: 14px;
            border: 1px solid #007bff;
            border-radius: 60px;
            width: 280px;
            max-width: 70%;
            text-align: center;
            max-height: 60vh;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
            transform: scale(0.8);
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            font-size: 1.8em;
            font-family: 'Billabong', cursive;
            margin-bottom: 10px;
            font-weight: bold;
            color: #007bff;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        
        .modal-footer {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        .close-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.9em;
            width: 120px;
            margin: 4px;
            transition: background-color 0.3s ease;
        }
        .close-button:hover {
            background-color: #0056b3;
        }
        
        @keyframes flowerRotate {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-15deg); }
            100% { transform: rotate(0deg); }
        }
        
        .flower-icon {
            display: inline-block;
            animation: flowerRotate 2s infinite ease-in-out;
            color: #ff69b4;
        }
        
        .billabong-title {
            font-family: 'Billabong', cursive;
            font-size: 1.8em;
            margin-bottom: 8px;
            color: #007bff;
            transition: color 0.3s ease;
        }

        .monthly-motivation {
            margin: 15px 0;
            padding: 10px;
            border: 1px dashed #ff69b4;
            border-radius: 15px;
            background-color: white;
            font-style: italic;
            color: #333;
            font-size: 0.9em;
            line-height: 1.4;
            transition: border-color 0.3s ease, color 0.3s ease, background-color 0.3s ease;
            position: relative;
        }
        
        .flower-code {
            display: block;
            font-weight: bold;
            color: #ff69b4;
            font-size: 0.9em;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            background-color: #fff0f8;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid #ff69b4;
            max-width: 220px;
            margin-left: auto;
            margin-right: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .copy-icon {
            color: #007bff;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2em;
            vertical-align: middle;
            transition: color 0.3s ease;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
        }
        
        .celebrate-icon {
            font-size: 2em;
            color: gold;
            margin-bottom: 8px;
            animation: celebrate 2s infinite alternate;
        }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(-5deg); }
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #ff0000;
            font-size: 13px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }
        
        .share-flower-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 14px;
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 290px auto;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            max-width: 190px;
            position: relative;
            z-index: 1001;
            border: 1px solid #0056b3;
        }
        
        .share-flower-button:hover {
            background-color: #0056b3;
        }
        
        .share-flower-button i {
            margin-left: 8px;
        }
        
        #capturedFlower {
            position: fixed;
            z-index: 1003;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .captured-image-container {
            position: relative;
            max-width: 85%;
            max-height: 60vh;
            margin-bottom: 15px;
        }
        
        .captured-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 15px;
            border: 2px solid white;
        }
        
        .share-message {
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 10px auto;
            max-width: 90%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .share-message i {
            margin-left: 8px;
            color: #007bff;
            transition: color 0.3s ease;
        }
        
        .share-link {
            color: #007bff;
            font-weight: bold;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .capture-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .capture-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        
        .capture-button i {
            margin-right: 5px;
        }
        
        .close-capture {
            background-color: #f0f0f0;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        #flowerCaptureContainer {
            position: fixed;
            z-index: -1;
            top: 0;
            left: -9999px;
            background-color: white;
            border: 2px solid #007bff;
            border-radius: 20px;
            padding: 15px;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .capture-flower-header {
            font-family: 'Billabong', cursive;
            color: #007bff;
            font-size: 1.8em;
            margin-bottom: 8px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0px 1px 1px rgba(0, 123, 255, 0.2);
            transition: color 0.3s ease;
        }
        
        .capture-flower-code {
            font-weight: bold;
            color: #ff69b4;
            font-size: 0.8em;
            background-color: #fff0f8;
            padding: 6px;
            border-radius: 10px;
            border: 1px solid #ff69b4;
            margin: 6px auto;
            text-align: center;
            max-width: 80%;
            letter-spacing: 0.5px;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .capture-flower-motivation {
            font-style: italic;
            color: #333;
            font-size: 0.95em;
            line-height: 1.4;
            background-color: #f9f9f9;
            border: 1px dashed #ff69b4;
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
            text-align: center;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            position: relative;
        }
        
        .capture-flower-icon {
            text-align: center;
            font-size: 2.5em;
            color: #ff69b4;
            margin: 10px 0;
            transition: color 0.3s ease;
        }
        
        .gz-logo {
            font-family: 'Billabong', cursive;
            color: #007bff;
            font-size: 1.4em;
            text-align: center;
            margin-top: 10px;
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 4px;
            width: 50px;
            margin-left: auto;
            margin-right: auto;
            font-weight: bold;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        .share-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 15px;
            padding: 10px 15px;
            font-size: 0.85em;
            margin: 5px auto 15px auto;
            max-width: 90%;
            text-align: center;
            display: none;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .capture-website-url {
            text-align: center;
            font-size: 0.85em;
            color: #007bff;
            font-weight: bold;
            margin-top: 8px;
            font-family: Arial, sans-serif;
            padding: 3px 0;
            border-top: 1px dashed #007bff;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        .terms-text {
            font-size: 0.8em;
            color: black;
            text-align: center;
            margin: 10px auto;
            width: 330px;
            transition: color 0.3s ease;
        }
        
        .billabong-title {
            margin-bottom: 3px;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0 1px;
        }

        .header-icon {
            font-size: 1.4em;
            color: #007bff;
            border: 2px solid #007bff;
            padding: 4px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .app-logo {
            font-family: 'Billabong', cursive;
            color: #007bff;
            border: 2px solid #007bff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 1.4em;
            font-weight: bold;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .right-controls {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        #welcomeToast {
            position: fixed;
            top: 160px;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 20px;
            width: 80%;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            font-family: , cursive;
            font-size: 1.1em;
            border: 2px solid #4CAF50;
        }

        #welcomeModal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #welcomeModal.show {
            opacity: 1;
        }

        #welcomeModal .modal-content {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 40% auto;
            padding: 15px 10px;
            border: 2px solid #4CAF50;
            border-radius: 25px;
            width: 85%;
            max-width: 290px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s ease;
            transform: scale(0.8);
        }
        #welcomeModal.show .modal-content {
            transform: scale(1);
        }

        #welcomeModal .close {
            color: red;
            font-size: 18px;
            font-weight: bold;
            display: block;
            text-align: center;
            margin-bottom: 3px;
            cursor: pointer;
        }

        #welcomeModal .welcome-header {
            color: #007bff;
            font-family: 'Billabong', cursive;
            font-size: 1.8em;
            margin-bottom: 8px;
            text-align: center;
            font-weight: bold;
        }

        #welcomeModal .welcome-text {
            margin: 10px 0 15px 0;
            font-size: 0.8em;
            color: #333;
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        .dob-container {
            margin: 10px 0;
        }

        .dob-container label {
            display: block;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .dob-input {
            width: 90%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .profession-container {
            margin: 12px 0;
            position: relative;
        }

        .profession-container label {
            display: block;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .profession-search {
            width: 90%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .profession-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 90%;
            max-height: 150px;
            overflow-y: auto;
            left: 5%;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .profession-option {
            padding: 8px 10px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: white;
            color: #333;
        }

        .profession-option:hover {
            background-color: #f5f5f5;
        }

        .name-container {
            margin: 10px 0;
        }

        .name-container label {
            display: block;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .name-input {
            width: 90%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        #createAccountButton {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            margin: 10px auto 5px;
            display: block;
            width: 80%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }
        
        #createAccountButton:hover {
            background: linear-gradient(135deg, #0056b3 0%, #003d80 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
        }
        
        #createAccountButton:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.3);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
            display: inline-block;
            width: 20px;
            text-align: left;
        }

        #idModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #idModal.show {
            opacity: 1;
        }

        #idModal .modal-content {
            background-color: #fff;
            margin: 45% auto;
            padding: 15px;
            border: 1px solid #007BFF;
            border-radius: 25px;
            width: 65%;
            max-width: 250px;
            text-align: center;
            transition: transform 0.3s ease;
            transform: scale(0.8);
        }
        #idModal.show .modal-content {
            transform: scale(1);
        }

        .id-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .id-title {
            font-size: 1em;
            color: #007bff;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .id-display {
            font-weight: bold;
            font-size: 1.2em;
            color: #ff69b4;
            background-color: #fff0f8;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid #ff69b4;
            margin: 5px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 80%;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        .delete-account {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 10px;
            font-size: 0.7em;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-account:hover {
            background-color: #e60000;
        }

        .copy-icon {
            margin-left: 6px;
        }

        .id-message {
            font-size: 0.7em;
            color: #333;
            margin: 5px 0;
            transition: color 0.3s ease;
        }

        #idModal .close-button {
            margin-top: 8px;
            width: auto;
            padding: 6px 15px;
            font-size: 0.7em;
            height: 28px;
        }

        .menu-link {
            text-decoration: none;
            color: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        
        .style-selector {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            transition: background-color 0.3s ease;
        }
        
        .style-selector h3 {
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #333;
            transition: color 0.3s ease;
        }
        
        .style-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 0 5px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .style-options::-webkit-scrollbar {
            display: none;
        }
        
        .style-option {
            width: 60px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        
        .style-option.selected {
            border: 2px solid white;
            box-shadow: 0 0 0 2px #007bff;
        }
        
        .style-option.red-black {
            background: linear-gradient(to right, #FF4500, #8B0000, #121212, #121212);
        }
        
        .style-option.green-blue {
            background: linear-gradient(to right, #3EB489, #14532D, #0A2239, #1A2E4D);
        }
        
        .style-option.orange-pink {
            background: linear-gradient(to right, #FF7F50, #FF6F91, #C71585, #4B0082);
        }
        
        .style-option.yellow-purple {
            background: linear-gradient(to right, #FFD700, #FFA500, #8A2BE2, #4B0082);
        }
        
        .style-option.default {
            background: linear-gradient(to right, #007bff, #0056b3);
        }
        
        .main-content {
            padding-bottom: 80px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        
        body.theme-default {
            background-color: white;
            color: #333;
        }
        
        body.theme-default header, 
        body.theme-default footer,
        body.theme-default .style-selector {
            background-color: white;
        }
        
        body.theme-default .app-logo,
        body.theme-default .header-icon,
        body.theme-default .divider,
        body.theme-default .notification,
        body.theme-default .billabong-title,
        body.theme-default .gz-logo,
        body.theme-default .capture-website-url,
        body.theme-default .capture-flower-header,
        body.theme-default .id-title {
            color: #007bff;
            border-color: #007bff;
        }
        
        body.theme-default .notification .notification-text {
            color: #007bff;
        }
        
        body.theme-default .button {
            background-color: #007bff;
        }
        
        body.theme-default .share-flower-button {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        body.theme-default .flower-code,
        body.theme-default .id-display {
            color: #ff69b4;
            background-color: #fff0f8;
            border-color: #ff69b4;
        }
        
        body.theme-default .monthly-motivation,
        body.theme-default .capture-flower-motivation {
            border-color: #ff69b4;
            color: #333;
            background-color: white;
        }
        
        body.theme-default .modal-content {
            background-color: white;
            border-color: #007bff;
        }
        
        body.theme-red-black {
            background: black;
            color: #E5E5E5;
        }
        
        body.theme-red-black header, 
        body.theme-red-black footer,
        body.theme-red-black .style-selector {
            background-color: black;
        }
        
        body.theme-red-black .app-logo,
        body.theme-red-black .header-icon,
        body.theme-red-black .gz-logo,
        body.theme-red-black .capture-flower-header,
        body.theme-red-black .capture-website-url,
        body.theme-red-black .id-title,
        body.theme-red-black .billabong-title {
            color: #FF4500;
            border-color: #FF4500;
        }
        
        body.theme-red-black .divider {
            background-color: #FF4500;
        }
        
        body.theme-red-black .notification .notification-text {
            color: #FF4500;
        }
        
        body.theme-red-black .notification,
        body.theme-red-black .welcome-text,
        body.theme-red-black .id-message {
            color: #CCCCCC;
        }
        
        body.theme-red-black .button {
            background-color: #8B0000;
        }
        
        body.theme-red-black .share-flower-button {
            background-color: #8B0000;
            color: white;
            border-color: #FF4500;
        }
        
        body.theme-red-black .flower-code,
        body.theme-red-black .id-display {
            color: #FF4500;
            background-color: black;
            border-color: #FF4500;
        }
        
        body.theme-red-black .monthly-motivation,
        body.theme-red-black .capture-flower-motivation {
            border-color: #FF4500;
            color: #E5E5E5;
            background-color: black;
        }
        
        body.theme-red-black .modal-content,
        body.theme-red-black #flowerCaptureContainer {
            background-color: black;
            border-color: #8B0000;
        }
        
        body.theme-green-blue {
            background: #1A2E4D;
            color: #F5F5F5;
        }
        
        body.theme-green-blue header, 
        body.theme-green-blue footer,
        body.theme-green-blue .style-selector {
            background-color: #1A2E4D;
        }
        
        body.theme-green-blue .app-logo,
        body.theme-green-blue .header-icon,
        body.theme-green-blue .gz-logo,
        body.theme-green-blue .capture-flower-header,
        body.theme-green-blue .capture-website-url,
        body.theme-green-blue .id-title,
        body.theme-green-blue .billabong-title {
            color: #3EB489;
            border-color: #3EB489;
        }
        
        body.theme-green-blue .divider {
            background-color: #3EB489;
        }
        
        body.theme-green-blue .notification .notification-text {
            color: #3EB489;
        }
        
        body.theme-green-blue .notification,
        body.theme-green-blue .welcome-text,
        body.theme-green-blue .id-message {
            color: #A0A0A0;
        }
        
        body.theme-green-blue .button {
            background-color: #14532D;
        }
        
        body.theme-green-blue .share-flower-button {
            background-color: #14532D;
            color: white;
            border-color: #3EB489;
        }
        
        body.theme-green-blue .flower-code,
        body.theme-green-blue .id-display {
            color: #3EB489;
            background-color: #36454F;
            border-color: #3EB489;
        }
        
        body.theme-green-blue .monthly-motivation,
        body.theme-green-blue .capture-flower-motivation {
            border-color: #3EB489;
            color: #F5F5F5;
            background-color: #1A2E4D;
        }
        
        body.theme-green-blue .modal-content,
        body.theme-green-blue #flowerCaptureContainer {
            background-color: #1A2E4D;
            border-color: #3EB489;
        }
        
        body.theme-orange-pink {
            background: #4B0082;
            color: #FFFFFF;
        }
        
        body.theme-orange-pink header, 
        body.theme-orange-pink footer,
        body.theme-orange-pink .style-selector {
            background-color: #4B0082;
        }
        
        body.theme-orange-pink .app-logo,
        body.theme-orange-pink .header-icon,
        body.theme-orange-pink .gz-logo,
        body.theme-orange-pink .capture-flower-header,
        body.theme-orange-pink .capture-website-url,
        body.theme-orange-pink .id-title,
        body.theme-orange-pink .billabong-title {
            color: #FF7F50;
            border-color: #FF7F50;
        }
        
        body.theme-orange-pink .divider {
            background-color: #FF7F50;
        }
        
        body.theme-orange-pink .notification .notification-text {
            color: #FF7F50;
        }
        
        body.theme-orange-pink .notification,
        body.theme-orange-pink .welcome-text,
        body.theme-orange-pink .id-message {
            color: #D3D3D3;
        }
        
        body.theme-orange-pink .button {
            background-color: #C71585;
        }
        
        body.theme-orange-pink .share-flower-button {
            background-color: #C71585;
            color: white;
            border-color: #FF7F50;
        }
        
        body.theme-orange-pink .flower-code,
        body.theme-orange-pink .id-display {
            color: #FF7F50;
            background-color: #6A0DAD;
            border-color: #FF7F50;
        }
        
        body.theme-orange-pink .monthly-motivation,
        body.theme-orange-pink .capture-flower-motivation {
            border-color: #FF7F50;
            color: #FFFFFF;
            background-color: #4B0082;
        }
        
        body.theme-orange-pink .modal-content,
        body.theme-orange-pink #flowerCaptureContainer {
            background-color: #4B0082;
            border-color: #FF7F50;
        }

        body.theme-yellow-purple {
            background: #4B0082;
            color: #FFFFFF;
        }
        
        body.theme-yellow-purple header, 
        body.theme-yellow-purple footer,
        body.theme-yellow-purple .style-selector {
            background-color: #4B0082;
        }
        
        body.theme-yellow-purple .app-logo,
        body.theme-yellow-purple .header-icon,
        body.theme-yellow-purple .gz-logo,
        body.theme-yellow-purple .capture-flower-header,
        body.theme-yellow-purple .capture-website-url,
        body.theme-yellow-purple .id-title,
        body.theme-yellow-purple .billabong-title {
            color: #FFD700;
            border-color: #FFD700;
        }
        
        body.theme-yellow-purple .divider {
            background-color: #FFD700;
        }
        
        body.theme-yellow-purple .notification .notification-text {
            color: #FFD700;
        }
        
        body.theme-yellow-purple .notification,
        body.theme-yellow-purple .welcome-text,
        body.theme-yellow-purple .id-message {
            color: #D3D3D3;
        }
        
        body.theme-yellow-purple .button {
            background-color: #8A2BE2;
        }
        
        body.theme-yellow-purple .share-flower-button {
            background-color: #8A2BE2;
            color: white;
            border-color: #FFD700;
        }
        
        body.theme-yellow-purple .flower-code,
        body.theme-yellow-purple .id-display {
            color: #FFD700;
            background-color: #6A0DAD;
            border-color: #FFD700;
        }
        
        body.theme-yellow-purple .monthly-motivation,
        body.theme-yellow-purple .capture-flower-motivation {
            border-color: #FFD700;
            color: #FFFFFF;
            background-color: #4B0082;
        }
        
        body.theme-yellow-purple .modal-content,
        body.theme-yellow-purple #flowerCaptureContainer {
            background-color: #4B0082;
            border-color: #FFD700;
        }
        
        .refresh-motivation {
            position: absolute;
            right: 15px;
            top: 70px;
            color: #007bff;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        
        .refresh-motivation:hover {
            transform: rotate(180deg);
        }
        
        body.theme-red-black .refresh-motivation {
            color: #FF4500;
        }
        
        body.theme-green-blue .refresh-motivation {
            color: #3EB489;
        }
        
        body.theme-orange-pink .refresh-motivation {
            color: #FF7F50;
        }
        
        body.theme-yellow-purple .refresh-motivation {
            color: #FFD700;
        }
        
        .user-name {
            font-size: 0.75em;
            font-weight: bold;
        }
    </style>
</head>
<body class="theme-green-blue">

  <header>
   
    <div class="header-container">
      <div class="app-logo" translate="no">G-Z</div>
      
      <div class="right-controls">
      
        <a href="https://g-z.online/language.html" class="header-icon menu-link"><i class="fas fa-globe"></i></a>
        
      <div class="right-controls">
        <div class="header-icon" id="showIdButton"><i class="fas fa-user"></i></div>
  
        
        <a href="https://g-z.online/us.html" class="header-icon menu-link"><i class="fas fa-bars"></i></a>
      </div>
    </div>
  </header>

  <div class="divider"></div>

  <div class="main-content">
    <div class="button-container">
      <a class="button" href="#" id="flowerButton"><i class="fas fa-spa flower-icon"></i><span>زهرة الحياة</span></a>
    </div>

    <div class="divider"></div>
    <div class="notification">
      <span class="notification-text">💠 الزهرة -- الرسالة التي كتبها الكون خصيصًا لك ¯\_(ツ)_/¯</span>
    </div>

    <div class="divider"></div>
  </div>

  <div class="style-selector">
    <h3>النمط</h3>
    <div class="style-options">
      <div class="style-option red-black" data-theme="red-black"></div>
      <div class="style-option green-blue selected" data-theme="green-blue"></div>
      <div class="style-option orange-pink" data-theme="orange-pink"></div>
      <div class="style-option yellow-purple" data-theme="yellow-purple"></div>
      <div class="style-option default" data-theme="default"></div>
    </div>
  </div>

  <div id="welcomeToast" translate="no">
    مرحبًا بك ¯\_(ツ)_/¯
  </div>

  <div id="welcomeModal" class="modal">
    <div class="modal-content">
      <div class="welcome-header">💠 مرحبًا 💠</div>
      <div class="welcome-text">
        يتطلب إنشاء الحساب تاريخ ميلادك ومهنتك واسمك لإنشاء زهرتك الفريدة.
      </div>
      
      <div class="name-container">
        <label for="fullNameInput">اسمك الكامل:</label>
        <input type="text" id="fullNameInput" class="name-input" placeholder="أدخل اسمك الكامل...">
      </div>
      
      <div class="dob-container">
        <label for="dobInput">تاريخ الميلاد:</label>
        <input type="date" id="dobInput" class="dob-input" max="">
      </div>
      
      <div class="profession-container">
        <label for="professionInput">مهنتك:</label>
        <input type="text" id="professionInput" class="profession-search" placeholder="اكتب مهنتك...">
        <div id="professionDropdown" class="profession-dropdown"></div>
      </div>
      
      <div class="loading-spinner" id="loadingSpinner">
        <span>جاري إنشاء زهرتك الفريدة</span>
        <span class="loading-dots"></span>
      </div>
      
      <button id="createAccountButton">إنشاء حساب</button>
    </div>
  </div>

  <div id="idModal" class="modal">
    <div class="modal-content">
      <div class="id-title">معرف المستخدم الخاص بك</div>
      <div class="id-display">
        <span id="userIdDisplay"></span>
        <i class="fas fa-copy copy-icon" id="copyIdButton"></i>
      </div>
      <div class="id-message">احتفظ بهذا المعرف في مكان آمن!</div>
      <div class="id-actions">
        <button class="delete-account" id="deleteAccountButton">حذف الحساب</button>
        <button class="close-button" id="closeIdModal">إغلاق</button>
      </div>
    </div>
  </div>

  <div id="flowerModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeFlowerModal"><i class="fas fa-times"></i></button>
      <div class="billabong-title"><strong id="flowerTypeTitle">زهرة الحياة</strong></div>
      
      <div id="flowerCodeDisplay" class="flower-code"></div>
      
      <i class="fas fa-sync-alt refresh-motivation" id="refreshMotivation" title="توليد تحفيز جديد"></i>
      
      <div class="monthly-motivation" id="monthlyMotivation">
      </div>
      
      <div style="margin: 10px auto; font-size: 3em; color: #ff69b4;" id="flowerIconContainer">
        <i class="fas fa-spa"></i>
      </div>
    </div>
  </div>
  
  <button class="share-flower-button" id="shareFlowerButton">
    <span>مشاركة زهرتي</span> <i class="fas fa-paper-plane"></i>
  </button>
  
  <div id="capturedFlower">
    <div class="captured-image-container">
      <img id="capturedImage" class="captured-image" src="" alt="زهرة ملتقطة">
    </div>

    <div class="share-warning" id="shareWarning">
      <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i>
      <span>مثالية للمشاركة، فقط قم بالتعديل.</span>
    </div>
    
    <div class="capture-controls">
      <button class="capture-button" id="shareCapture">
        <i class="fas fa-arrow-right send-icon"></i> <span>مشاركة</span>
      </button>
      
      <button class="capture-button close-capture" id="closeCapture">
        <i class="fas fa-times"></i> <span>إغلاق</span>
      </button>
    </div>
  </div>
  
  <div id="flowerCaptureContainer">
    <div class="capture-flower-header" id="captureFlowerHeader">زهرة الحياة</div>
    
    <div id="captureFlowerCode" class="capture-flower-code"></div>
    
    <div id="captureFlowerMotivation" class="capture-flower-motivation">
    </div>
    
    <div class="capture-flower-icon" id="captureFlowerIcon">
      <i class="fas fa-spa"></i>
    </div>
    
    <div class="gz-logo" translate="no">G-Z</div>
  <div class="capture-website-url">
  اكتشف زهرتك على <span translate="no">www.g-z.online</span>
</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCrPKQOqw4zciASa_5PbI_etfkvrBaDPDI",
      authDomain: "genz-abb36.firebaseapp.com",
      databaseURL: "https://genz-abb36-default-rtdb.firebaseio.com",
      projectId: "genz-abb36",
      storageBucket: "genz-abb36.firebasestorage.app",
      messagingSenderId: "405021535683",
      appId: "1:405021535683:web:ee5a28fde27f5558046176",
      measurementId: "G-XZNQND2J00"
    };

    firebase.initializeApp(firebaseConfig);
    
    const auth = firebase.auth();
    const database = firebase.database();
    const firestore = firebase.firestore();
    
    let userUid = null;
    let userFlowerCode = null;
    let currentMotivation = null;
    let currentCountry = null;
    let userCity = null;
    let userUniqueId = null;
    let isAuthenticated = false;
    let isInstalled = false;
    let currentTheme = "green-blue";
    let userDateOfBirth = null;
    let userProfession = null;
    let userFullName = null;
    let seenSubjects = [];
    let shareCount = 0;
    let userRank = 0;
    let userEmoji = "👑";

    const rankEmojis = ["👑", "🌟", "🔥", "⚡️", "⭐️", "❄️", "✨️", "🎖", "🗿"];

    const professions = [
      "موسيقي", "مغني راب", "لاعب كرة قدم", "لاعب كرة سلة", "ملاكم", 
      "طالب", "مدرس", "طبيب", "ممرض/ة", "مهندس", 
      "مطور برمجيات", "مصمم", "فنان", "كاتب", "صحفي", 
      "طباخ", "نادل/ة", "مدبر منزلي", "منشئ محتوى تيك توك", "يوتيوبر", 
      "مؤثر", "مصور فوتوغرافي", "مصور فيديو", "راقص", "ممثل/ة", 
      "عارض أزياء", "مهندس معماري", "محامي", "محاسب", "مستشار مالي", 
      "مصرفي", "رائد أعمال", "صاحب عمل", "مدير", "تنفيذي", 
      "مندوب مبيعات", "مسوق", "مدير وسائل تواصل اجتماعي", "سائق", "طيار", 
      "مضيف/ة طيران", "ميكانيكي", "كهربائي", "سباك", "عامل بناء", 
      "مزارع", "بستاني", "طبيب بيطري", "مدرب شخصي", "مدرب لياقة بدنية", 
      "مدرس يوغا", "معالج", "أخصائي نفسي", "مرشد", "راعي ديني/زعيم ديني",
      "عالم", "باحث", "أستاذ جامعي", "ضابط شرطة", "رجل إطفاء",
      "عسكري", "حارس أمن", "وكيل عقارات", "صيدلي", "طبيب أسنان",
      "طبيب عيون", "معالج فيزيائي", "معالج مهني", "معالج نطق", "أخصائي تغذية",
      "أخصائي تغذية", "مصفف شعر", "خبير مكياج", "خبير تجميل", "خياط",
      "مصمم أزياء", "عامل تجزئة", "أمين صندوق", "ممثل خدمة عملاء", "موظف مركز اتصال",
      "مترجم", "مترجم فوري", "مرشد سياحي", "وكيل سفر", "مدير فندق",
      "موظف استقبال", "سكرتير", "مساعد إداري", "أمين مكتبة", "أمين محفوظات",
      "مؤرخ", "عالم آثار", "عالم أنثروبولوجيا", "عالم اجتماع", "عالم سياسة",
      "اقتصادي", "إحصائي", "محلل بيانات", "عالم بيانات", "مصمم تجربة المستخدم",
      "مطور ألعاب", "مطور تطبيقات", "مطور ويب", "مدير شبكات", "متخصص أمن سيبراني",
      "دعم تقني", "فني", "أخصائي إصلاح", "خباز", "جزار",
      "صياد سمك", "عامل منجم", "حطاب", "منسق حدائق", "مصمم داخلي",
      "منظم فعاليات", "منظم حفلات زفاف", "بائع زهور", "صائغ", "حرفي",
      "مبرمج", "مصمم ويب", "مسوق رقمي", "أخصائي تحسين محركات البحث", "منشئ محتوى",
      "مدير منتج", "مدير مشروع", "ضمان جودة", "محلل أعمال", "مستشار",
      "موظف توظيف", "مدير موارد بشرية", "مدرب مهني", "مدرب حياة", "متحدث تحفيزي",
      "متحدث عام", "مذيع راديو", "مذيع تلفزيوني", "مذيع", "منتج بودكاست",
      "مؤلف", "كاتب سيناريو", "كاتب إعلاني", "كاتب تقني", "محرر",
      "ناشر", "وكيل أدبي", "صاحب مكتبة", "أمين مكتبة", "ناقد كتب",
      "مصمم جرافيك", "رسام توضيحي", "رسام متحرك", "فنان ثلاثي الأبعاد", "فنان مؤثرات بصرية",
      "مخرج أفلام", "منتج", "مشغل كاميرا", "مهندس صوت", "فني إضاءة",
      "محرر أفلام", "مساعد إنتاج", "مصمم ديكور", "مصمم أزياء", "فنان مكياج للأفلام",
      "فنان مؤثرات خاصة", "منفذ مشاهد خطرة", "ممثل صوتي", "وكيل مواهب", "مدير اختيار ممثلين"
    ];

    const subjectDictionary = {
      "النجاح": "النجاح",
      "الإنجاز": "الإنجاز",
      "الانتصار": "الانتصار",
      "التفوق": "التفوق",
      "التحقيق": "التحقيق",
      
      "الثروة": "الثروة",
      "الازدهار": "الازدهار",
      "الوفرة": "الوفرة",
      "الحظ": "الحظ",
      "الثراء": "الثراء",
      
      "الفرح": "الفرح",
      "السعادة": "السعادة",
      "النعيم": "النعيم",
      "البهجة": "البهجة",
      "الرضا": "الرضا",
      
      "النمو": "النمو",
      "التقدم": "التقدم",
      "التطور": "التطور",
      "التنمية": "التنمية",
      "التحسين": "التحسين",
      
      "القوة": "القوة",
      "العزم": "العزم",
      "الجبروت": "الجبروت",
      "القدرة": "القدرة",
      "الطاقة": "الطاقة",
      
      "الحكمة": "الحكمة",
      "الذكاء": "الذكاء",
      "المعرفة": "المعرفة",
      "البصيرة": "البصيرة",
      "الفهم": "الفهم",
      
      "الإبداع": "الإبداع",
      "الابتكار": "الابتكار",
      "الخيال": "الخيال",
      "الاختراع": "الاختراع",
      "الأصالة": "الأصالة",
      
      "القيادة": "القيادة",
      "السلطة": "السلطة",
      "التأثير": "التأثير",
      "الأمر": "الأمر",
      "التوجيه": "التوجيه",
      
      "السلام": "السلام",
      "الوئام": "الوئام",
      "الهدوء": "الهدوء",
      "الصفاء": "الصفاء",
      "السكينة": "السكينة",
      
      "الحب": "الحب",
      "المودة": "المودة",
      "الإعجاب": "الإعجاب",
      "التفاني": "التفاني",
      "الشغف": "الشغف",
      
      "الشجاعة": "الشجاعة",
      "الجرأة": "الجرأة",
      "البسالة": "البسالة",
      "البطولة": "البطولة",
      "عدم الخوف": "عدم الخوف",
      
      "الصحة": "الصحة",
      "الحيوية": "الحيوية",
      "العافية": "العافية",
      "النشاط": "النشاط",
      "اللياقة": "اللياقة",
      
      "الحرية": "الحرية",
      "الاستقلال": "الاستقلال",
      "الاستقلالية": "الاستقلالية",
      "الذاتية": "الذاتية",
      "تقرير المصير": "تقرير المصير",
      
      "الهدف": "الهدف",
      "المعنى": "المعنى",
      "المهمة": "المهمة",
      "الدعوة": "الدعوة",
      "المصير": "المصير",
      
      "المرونة": "المرونة",
      "الصلابة": "الصلابة",
      "المثابرة": "المثابرة",
      "التحمل": "التحمل",
      "الإصرار": "الإصرار",
      
      "الأصالة": "الأصالة",
      "الصدق": "الصدق",
      "النزاهة": "النزاهة",
      "الاستقامة": "الاستقامة",
      "الإخلاص": "الإخلاص",
      
      "التحول": "التحول",
      "التغيير": "التغيير",
      "التطور": "التطور",
      "الولادة الجديدة": "الولادة الجديدة",
      "التحول الجذري": "التحول الجذري",
      
      "الاتصال": "الاتصال",
      "العلاقة": "العلاقة",
      "المجتمع": "المجتمع",
      "الانتماء": "الانتماء",
      "الوحدة": "الوحدة",
      
      "الامتنان": "الامتنان",
      "الشكر": "الشكر",
      "التقدير": "التقدير",
      "الاعتراف": "الاعتراف",
      "الإقرار": "الإقرار",
      
      "اليقظة": "اليقظة",
      "الحضور": "الحضور",
      "الوعي": "الوعي",
      "الإدراك": "الإدراك",
      "الانتباه": "الانتباه",
      
      "التعاطف": "التعاطف",
      "الشفقة": "الشفقة",
      "اللطف": "اللطف",
      "الكرم": "الكرم",
      "الإيثار": "الإيثار",
      
      "التوازن": "التوازن",
      "الاعتدال": "الاعتدال",
      "الانسجام": "الانسجام",
      "التناسب": "التناسب",
      "التماثل": "التماثل",
      
      "الإلهام": "الإلهام",
      "التحفيز": "التحفيز",
      "الحماس": "الحماس",
      "الإثارة": "الإثارة",
      "العاطفة": "العاطفة",
      
      "التركيز": "التركيز",
      "الانتباه": "الانتباه",
      "الانضباط": "الانضباط",
      "التفاني": "التفاني",
      "الالتزام": "الالتزام",
      
      "التواضع": "التواضع",
      "الاعتدال": "الاعتدال",
      "البساطة": "البساطة",
      "عدم التكلف": "عدم التكلف",
      "الأرضية": "الأرضية",
      
      "الصبر": "الصبر",
      "التسامح": "التسامح",
      "الاحتمال": "الاحتمال",
      "التحمل": "التحمل",
      "المثابرة": "المثابرة",
      
      "الفرح": "الفرح",
      "السرور": "السرور",
      "البهجة": "البهجة",
      "الابتهاج": "الابتهاج",
      "الاحتفال": "الاحتفال",
      
      "الثقة": "الثقة",
      "الإيمان": "الإيمان",
      "الاطمئنان": "الاطمئنان",
      "الاعتماد": "الاعتماد",
      "الموثوقية": "الموثوقية",
      
      "الثقة بالنفس": "الثقة بالنفس",
      "احترام الذات": "احترام الذات",
      "الإيمان بالنفس": "الإيمان بالنفس",
      "اليقين الذاتي": "اليقين الذاتي",
      "الثقة الذاتية": "الثقة الذاتية",
      
      "الحماس": "الحماس",
      "الحمية": "الحمية",
      "اللهفة": "اللهفة",
      "الشغف": "الشغف",
      "الحرارة": "الحرارة",
      
      "الوضوح": "الوضوح",
      "الصفاء": "الصفاء",
      "الشفافية": "الشفافية",
      "الدقة": "الدقة",
      "الحدة": "الحدة",
      
      "القدرة على التكيف": "القدرة على التكيف",
      "المرونة": "المرونة",
      "تعدد المواهب": "تعدد المواهب",
      "القابلية للتعديل": "القابلية للتعديل",
      "القابلية للتشكيل": "القابلية للتشكيل",
      
      "التواصل": "التواصل",
      "التعبير": "التعبير",
      "النطق": "النطق",
      "الحوار": "الحوار",
      "المحادثة": "المحادثة",
      
      "المهنة": "المهنة",
      "الحرفة": "الحرفة",
      "الوظيفة": "الوظيفة",
      "العمل": "العمل",
      "الدعوة": "الدعوة"
    };

    async function getUserRankAndEmoji() {
      try {
        const userCount = await getUserCount();
        userRank = userCount % rankEmojis.length;
        userEmoji = rankEmojis[userRank];
        console.log(`User rank: ${userRank}, emoji: ${userEmoji}`);
        return userEmoji;
      } catch (error) {
        console.error("Error getting user rank:", error);
        return "👑";
      }
    }

    async function getUserCount() {
      try {
        const snapshot = await firestore.collection('flowerCodes').get();
        return snapshot.size;
      } catch (error) {
        console.error("Error counting users:", error);
        return 0;
      }
    }

    function formatUserName(fullName) {
      if (!fullName) return "";
      
      const nameParts = fullName.trim().split(' ');
      
      if (nameParts.length === 1) {
        return nameParts[0];
      }
      
      const firstName = nameParts[0];
      const lastNameInitial = nameParts[nameParts.length - 1].charAt(0).toUpperCase();
      
      return `${firstName} ${lastNameInitial}.`;
    }

    function generateUniqueId() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const numbers = '0123456789';
      let id = '';
      
      for (let i = 0; i < 3; i++) {
        id += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      
      for (let i = 0; i < 3; i++) {
        id += numbers.charAt(Math.floor(Math.random() * numbers.length));
      }
      
      return id;
    }

    async function detectUserLocation() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        currentCountry = data.country_name;
        userCity = data.city;
        console.log("Detected user location:", currentCountry, userCity);
        return { country: currentCountry, city: userCity };
      } catch (error) {
        console.error("Error detecting user location:", error);
        return { country: "Unknown", city: "Unknown" };
      }
    }

    function generatePersonalizedMotivation(flowerCode, profession, dob) {
      if (!flowerCode || flowerCode.length < 8) {
        return "تحفيز زهرتك هنا ليلهمك ويرشدك.";
      }
      
      let month = 0;
      if (dob) {
        const dobDate = new Date(dob);
        month = dobDate.getMonth();
      }
      
      const lifeTraits = [
        "إبداعك يجلب أفكارًا جديدة لكل تحدٍ.",
        "لطفك يلهم الآخرين من حولك.",
        "إصرارك يساعدك على تجاوز العقبات.",
        "منظورك الفريد يحل المشكلات بطرق جديدة.",
        "طاقتك تنير اليوم لكل من تلتقي به.",
        "صبرك يساعدك على رؤية الصورة الأكبر.",
        "شجاعتك تسمح لك بمواجهة التحديات الجديدة.",
        "حكمتك ترشدك خلال القرارات الصعبة.",
        "تفاؤلك يساعدك على إيجاد الفرص في أي موقف.",
        "تركيزك يساعدك على تحقيق أهدافك خطوة بخطوة.",
        "قدرتك على التكيف هي أعظم قوتك.",
        "حدسك يرشدك إلى المسار الصحيح.",
        "تعاطفك يربطك بعمق مع الآخرين.",
        "مرونتك تساعدك على النهوض أقوى.",
        "أصالتك تجذب الناس إلى ذاتك الحقيقية.",
        "امتنانك يضاعف الفرح في حياتك.",
        "فضولك يقود إلى اكتشافات جديدة.",
        "روح الدعابة لديك تخفف حتى اللحظات الصعبة.",
        "كرمك يخلق موجات من اللطف.",
        "عزمك يحول التحديات إلى إنجازات.",
        "شفقتك تشفي من حولك.",
        "وضوحك يساعدك على اتخاذ خيارات حكيمة.",
        "ثقتك تلهم الثقة في الآخرين.",
        "يقظتك تبقيك متوازنًا في الفوضى.",
        "نزاهتك تكسب الاحترام أينما تذهب.",
        "حماستك تشعل الشغف في الآخرين.",
        "دفئك يجعل الناس يشعرون بالترحيب فورًا.",
        "خيالك يفتح أبوابًا للإمكانيات.",
        "توازنك يساعدك على التنقل في تعقيدات الحياة.",
        "رؤيتك تمكنك من الرؤية إلى ما وراء الأفق.",
        "جاذبيتك تجذب الناس نحو طاقتك.",
        "انضباطك يبني أساسًا للنجاح.",
        "طبيعتك الحدسية تساعدك على فهم الحقائق الدقيقة.",
        "روح المرح لديك تحافظ على روحك شابة ونابضة بالحياة.",
        "عقلك التحليلي يجد حلولًا يفوتها الآخرون.",
        "تفكيرك يخلق روابط ذات معنى.",
        "حساسيتك تسمح لك بإدراك ما يحتاجه الآخرون.",
        "حسمك يدفع المشاريع إلى الأمام بكفاءة.",
        "ثباتك يبني الثقة بمرور الوقت.",
        "قدرتك على التعبير توصل حقيقتك بشكل جميل.",
        "براعتك تحول القيود إلى فرص.",
        "اجتهادك يضمن الجودة في كل ما تفعله.",
        "مرونتك تتكيف مع الظروف المتغيرة بأناقة.",
        "واقعيتك تضع أفعالك على أرض الواقع.",
        "فصاحتك تعبر عن الأفكار المعقدة بوضوح.",
        "بصيرتك تساعدك على الاستعداد للتحديات المستقبلية.",
        "لطفك يشفي الجروح دون ترك ندوب.",
        "حزمك يدافع عما هو صحيح.",
        "استقلاليتك تعزز الاعتماد على الذات والقوة.",
        "ضميرك ينتبه للتفاصيل المهمة.",
        "مرونتك العقلية تساعدك على التكيف مع المواقف الجديدة بسرعة.",
        "وعيك الذاتي ينير طريقك نحو النمو.",
        "قوتك الداخلية تتألق بشكل أكثر سطوعًا خلال الأوقات الصعبة.",
        "شخصيتك المغناطيسية تجذب الناس إلى مدارك.",
        "ذكاؤك العاطفي يساعدك على التنقل في العلاقات المعقدة.",
        "تفكيرك السريع يجد حلولًا عندما يرى الآخرون مشاكل فقط.",
        "ثقتك الهادئة تتحدث بصوت عالٍ دون قول كلمة.",
        "قيادتك الطبيعية تلهم الآخرين لاتباع غرائزهم الأفضل.",
        "أخلاقك الثابتة توجه قراراتك حتى عندما لا يراقبك أحد.",
        "حسك الفني يجد الجمال في أماكن غير متوقعة.",
        "عقلك الاستراتيجي يتوقع التطورات المستقبلية بدقة مذهلة.",
        "عفويتك تجلب طاقة جديدة للمواقف الراكدة.",
        "اهتمامك الدقيق بالتفاصيل يمنع المضاعفات المستقبلية.",
        "حضورك السلمي يهدئ حتى البيئات الأكثر فوضوية.",
        "تفكيرك المبتكر يكسر القيود التقليدية.",
        "دبلوماسيتك الطبيعية تحل النزاعات بأناقة وإنصاف.",
        "جدارتك بالثقة تجعلك موضع ثقة لمن يحتاج إليك.",
        "حماستك المعدية ترفع كل من حولك.",
        "انفتاح عقلك يرحب بوجهات نظر وإمكانيات جديدة."
      ];
      
      const lifeEncouragements = [
        "استمر في مشاركة مواهبك مع العالم.",
        "ثق بحدسك - نادراً ما يقودك إلى الطريق الخطأ.",
        "مواهبك الطبيعية موجودة لتتم مشاركتها.",
        "قد يكون الطريق أمامك مليئًا بالتحديات، لكنك مستعد لها.",
        "الخطوات الصغيرة اليوم تؤدي إلى إنجازات كبيرة غدًا.",
        "تذكر أن تحتفل بتقدمك على طول الطريق.",
        "رحلتك الفريدة تستحق كل خطوة.",
        "لا تنس أن تستمتع بالعملية، وليس فقط بالنتائج.",
        "أفضل أيامك لا تزال أمامك.",
        "جهودك اليوم تبني غدك.",
        "ابق صادقًا مع نفسك في جميع المواقف.",
        "احتضن التغيير كفرصة للنمو.",
        "استمع إلى حكمتك الداخلية أكثر.",
        "اسمح لنفسك بالراحة عند الحاجة.",
        "حافظ على تركيزك على ما يهم حقًا.",
        "وجودك هو هدية لمن حولك.",
        "غذِّ شغفك باستمرار.",
        "كن لطيفًا مع نفسك خلال التحديات.",
        "مسارك الفريد مناسب تمامًا لك.",
        "ثق بتوقيت تكشف حياتك.",
        "ابحث عن الفرح في اللحظات الصغيرة كل يوم.",
        "وجهة نظرك قيمة - شاركها.",
        "آمن بقدرتك على إحداث تغيير.",
        "تذكر لماذا بدأت هذه الرحلة.",
        "كل يوم يقدم بداية جديدة.",
        "مرونتك ملهمة للآخرين.",
        "خذ وقتًا للاحتفال بالانتصارات الصغيرة.",
        "كل تحدٍ تواجهه يقويك.",
        "الكون يدعم مسارك الأصيل.",
        "نورك يتألق بشكل أكثر سطوعًا عندما تكون أنت نفسك.",
        "العالم يحتاج إلى مساهمتك الفريدة.",
        "دع عملك يتحدث عن نفسه.",
        "جهدك المستمر يتراكم بمرور الوقت.",
        "ما يبدو مستحيلًا اليوم سيكون واقعك غدًا.",
        "القوة داخلك أكبر من التحديات التي أمامك.",
        "رحلتك تلهم الآخرين أكثر مما تدرك.",
        "العقبات هي إعادة توجيه إلى مسار أفضل.",
        "عمق شخصيتك يظهر في اللحظات الصعبة.",
        "نموك يحدث خارج منطقة راحتك.",
        "حتى التقدم الصغير لا يزال تقدمًا يستحق الاحتفال.",
        "ابق مركزًا على 'سببك' خلال الأوقات الصعبة.",
        "اختياراتك اليومية تخلق إرثك.",
        "الدروس التي تتعلمها الآن ستفيدك إلى الأبد.",
        "لا تستهن أبدًا بتأثير لطفك.",
        "صوتك الأصيل يتردد صداه مع من يحتاج إلى سماعه.",
        "التحديات التي تتغلب عليها اليوم تبني قوتك للغد.",
        "ماضيك لا يحدد إمكاناتك المستقبلية.",
        "كل خطوة للأمام، مهما كانت صغيرة، لا تزال حركة للأمام.",
        "نهجك الفريد هو ميزتك التنافسية.",
        "ثق بأنك بالضبط حيث تحتاج أن تكون الآن.",
        "أعظم إنجازاتك غالبًا ما تأتي بعد أكبر تحدياتك.",
        "قصتك لا تزال تُكتب - اجعلها رائعة.",
        "الكون يتآمر لصالح أحلامك الأصيلة.",
        "أقوى مواردك هو إيمانك الثابت بنفسك.",
        "التأثير الذي تحدثه على الآخرين أكبر مما تعرف.",
        "قيودك الحالية مؤقتة، لكن إمكاناتك دائمة.",
        "أهم موافقة تأتي من داخل نفسك.",
        "حدسك هو بوصلتك الداخلية - ثق باتجاهها.",
        "انضباط اليوم يخلق حرية الغد.",
        "كل تجربة، جيدة أو صعبة، تضيف عمقًا إلى شخصيتك.",
        "غرض حياتك يتكشف من خلال الفرح والصعوبة.",
        "الطريقة التي تتعامل بها مع المحن تكشف عن قوتك الحقيقية.",
        "تفردك هو أكبر ميزة تنافسية لديك.",
        "اسمح لنفسك بالتطور مع تطور أحلامك.",
        "التزامك بالنمو يغير مستقبلك بالفعل.",
        "لا تستهن أبدًا بمدى ما يمكن أن يأخذك الاتساق.",
        "تصميمك يفوق أي انتكاسات مؤقتة.",
        "المسار الصحيح ليس دائمًا الأسهل، لكنه دائمًا يستحق المتابعة.",
        "شجاعتك للبدء تلهم الآخرين للقيام بالمثل.",
        "في كل مرة تختار فيها النمو على الراحة، فإنك توسع إمكاناتك.",
        "أعلى إمكاناتك تنتظرك مباشرة خارج منطقة راحتك.",
        "كل تحدٍ تواجهه يعدك لشيء أعظم."
      ];
      
     const professionMotivations = {
    "موسيقي": [
        "موهبتك الموسيقية تجلب الانسجام إلى عالم فوضوي.",
        "كل نغمة تعزفها تلامس روح شخص ما.",
        "ألحانك لديها القدرة على الشفاء والتغيير.",
        "تعبيرك الفني يتحدث عن حقائق كونية.",
        "الموسيقى التي بداخلك تستحق أن تُسمع."
    ],
    "رابر": [
        "كلماتك ترسم قصصًا قوية تحتاج إلى أن تُروى.",
        "تدفقك وإيقاعك يلتقطان مشاعر لا تستطيع الكلمات وحدها التعبير عنها.",
        "أبياتك تمنح صوتًا لتجارب يشعر بها الكثيرون ولكن لا يستطيعون التعبير عنها.",
        "صوتك الأصيل يتردد مع الباحثين عن الحقيقة.",
        "مهارتك الشعرية تفتح العقول والقلوب."
    ],
    "لاعب كرة قدم": [
        "تفانيك في الملعب يلهم العمل الجماعي خارج الملعب.",
        "انضباطك الرياضي ينعكس على جميع مجالات الحياة.",
        "تفكيرك الاستراتيجي في اللعب يظهر قيادتك الطبيعية.",
        "شغفك باللعبة الجميلة يرفع من معنويات من حولك.",
        "روحك الرياضية تضع المعيار للآخرين ليتبعوه."
    ],
    "لاعب كرة سلة": [
        "رؤيتك للعبة تترجم إلى رؤية الفرص في الحياة.",
        "قدرتك على الأداء تحت الضغط تخدمك في كل تحدٍ.",
        "عقليتك الجماعية تُنشئ نجاحًا في جميع علاقاتك.",
        "قفزتك العمودية تُضاهي طموحك للوصول إلى آفاق جديدة.",
        "جهودك في الدفاع تُظهر التزامك بالتميز."
    ],
    "ملاكم": [
        "قوتك الذهنية رائعة مثل قوتك البدنية.",
        "انضباطك في التدريب يعكس شخصيتك في الحياة.",
        "قدرتك على تلقي الضربات والمضي قدمًا هي قوتك الخارقة.",
        "حركتك في الحلبة تعكس قدرتك على تجاوز تحديات الحياة.",
        "روحك القتالية لا تتراجع أمام أي تحدٍ جدير."
    ],
    "طالب": [
        "فضولك يفتح أبوابًا لإمكانيات لا نهائية.",
        "التزامك بالتعلم سيخدمك طوال حياتك.",
        "منظورك الجديد يجلب أفكارًا جديدة لمشاكل قديمة.",
        "رحلتك التعليمية تُعدك لفرص لم تُرَ بعد.",
        "انضباطك الأكاديمي يبني عادات للنجاح مدى الحياة."
    ],
    "معلم": [
        "تأثيرك يمتد إلى ما هو أبعد من الفصل الدراسي.",
        "صبرك يغذي إمكانيات قد يغفلها الآخرون.",
        "إرشادك يشكل مستقبلات بطرق قد لا تراها أبدًا بالكامل.",
        "حكمتك تزرع بذورًا ستزهر لأجيال.",
        "تفانيك للمعرفة يُحدث موجات من التغيير الإيجابي."
    ],
    "تيكتوكر": [
        "محتواك الإبداعي يجلب الفرح والاتصال في عالم رقمي.",
        "صوتك الأصيل يصل إلى من يحتاجون إلى رسالتك.",
        "قدرتك على التواصل بإيجاز مهارة نادرة وقيمة.",
        "تأثيرك الثقافي يمكن أن يُوجّه نحو تغيير إيجابي.",
        "حضورك الرقمي له تأثير في العالم الحقيقي."
    ],
    "رائد أعمال": [
        "رؤيتك تخلق فرصًا حيث يرى الآخرون العقبات.",
        "قدرتك على اتخاذ المخاطر المحسوبة تميزك.",
        "تفكيرك الإبداعي يحل المشكلات من جذورها.",
        "قيادتك تُلهم الآخرين للانضمام إلى مهمتك.",
        "إصرارك أمام التحديات يُحدد نجاحك."
    ],
    "طبيب": [
        "يداك الشافيتان تُقدمان العزاء في لحظات الضيق.",
        "التزامك بالرعاية الصحية يُغير الحياة كل يوم.",
        "معرفتك الطبية مقرونة بالتعاطف تُحدث شفاءً حقيقيًا.",
        "تفانيك في رعاية المرضى يمثل أسمى المهن.",
        "قدراتك التشخيصية تُضاهي قلبك الرحيم."
    ],
    "مهندس": [
        "قدراتك على حل المشكلات تخلق حلولًا تُحسن الحياة.",
        "خبرتك التقنية تُبني أسسًا للمستقبل.",
        "عقلك التحليلي يرى أنماطًا يغفلها الآخرون.",
        "دقتك واهتمامك بالتفاصيل يضمنان الجودة في كل ما تبتكره.",
        "نهجك الإبداعي للتحديات يُطور مجالك بالكامل."
    ],
    "مطور برمجيات": [
        "رمزك البرمجي يخلق إمكانيات لم تكن موجودة من قبل.",
        "حلولك التقنية تُعالج مشكلات إنسانية حقيقية.",
        "تفكيرك المنطقي يمتزج بشكل جميل مع الابتكار الإبداعي.",
        "إبداعاتك الرقمية تؤثر في عدد لا يحصى من الأرواح يوميًا.",
        "قدرتك على تعلم تقنيات جديدة تُبقيك في المقدمة."
    ],
    // باقي الترجمات...
};

const monthTraits = [
    "مولدك في يناير يمنحك صفات القيادة الطبيعية والتركيز الحازم.",
    "مولدك في فبراير يباركك بفهم بديهي ورؤية إنسانية.",
    "مولدك في مارس يمنحك إبداعًا خياليًا ومرونة قابلة للتكيف.",
    "مولدك في أبريل يزودك بإصرار حازم ومبادرة شجاعة.",
    "مولدك في مايو يمنحك مهارات تواصل مقنعة وحساسية عملية.",
    "مولدك في يونيو يقدم لك تنوعًا قابلاً للتكيف وذكاءً عاطفيًا.",
    "مولدك في يوليو يمنحك تعاطفًا رحيمًا وحماية مغذية.",
    "مولدك في أغسطس يباركك بكاريزما مغناطيسية وثقة كريمة.",
    "مولدك في سبتمبر يمنحك دقة تحليلية وتنظيمًا منهجيًا.",
    "مولدك في أكتوبر يزودك بمنظور متوازن وتناغم دبلوماسي.",
    "مولدك في نوفمبر يمنحك بصيرة نافذة وشدة تحويلية.",
    "مولدك في ديسمبر يقدم لك تفاؤلًا رؤيويًا وحكمة فلسفية."
];

      
      let selectedTrait;
      
      if (profession && professionMotivations[profession] && Math.random() < 0.25) {
        const profMotivations = professionMotivations[profession];
        selectedTrait = profMotivations[Math.floor(Math.random() * profMotivations.length)];
      } 
      else if (dob && Math.random() < 0.2) {
        selectedTrait = monthTraits[month];
      }
      else {
        selectedTrait = lifeTraits[Math.floor(Math.random() * lifeTraits.length)];
      }
      
      const encourageIndex = Math.floor(Math.random() * lifeEncouragements.length);
      
      return selectedTrait + " " + lifeEncouragements[encourageIndex];
    }

    function generateFlowerCode() {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let code = '';
      for (let i = 0; i < 8; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        code += characters.charAt(randomIndex);
      }
      return code;
    }

    function getRandomSubject() {
      let availableSubjects = Object.keys(subjectDictionary).filter(subject => !seenSubjects.includes(subject));
      
      if (availableSubjects.length === 0) {
        seenSubjects = [];
        availableSubjects = Object.keys(subjectDictionary);
      }
      
      const randomIndex = Math.floor(Math.random() * availableSubjects.length);
      const selectedSubject = availableSubjects[randomIndex];
      
      seenSubjects.push(selectedSubject);
      
      return selectedSubject;
    }

    async function updateFlowerDisplay() {
      const flowerCodeElement = document.getElementById('flowerCodeDisplay');
      const motivationElement = document.getElementById('monthlyMotivation');
      
      if (!flowerCodeElement || !motivationElement) {
        console.error("Elementos requeridos no encontrados en el DOM");
        return;
      }
      
      let subject = localStorage.getItem('flowerSubject');
      if (!subject) {
        subject = getRandomSubject();
        localStorage.setItem('flowerSubject', subject);
      }
      
      const formattedName = formatUserName(userFullName);
      
      if (formattedName) {
        flowerCodeElement.innerHTML = `زهرتي - ${subject} / ${formattedName} ${userEmoji}`;
      } else {
        flowerCodeElement.textContent = "زهرتي - " + subject;
      }
      
      if (!currentMotivation) {
        currentMotivation = generatePersonalizedMotivation(userFlowerCode, userProfession, userDateOfBirth);
      }
      
      motivationElement.textContent = currentMotivation;
      
      const captureCode = document.getElementById('captureFlowerCode');
      const captureMotivation = document.getElementById('captureFlowerMotivation');
      
      if (captureCode) {
        if (formattedName) {
          captureCode.innerHTML = `زهرتي - ${subject} / ${formattedName} ${userEmoji}`;
        } else {
          captureCode.textContent = "زهرتي - " + subject;
        }
      }
      
      if (captureMotivation) captureMotivation.textContent = currentMotivation;
      
      return currentMotivation;
    }

    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function removeCookie(name) {
      document.cookie = name + "=; Max-Age=-99999999; path=/";
    }

    function setTheme(theme) {
      document.body.classList.remove('theme-default', 'theme-red-black', 'theme-green-blue', 'theme-orange-pink', 'theme-yellow-purple');
      
      document.body.classList.add('theme-' + theme);
      
      currentTheme = theme;
      
      localStorage.setItem('preferredTheme', theme);
      setCookie('preferredTheme', theme, 365);
      
      const options = document.querySelectorAll('.style-option');
      options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === theme) {
          option.classList.add('selected');
        }
      });
      
      updateCaptureStyles(theme);
    }
    
    function updateCaptureStyles(theme) {
      const captureContainer = document.getElementById('flowerCaptureContainer');
      const captureCode = document.getElementById('captureFlowerCode');
      const captureHeader = document.getElementById('captureFlowerHeader');
      const captureWebsiteUrl = document.querySelector('.capture-website-url');
      const captureLogo = document.querySelector('.gz-logo');
      const captureMotivation = document.getElementById('captureFlowerMotivation');
      
      if (!captureContainer || !captureCode || !captureHeader || !captureWebsiteUrl || 
          !captureLogo || !captureMotivation) {
        console.error("Uno o más elementos de captura no encontrados");
        return;
      }
      
      captureContainer.style.borderColor = '';
      captureCode.style.borderColor = '';
      captureCode.style.color = '';
      captureCode.style.backgroundColor = '';
      captureHeader.style.color = '';
      captureWebsiteUrl.style.color = '';
      captureLogo.style.color = '';
      captureLogo.style.borderColor = '';
      captureMotivation.style.color = '';
      captureMotivation.style.backgroundColor = '';
      captureMotivation.style.borderColor = '';
      
      switch(theme) {
        case 'red-black':
          captureContainer.style.borderColor = '#8B0000';
          captureContainer.style.backgroundColor = 'black';
          captureCode.style.borderColor = '#FF4500';
          captureCode.style.color = '#FF4500';
          captureCode.style.backgroundColor = 'black';
          captureHeader.style.color = '#FF4500';
          captureWebsiteUrl.style.color = '#FF4500';
          captureLogo.style.color = '#FF4500';
          captureLogo.style.borderColor = '#FF4500';
          captureMotivation.style.color = '#E5E5E5';
          captureMotivation.style.backgroundColor = 'black';
          captureMotivation.style.borderColor = '#FF4500';
          break;
          
        case 'green-blue':
          captureContainer.style.borderColor = '#3EB489';
          captureContainer.style.backgroundColor = '#1A2E4D';
          captureCode.style.borderColor = '#3EB489';
          captureCode.style.color = '#3EB489';
          captureCode.style.backgroundColor = '#36454F';
          captureHeader.style.color = '#3EB489';
          captureWebsiteUrl.style.color = '#3EB489';
          captureLogo.style.color = '#3EB489';
          captureLogo.style.borderColor = '#3EB489';
          captureMotivation.style.color = '#F5F5F5';
          captureMotivation.style.backgroundColor = '#1A2E4D';
          captureMotivation.style.borderColor = '#3EB489';
          break;
          
        case 'orange-pink':
          captureContainer.style.borderColor = '#FF7F50';
          captureContainer.style.backgroundColor = '#4B0082';
          captureCode.style.borderColor = '#FF7F50';
          captureCode.style.color = '#FF7F50';
          captureCode.style.backgroundColor = '#6A0DAD';
          captureHeader.style.color = '#FF7F50';
          captureWebsiteUrl.style.color = '#FF7F50';
          captureLogo.style.color = '#FF7F50';
          captureLogo.style.borderColor = '#FF7F50';
          captureMotivation.style.color = '#FFFFFF';
          captureMotivation.style.backgroundColor = '#4B0082';
          captureMotivation.style.borderColor = '#FF7F50';
          break;
          
        case 'yellow-purple':
          captureContainer.style.borderColor = '#FFD700';
          captureContainer.style.backgroundColor = '#4B0082';
          captureCode.style.borderColor = '#FFD700';
          captureCode.style.color = '#FFD700';
          captureCode.style.backgroundColor = '#6A0DAD';
          captureHeader.style.color = '#FFD700';
          captureWebsiteUrl.style.color = '#FFD700';
          captureLogo.style.color = '#FFD700';
          captureLogo.style.borderColor = '#FFD700';
          captureMotivation.style.color = '#FFFFFF';
          captureMotivation.style.backgroundColor = '#4B0082';
          captureMotivation.style.borderColor = '#FFD700';
          break;
          
        default:
          captureContainer.style.borderColor = '#007bff';
          captureContainer.style.backgroundColor = 'white';
          captureCode.style.borderColor = '#ff69b4';
          captureCode.style.color = '#ff69b4';
          captureCode.style.backgroundColor = '#fff0f8';
          captureHeader.style.color = '#007bff';
          captureWebsiteUrl.style.color = '#007bff';
          captureLogo.style.color = '#007bff';
          captureLogo.style.borderColor = '#007bff';
          captureMotivation.style.color = '#333';
          captureMotivation.style.backgroundColor = 'white';
          captureMotivation.style.borderColor = '#ff69b4';
      }
    }

    function authenticateAnonymously() {
      return new Promise((resolve, reject) => {
        auth.signInAnonymously()
          .then((userCredential) => {
            console.log("Usuario autenticado anónimamente:", userCredential.user.uid);
            userUid = userCredential.user.uid;
            isAuthenticated = true;
            resolve(userCredential.user);
          })
          .catch((error) => {
            console.error("Error de autenticación:", error);
            reject(error);
          });
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        userUid = user.uid;
        isAuthenticated = true;
        console.log("Estado de autenticación cambiado: usuario ha iniciado sesión", user.uid);
      } else {
        isAuthenticated = false;
        console.log("Estado de autenticación cambiado: usuario ha cerrado sesión");
      }
    });

    async function submitToFirebase() {
      try {
        if (!isAuthenticated) {
          console.log("Usuario no autenticado, autenticando ahora...");
          await authenticateAnonymously();
        }
        
        const location = await detectUserLocation();
        
        await getUserRankAndEmoji();
        
        const userData = {
          date: new Date().toISOString(),
          country: location.country || "Desconocido",
          city: location.city || "Desconocido",
          uid: userUid,
          uniqueId: userUniqueId,
          flowerCode: userFlowerCode,
          motivation: currentMotivation,
          dateOfBirth: userDateOfBirth,
          profession: userProfession,
          fullName: userFullName,
          formattedName: formatUserName(userFullName),
          timestamp: Date.now(),
          theme: currentTheme,
          subject: localStorage.getItem('flowerSubject') || getRandomSubject(),
          shareCount: shareCount,
          rank: userRank,
          emoji: userEmoji
        };

        console.log("Enviando datos a Firebase:", userData);
        
        try {
          const newEntryRef = database.ref('birthdates').push(userData);
          console.log("Datos enviados a la Base de Datos en Tiempo Real:", newEntryRef.key);
        } catch (dbError) {
          console.error("Error con la Base de Datos en Tiempo Real:", dbError);
        }
        
        try {
          const docRef = await firestore.collection('flowers').add(userData);
          console.log("Documento escrito en Firestore con ID: ", docRef.id);
        } catch (firestoreError) {
          console.error("Error añadiendo documento a Firestore: ", firestoreError);
        }
        
        try {
          await firestore.collection('flowerCodes').doc(userUniqueId).set({
            ...userData,
            createdAt: new Date()
          });
          console.log("Código floral añadido a colección específica");
        } catch (codeError) {
          console.error("Error añadiendo código floral a colección: ", codeError);
        }
        
        localStorage.setItem('userFlowerData', JSON.stringify(userData));
        localStorage.setItem('isInstalled', 'true');
        setCookie('userUniqueId', userUniqueId, 365);
        setCookie('userFlowerCode', userFlowerCode, 365);
        setCookie('userDateOfBirth', userDateOfBirth, 365);
        setCookie('userProfession', userProfession, 365);
        setCookie('userFullName', userFullName, 365);
        setCookie('userEmoji', userEmoji, 365);
        setCookie('userRank', userRank.toString(), 365);
        setCookie('isInstalled', 'true', 365);
        isInstalled = true;
        
        return true;
      } catch (error) {
        console.error("Error de envío a Firebase:", error);
        await getUserRankAndEmoji();
        
        const userData = {
          date: new Date().toISOString(),
          uniqueId: userUniqueId,
          flowerCode: userFlowerCode,
          motivation: currentMotivation,
          dateOfBirth: userDateOfBirth,
          profession: userProfession,
          fullName: userFullName,
          formattedName: formatUserName(userFullName),
          timestamp: Date.now(),
          theme: currentTheme,
          subject: localStorage.getItem('flowerSubject') || getRandomSubject(),
          shareCount: 0,
          rank: userRank,
          emoji: userEmoji
        };
        
        localStorage.setItem('userFlowerData', JSON.stringify(userData));
        localStorage.setItem('isInstalled', 'true');
        setCookie('userUniqueId', userUniqueId, 365);
        setCookie('userFlowerCode', userFlowerCode, 365);
        setCookie('userDateOfBirth', userDateOfBirth, 365);
        setCookie('userProfession', userProfession, 365);
        setCookie('userFullName', userFullName, 365);
        setCookie('userEmoji', userEmoji, 365);
        setCookie('userRank', userRank.toString(), 365);
        setCookie('isInstalled', 'true', 365);
        isInstalled = true;
        
        return true;
      }
    }

    async function updateShareCount() {
      if (!isAuthenticated || !userUniqueId) return;
      
      try {
        shareCount++;
        
        const savedData = localStorage.getItem('userFlowerData');
        if (savedData) {
          const userData = JSON.parse(savedData);
          userData.shareCount = shareCount;
          localStorage.setItem('userFlowerData', JSON.stringify(userData));
        }
        
        await firestore.collection('flowerCodes').doc(userUniqueId).set({
          shareCount: shareCount,
          lastShared: new Date().toISOString(),
          country: currentCountry || "Desconocido",
          city: userCity || "Desconocido",
          uid: userUid,
          uniqueId: userUniqueId
        }, { merge: true });
        
        console.log("Contador de compartidos actualizado:", shareCount);
      } catch (error) {
        console.error("Error actualizando contador de compartidos:", error);
      }
    }

    function checkSavedUserData() {
      const cookieUniqueId = getCookie('userUniqueId');
      const cookieFlowerCode = getCookie('userFlowerCode');
      const cookieInstalled = getCookie('isInstalled');
      const cookieDOB = getCookie('userDateOfBirth');
      const cookieProfession = getCookie('userProfession');
      const cookieFullName = getCookie('userFullName');
      const cookieEmoji = getCookie('userEmoji');
      const cookieRank = getCookie('userRank');
      
      if (cookieUniqueId && cookieFlowerCode) {
        userUniqueId = cookieUniqueId;
        userFlowerCode = cookieFlowerCode;
        userDateOfBirth = cookieDOB || null;
        userProfession = cookieProfession || null;
        userFullName = cookieFullName || null;
        userEmoji = cookieEmoji || "👑";
        userRank = cookieRank ? parseInt(cookieRank) : 0;
        isInstalled = cookieInstalled === 'true';
        
        currentMotivation = generatePersonalizedMotivation(userFlowerCode, userProfession, userDateOfBirth);
        
        console.log("Datos de usuario guardados encontrados en cookies:", { userUniqueId, userFlowerCode, userDateOfBirth, userProfession, userFullName, userEmoji, userRank });
        return true;
      }
      
      const savedData = localStorage.getItem('userFlowerData');
      if (savedData) {
        try {
          const userData = JSON.parse(savedData);
          userUniqueId = userData.uniqueId;
          userFlowerCode = userData.flowerCode;
          userDateOfBirth = userData.dateOfBirth || null;
          userProfession = userData.profession || null;
          userFullName = userData.fullName || null;
          shareCount = userData.shareCount || 0;
          userEmoji = userData.emoji || "👑";
          userRank = userData.rank || 0;
          currentMotivation = userData.motivation || generatePersonalizedMotivation(userData.flowerCode, userData.profession, userData.dateOfBirth);
          userUid = userData.uid;
          isInstalled = localStorage.getItem('isInstalled') === 'true';
          
          setCookie('userUniqueId', userUniqueId, 365);
          setCookie('userFlowerCode', userFlowerCode, 365);
          setCookie('userDateOfBirth', userDateOfBirth, 365);
          setCookie('userProfession', userProfession, 365);
          setCookie('userFullName', userFullName, 365);
          setCookie('userEmoji', userEmoji, 365);
          setCookie('userRank', userRank.toString(), 365);
          setCookie('isInstalled', 'true', 365);
          
          console.log("Datos de usuario guardados encontrados en localStorage:", userData);
          return true;
        } catch (e) {
          console.error("Error al analizar datos de usuario guardados:", e);
          return false;
        }
      }
      return false;
    }

    async function deleteUserAccount() {
      if (!userUniqueId) return false;
      
      try {
        if (!confirm("¿Estás seguro de que quieres eliminar TODOS tus datos? Esta acción es irreversible.")) {
          return false;
        }
        
        console.log("Eliminando cuenta de usuario:", userUniqueId);
        
        try {
          await firestore.collection('flowerCodes').doc(userUniqueId).delete();
          console.log("Datos eliminados de la colección flowerCodes");
        } catch (error) {
          console.error("Error al eliminar flowerCodes:", error);
        }
        
        try {
          const flowersQuery = await firestore.collection('flowers').where('uniqueId', '==', userUniqueId).get();
          
          const batch = firestore.batch();
          let count = 0;
          
          flowersQuery.forEach((doc) => {
            batch.delete(doc.ref);
            count++;
          });
          
          if (count > 0) {
            await batch.commit();
            console.log(`${count} documentos eliminados de la colección flowers`);
          }
        } catch (error) {
          console.error("Error al eliminar flowers:", error);
        }
        
        try {
          const birthdatesRef = database.ref('birthdates');
          const query = birthdatesRef.orderByChild('uniqueId').equalTo(userUniqueId);
          
          query.once('value', (snapshot) => {
            snapshot.forEach((childSnapshot) => {
              birthdatesRef.child(childSnapshot.key).remove();
            });
          });
          
          console.log("Datos eliminados de la base de datos en tiempo real");
        } catch (error) {
          console.error("Error al eliminar la base de datos en tiempo real:", error);
        }
        
        localStorage.removeItem('userFlowerData');
        localStorage.removeItem('isInstalled');
        localStorage.removeItem('flowerSubject');
        localStorage.removeItem('preferredTheme');
        
        removeCookie('userUniqueId');
        removeCookie('userFlowerCode');
        removeCookie('isInstalled');
        removeCookie('userDateOfBirth');
        removeCookie('userProfession');
        removeCookie('userFullName');
        removeCookie('userEmoji');
        removeCookie('userRank');
        removeCookie('preferredTheme');
        
        userUniqueId = null;
        userFlowerCode = null;
        currentMotivation = null;
        userDateOfBirth = null;
        userProfession = null;
        userFullName = null;
        userEmoji = null;
        userRank = null;
        isInstalled = false;
        seenSubjects = [];
        shareCount = 0;
        
        try {
          if (auth.currentUser) {
            await auth.currentUser.delete();
            console.log("Usuario Firebase eliminado");
          }
        } catch (authError) {
          console.error("Error al eliminar la autenticación:", authError);
        }
        
        console.log("Cuenta de usuario completamente eliminada");
        return true;
      } catch (error) {
        console.error("Error al eliminar la cuenta:", error);
        return false;
      }
    }

    window.addEventListener('load', async () => {
      const today = new Date();
      const twoYearsAgo = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
      document.getElementById('dobInput').max = twoYearsAgo.toISOString().split('T')[0];
      
      const savedTheme = localStorage.getItem('preferredTheme') || getCookie('preferredTheme');
      if (savedTheme) {
        setTheme(savedTheme);
      } else {
        setTheme('green-blue');
      }
      
      if (checkSavedUserData()) {
        console.log("El usuario ya tiene datos, ocultando modal de bienvenida");
        const welcomeToast = document.getElementById('welcomeToast');
        welcomeToast.style.display = 'block';
        setTimeout(() => {
          welcomeToast.style.opacity = '1';
        }, 100);
        setTimeout(() => {
          welcomeToast.style.opacity = '0';
          setTimeout(() => {
            welcomeToast.style.display = 'none';
          }, 500);
        }, 2000);
        
        if (!isAuthenticated) {
          try {
            await authenticateAnonymously();
          } catch (error) {
            console.error("Error durante la autenticación:", error);
          }
        }
      } else {
        console.log("No se encontraron datos de usuario guardados, mostrando modal de bienvenida");
        const welcomeModal = document.getElementById('welcomeModal');
        welcomeModal.style.display = 'block';
        setTimeout(() => {
          welcomeModal.classList.add('show');
        }, 100);
      }
      
      setupProfessionDropdown();
    });

    function setupProfessionDropdown() {
      const professionInput = document.getElementById('professionInput');
      const professionDropdown = document.getElementById('professionDropdown');
      
      if (!professionInput || !professionDropdown) {
        console.error("Elementos del menú desplegable de profesiones no encontrados");
        return;
      }
      
      function filterProfessions(input) {
        if (!input) return [];
        
        input = input.toLowerCase();
        return professions.filter(profession => 
          profession.toLowerCase().includes(input)
        );
      }
      
      function renderDropdownOptions(filteredProfessions) {
        professionDropdown.innerHTML = '';
        
        if (filteredProfessions.length === 0) {
          const option = document.createElement('div');
          option.className = 'profession-option';
          option.textContent = 'No se encontraron coincidencias';
          professionDropdown.appendChild(option);
        } else {
          filteredProfessions.forEach(profession => {
            const option = document.createElement('div');
            option.className = 'profession-option';
            option.textContent = profession;
            option.addEventListener('click', () => {
              professionInput.value = profession;
              professionDropdown.style.display = 'none';
            });
            professionDropdown.appendChild(option);
          });
        }
      }
      
      professionInput.addEventListener('input', () => {
        const filtered = filterProfessions(professionInput.value);
        renderDropdownOptions(filtered);
        
        if (filtered.length > 0) {
          professionDropdown.style.display = 'block';
        } else {
          professionDropdown.style.display = 'none';
        }
      });
      
      professionInput.addEventListener('focus', () => {
        if (professionInput.value) {
          const filtered = filterProfessions(professionInput.value);
          renderDropdownOptions(filtered);
          professionDropdown.style.display = 'block';
        }
      });
      
      document.addEventListener('click', (e) => {
        if (!professionInput.contains(e.target) && !professionDropdown.contains(e.target)) {
          professionDropdown.style.display = 'none';
        }
      });
    }

    document.getElementById('flowerButton').addEventListener('click', function() {
      if (!userUniqueId) {
        alert("Por favor crea tu cuenta de flor primero.");
        return;
      }
      
      updateFlowerDisplay();
      const flowerModal = document.getElementById('flowerModal');
      flowerModal.style.display = 'block';
      setTimeout(() => {
        flowerModal.classList.add('show');
      }, 10);
      document.getElementById('shareFlowerButton').style.display = 'flex';
    });

    document.getElementById('shareFlowerButton').addEventListener('click', function() {
      captureFlower();
    });
    
    document.getElementById('showIdButton').addEventListener('click', function() {
      if (userUniqueId) {
        document.getElementById('userIdDisplay').textContent = userUniqueId;
        const idModal = document.getElementById('idModal');
        idModal.style.display = 'block';
        setTimeout(() => {
          idModal.classList.add('show');
        }, 10);
      } else {
        alert("Por favor crea tu cuenta de flor primero para obtener tu ID único.");
      }
    });
    
    document.getElementById('copyIdButton').addEventListener('click', function() {
      const idText = document.getElementById('userIdDisplay').textContent;
      navigator.clipboard.writeText(idText).then(function() {
        alert('ID copiado al portapapeles!');
      }).catch(function() {
        alert('No se pudo copiar el ID. Por favor selecciona y copia manualmente.');
      });
    });
    
    document.getElementById('closeIdModal').addEventListener('click', function() {
      const idModal = document.getElementById('idModal');
      idModal.classList.remove('show');
      setTimeout(() => {
        idModal.style.display = 'none';
      }, 300);
    });
    
    document.getElementById('deleteAccountButton').addEventListener('click', function() {
      deleteUserAccount().then(success => {
        if (success) {
          alert("Cuenta eliminada con éxito. Deberás crear una nueva cuenta para usar esta aplicación.");
          const idModal = document.getElementById('idModal');
          idModal.classList.remove('show');
          setTimeout(() => {
            idModal.style.display = 'none';
            const welcomeModal = document.getElementById('welcomeModal');
            welcomeModal.style.display = 'block';
            setTimeout(() => {
              welcomeModal.classList.add('show');
            }, 100);
          }, 300);
        } else {
          alert("Error, intenta más tarde");
        }
      });
    });
    
    document.getElementById('refreshMotivation').addEventListener('click', function() {
      const newMotivation = generatePersonalizedMotivation(userFlowerCode, userProfession, userDateOfBirth);
      currentMotivation = newMotivation;
      
      const newSubject = getRandomSubject();
      localStorage.setItem('flowerSubject', newSubject);
      
      const formattedName = formatUserName(userFullName);
      
      const flowerCodeElement = document.getElementById('flowerCodeDisplay');
      if (formattedName) {
        flowerCodeElement.innerHTML = `زهرتي - ${newSubject} / ${formattedName} ${userEmoji}`;
      } else {
        flowerCodeElement.textContent = "زهرتي - " + newSubject;
      }
      
      document.getElementById('monthlyMotivation').textContent = newMotivation;
      
      const captureCode = document.getElementById('captureFlowerCode');
      const captureMotivation = document.getElementById('captureFlowerMotivation');
      
      if (captureCode) {
        if (formattedName) {
          captureCode.innerHTML = `زهرتي - ${newSubject} / ${formattedName} ${userEmoji}`;
        } else {
          captureCode.textContent = "زهرتي - " + newSubject;
        }
      }
      
      if (captureMotivation) captureMotivation.textContent = newMotivation;
      
      this
.style.transition = 'transform 0.5s ease';
      this.style.transform = 'rotate(360deg)';
      
      setTimeout(() => {
        this.style.transition = 'none';
        this.style.transform = 'rotate(0deg)';
      }, 500);
    });
    
    document.getElementById('createAccountButton').addEventListener('click', async function() {
      const dobInput = document.getElementById('dobInput');
      const professionInput = document.getElementById('professionInput');
      const fullNameInput = document.getElementById('fullNameInput');
      
      if (!fullNameInput.value) {
        alert("Please enter your full name.");
        return;
      }
      
      if (!dobInput.value) {
        alert("Please enter your date of birth.");
        return;
      }
      
      if (!professionInput.value) {
        alert("Please enter your profession.");
        return;
      }
      
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('createAccountButton').disabled = true;
      
      try {
        await authenticateAnonymously();
        
        userFullName = fullNameInput.value;
        userDateOfBirth = dobInput.value;
        userProfession = professionInput.value;
        
        userUniqueId = generateUniqueId();
        console.log("Generated unique ID:", userUniqueId);
        
        userFlowerCode = generateFlowerCode();
        
        userEmoji = await getUserRankAndEmoji();
        
        const subject = getRandomSubject();
        localStorage.setItem('flowerSubject', subject);
        
        currentMotivation = generatePersonalizedMotivation(userFlowerCode, userProfession, userDateOfBirth);
        
        const createButton = document.getElementById('createAccountButton');
        createButton.innerHTML = '<i class="fas fa-check"></i> Done';
        createButton.style.backgroundColor = '#4CAF50';
        
        const userData = {
          date: new Date().toISOString(),
          uid: userUid,
          uniqueId: userUniqueId,
          flowerCode: userFlowerCode,
          motivation: currentMotivation,
          dateOfBirth: userDateOfBirth,
          profession: userProfession,
          fullName: userFullName,
          formattedName: formatUserName(userFullName),
          timestamp: Date.now(),
          theme: currentTheme,
          subject: subject,
          shareCount: 0,
          rank: userRank,
          emoji: userEmoji
        };
        
        localStorage.setItem('userFlowerData', JSON.stringify(userData));
        localStorage.setItem('isInstalled', 'true');
        setCookie('userUniqueId', userUniqueId, 365);
        setCookie('userFlowerCode', userFlowerCode, 365);
        setCookie('userDateOfBirth', userDateOfBirth, 365);
        setCookie('userProfession', userProfession, 365);
        setCookie('userFullName', userFullName, 365);
        setCookie('userEmoji', userEmoji, 365);
        setCookie('userRank', userRank.toString(), 365);
        setCookie('isInstalled', 'true', 365);
        isInstalled = true;
        
        setTimeout(() => {
          const welcomeModal = document.getElementById('welcomeModal');
          welcomeModal.classList.remove('show');
          
          setTimeout(() => {
            welcomeModal.style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'none';
            createButton.innerHTML = 'Create Account';
            createButton.style.backgroundColor = '';
            createButton.disabled = false;
            
            submitToFirebase().then(submitted => {
              console.log("Firebase submission result:", submitted);
              
              const welcomeToast = document.getElementById('welcomeToast');
              welcomeToast.style.display = 'block';
              setTimeout(() => {
                welcomeToast.style.opacity = '1';
              }, 100);
              setTimeout(() => {
                welcomeToast.style.opacity = '0';
                setTimeout(() => {
                  welcomeToast.style.display = 'none';
                }, 500);
              }, 2000);
              
              updateFlowerDisplay();
              const flowerModal = document.getElementById('flowerModal');
              flowerModal.style.display = 'block';
              setTimeout(() => {
                flowerModal.classList.add('show');
              }, 10);
              document.getElementById('shareFlowerButton').style.display = 'flex';
            });
          }, 300);
        }, 2000);
        
        console.log("Setup complete and data stored locally and in cookies");
      } catch (error) {
        console.error("Error during setup:", error);
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('createAccountButton').disabled = false;
        alert("There was a problem setting up your flower. Please try again.");
      }
    });
    
    async function captureFlower() {
      try {
        const captureContainer = document.getElementById('flowerCaptureContainer');
        
        updateCaptureStyles(currentTheme);
        
        if (typeof html2canvas !== 'function') {
          console.error("html2canvas not loaded or not available as a function");
          alert("Cannot capture flower. The capture library is not loaded.");
          return;
        }
        
        let bgColor = 'white';
        if (currentTheme === 'red-black') bgColor = 'black';
        else if (currentTheme === 'green-blue') bgColor = '#1A2E4D';
        else if (currentTheme === 'orange-pink' || currentTheme === 'yellow-purple') bgColor = '#4B0082';
        
        const canvas = await html2canvas(captureContainer, {
          backgroundColor: bgColor,
          scale: 7,
          logging: true,
          useCORS: true,
          allowTaint: true,
          letterRendering: true
        });
        
        const imageUrl = canvas.toDataURL('image/png');
        
        const capturedImage = document.getElementById('capturedImage');
        if (capturedImage) {
          capturedImage.src = imageUrl;
          document.getElementById('capturedFlower').style.display = 'flex';
          document.getElementById('shareWarning').style.display = 'block';
          
          updateShareCount();
        } else {
          console.error("capturedImage element not found");
        }
      } catch (error) {
        console.error('Error capturing flower:', error);
        alert('Could not capture your flower. Please try again.');
      }
    }
    
    document.getElementById('shareCapture').addEventListener('click', function() {
      const imageUrl = document.getElementById('capturedImage').src;
      
      if (navigator.share) {
        fetch(imageUrl)
          .then(res => res.blob())
          .then(blob => {
            const file = new File([blob], 'my-gz-flower.png', { type: 'image/png' });
            navigator.share({
              title: 'My G-Z Flower',
              text: 'Discover yours at g-z.online',
              files: [file]
            }).catch(err => {
              console.log('Error sharing:', err);
              fallbackShare();
            });
          })
          .catch(err => {
            console.log('Error preparing image:', err);
            fallbackShare();
          });
      } else {
        fallbackShare();
      }
    });
    
    function fallbackShare() {
      try {
        const shareText = `
Check out my Flower of Life from G-Z: ${userUniqueId}. Discover yours at g-z.online`;
        
        navigator.clipboard.writeText(shareText).then(function() {
          alert('Share text copied to clipboard!');
        }).catch(function() {
          alert('Could not copy share text.');
        });
      } catch (error) {
        console.error('Fallback share error:', error);
        alert('An error occurred.');
      }
    }
    
    document.getElementById('closeCapture').addEventListener('click', function() {
      document.getElementById('capturedFlower').style.display = 'none';
    });
    
    document.getElementById('closeFlowerModal').addEventListener('click', function() {
      const flowerModal = document.getElementById('flowerModal');
      flowerModal.classList.remove('show');
      setTimeout(() => {
        flowerModal.style.display = 'none';
        document.getElementById('shareFlowerButton').style.display = 'none';
      }, 300);
    });

    window.onclick = function(event) {
      const flowerModal = document.getElementById('flowerModal');
      const capturedFlower = document.getElementById('capturedFlower');
      const idModal = document.getElementById('idModal');
      const welcomeModal = document.getElementById('welcomeModal');
      
      if (event.target == flowerModal) {
        flowerModal.classList.remove('show');
        setTimeout(() => {
          flowerModal.style.display = "none";
          document.getElementById('shareFlowerButton').style.display = 'none';
        }, 300);
      }
      
      if (event.target == capturedFlower) {
        capturedFlower.style.display = "none";
      }
      
      if (event.target == idModal) {
        idModal.classList.remove('show');
        setTimeout(() => {
          idModal.style.display = "none";
        }, 300);
      }
      
      if (event.target == welcomeModal && isInstalled) {
        welcomeModal.classList.remove('show');
        setTimeout(() => {
          welcomeModal.style.display = "none";
        }, 300);
      }
    };
    
    document.getElementById('shareFlowerButton').style.display = 'none';
    document.getElementById('shareWarning').style.display = 'none';
    
    document.querySelectorAll('.style-option').forEach(option => {
      option.addEventListener('click', function() {
        const theme = this.dataset.theme;
        setTheme(theme);
      });
    });
  </script>
</body>
</html>
