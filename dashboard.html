<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monetizelt</title>
    <link href="https://fonts.googleapis.com/css2?family=Billabong&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        header {
            background-color: #ffffff;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin: 0;
            font-size: 1.7em;
            font-family: 'Billabong', cursive;
            color: #007BFF;
            border: 2px solid #007BFF;
            padding: 3px;
            border-radius: 13px;
        }
        .slogan {
            text-align: center;
            margin: 10px 0 5px 0;
            font-size: 1.2em;
            color: #007BFF;
            padding: 10px;
            border: 1px solid #007BFF;
            border-radius: 20px;
            background-color: #e9f5ff;
        }
        .icon-container {
            display: flex;
            align-items: center;
        }
        .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 31px;
            height: 31px;
            border: 1px solid #007BFF; 
            border-radius: 11px;
            background-color: white;
            color: #007BFF;
            margin-left: 5px; 
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .icon:hover {
            background-color: #e9f5ff; 
        }
        .divider {
            height: 1px;
            background-color: #007BFF;
            width: 100%;
            margin: 0; 
        }
        .button-container {
            display: flex;
            justify-content: center;
            padding: 4px 0;
            overflow-x: auto;
            white-space: nowrap;
            margin: 0 0 5px 0;
            max-width: 100%;
        }
        .button-container a {
            margin: 0 5px;
            display: flex;
            align-items: center;
            text-decoration: none;
            flex-shrink: 0;
        }
        .button-container a i {
            margin-right: 5px;
        }
        .button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            text-align: center;
            min-width: 70px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .footer-button {
            margin-left: 10px;
        }
        a {
            text-decoration: none;
        }
        .year-select, .month-select {
            width: 100%;
            padding: 6px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 13px;
            background: white;
            border-top: 3px solid #007BFF;
        }
        .dashboard { 
            max-width: 800px; 
            margin: auto; 
            padding: 5px 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 5px;
        }
        .card {
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            text-decoration: none;
            color: inherit;
            border: 1px solid #007BFF;
            transition: background 0.3s, transform 0.2s;
            position: relative;
        }
        .small-card { height: 50px; }
        .card:hover {
            transform: translateY(-2px);
            background: #e9f5ff;
        }
        .title { color: #666; font-size: 0.7rem; margin-bottom: 5px; }
        .value { font-size: 1.3rem; font-weight: bold; color: #007BFF; }
        .value-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .trend-indicator {
            margin-left: 5px;
            font-size: 0.8rem;
        }
        .trend-up {
            color: #4CAF50;
        }
        .trend-down {
            color: #F44336;
        }
        .trend-neutral {
            color: #FFC107;
        }
        .history { 
            border-top: 3px solid #007BFF; 
            grid-column: 1/-1; 
            max-height: 200px;
            overflow-y: auto; 
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-radius: 10px;
            margin: 5px 0;
            background-color: #f0f8ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        .transaction-item:hover {
            background-color: #e6f7ff;
        }
        .history-item .details {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
        }
        .date { margin-left: 10px; color: #888; font-size: 0.9rem; }
        .no-transactions {
            font-size: 0.8em;
            color: #888;
            text-align: center;
            padding: 5px;
        }
        .payment-status {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 10px;
            color: white;
            z-index: 1;
        }
        
        .payment-status.not-active {
            background-color: #F44336;
        }
        
        .payment-status.active {
            background-color: #4CAF50;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px; /* Augmenté à 20px */
            width: 90%;
            max-width: 450px;
            padding: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .delete-button {
            background-color: #F44336;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .delete-button:hover {
            background-color: #ff3333;
        }
        
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .confirm-modal-content {
            background-color: white;
            border-radius: 20px; /* Augmenté à 20px */
            width: 280px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .modal-message {
            margin-bottom: 15px;
            color: #555;
            font-size: 0.9em;
        }
        
        .email-input,
        .password-input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        
        .confirm-delete {
            background-color: #F44336;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            cursor: pointer;
            flex: 1;
            font-weight: bold;
        }
        
        .cancel-delete {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            cursor: pointer;
            flex: 1;
        }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1005;
        }
        
        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            max-width: 300px;
        }
        
        .toast.success {
            background-color: #4CAF50;
        }
        
        .toast.error {
            background-color: #F44336;
        }
        
        .toast.info {
            background-color: #2196F3;
        }
        
        .toast-icon {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .payment-warning {
            color: #F44336;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                display: none;
            }
        }
        
        .create-product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .product-modal-content {
            background-color: white;
            border-radius: 20px; /* Augmenté à 20px */
            width: 90%;
            max-width: 450px;
            padding: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .product-modal-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #007BFF;
            text-align: center;
            border-bottom: 2px solid #e9f5ff;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 12px; /* Réduit de 15px à 12px */
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px; /* Réduit de 5px à 4px */
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        
        .form-control {
            width: 100%;
            padding: 8px; /* Réduit de 10px à 8px */
            border: 1px solid #007BFF;
            border-radius: 10px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #007BFF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .form-select {
            width: 100%;
            padding: 8px; /* Réduit de 10px à 8px */
            border: 1px solid #007BFF;
            border-radius: 10px;
            font-size: 0.9em;
            background-color: white;
            box-sizing: border-box;
        }
        
        .character-count {
            font-size: 0.8em;
            color: #888;
            text-align: right;
            margin-top: 5px;
        }
        
        .file-upload-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px; /* Réduit de 15px à 12px */
        }
        
        .file-upload-box {
            border: 2px dashed #007BFF;
            border-radius: 10px;
            padding: 12px; /* Réduit de 15px à 12px */
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 70px; /* Réduit de 80px à 70px */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .file-upload-box:hover {
            background-color: #e9f5ff;
        }
        
        .file-upload-icon {
            font-size: 20px; /* Réduit de 24px à 20px */
            color: #007BFF;
            margin-bottom: 5px;
        }
        
        .file-upload-text {
            font-size: 0.8em;
            color: #555;
        }
        
        .file-upload-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-name {
            font-size: 0.8em;
            color: #4CAF50;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: none;
        }
        
        .create-product-button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px; /* Réduit de 12px à 10px */
            font-size: 0.95em; /* Réduit de 1em à 0.95em */
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px; /* Réduit de 20px à 15px */
            transition: background-color 0.3s;
        }
        
        .create-product-button:hover {
            background-color: #0056b3;
        }
        
        .create-product-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .cancel-button {
            background-color: #f5f5f5;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 8px; /* Réduit de 10px à 8px */
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            margin-top: 8px; /* Réduit de 10px à 8px */
            transition: background-color 0.3s;
        }
        
        .cancel-button:hover {
            background-color: #e9e9e9;
        }
        
        .price-input-container {
            position: relative;
        }
        
        .price-input-container::before {
            content: "$";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .price-input {
            padding-left: 25px !important;
        }
        
        .upload-success-icon {
            color: #4CAF50;
            display: none;
        }
        
        .price-calculation {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 6px; /* Réduit de 8px à 6px */
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
            text-align: left;
        }
        
        .price-calculation-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px; /* Réduit de 3px à 2px */
        }
        
        .price-calculation-total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 2px; /* Réduit de 3px à 2px */
            margin-top: 2px; /* Réduit de 3px à 2px */
        }
        
        .splash-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            z-index: 10;
        }
        
        .spinner {
            width: 20px; /* Réduit de 30px à 20px */
            height: 20px; /* Réduit de 30px à 20px */
            border: 2px solid rgba(0, 123, 255, 0.3); /* Réduit de 3px à 2px */
            border-radius: 50%;
            border-top-color: #007BFF;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .links-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .links-modal-content {
            background-color: white;
            border-radius: 20px; /* Augmenté à 20px */
            width: 92%; /* Augmenté de 90% à 92% */
            max-width: 500px; /* Augmenté de 450px à 500px */
            padding: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .links-modal-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #007BFF;
            text-align: center;
            border-bottom: 1px solid #e9f5ff;
            padding-bottom: 10px;
        }
        
        .link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #007BFF;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        
        .link-number {
            font-weight: bold;
            color: #007BFF;
            margin-right: 10px;
        }
        
        .link-url {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
            font-size: 0.9em;
        }
        
        .copy-link-btn {
            background-color: transparent;
            border: none;
            color: #007BFF;
            cursor: pointer;
            padding: 5px;
            font-size: 1.1em;
        }
        
        .copy-link-btn:hover {
            color: #0056b3;
        }
        
        .paypal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .paypal-modal-content {
            background-color: white;
            border-radius: 20px; /* Augmenté à 20px */
            width: 85%; /* Réduit de 90% à 85% */
            max-width: 320px; /* Réduit de 400px à 320px */
            padding: 16px; /* Réduit de 20px à 16px */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid #007BFF;
        }
        
        .paypal-modal-title {
            font-size: 1.1em; /* Réduit de 1.2em à 1.1em */
            font-weight: bold;
            margin-bottom: 12px; /* Réduit de 15px à 12px */
            color: #007BFF;
            text-align: center;
        }
        
        .paypal-form-group {
            margin-bottom: 12px; /* Réduit de 15px à 12px */
        }
        
        .paypal-form-label {
            display: block;
            margin-bottom: 4px; /* Réduit de 5px à 4px */
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        
        .paypal-form-control {
            width: 100%;
            padding: 8px; /* Réduit de 10px à 8px */
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .paypal-form-control:focus {
            border-color: #007BFF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .paypal-submit-btn {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px; /* Réduit de 12px à 10px */
            font-size: 0.95em; /* Réduit de 1em à 0.95em */
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .paypal-submit-btn:hover {
            background-color: #0056b3;
        }
        
        .paypal-submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .paypal-modal-message {
            margin-bottom: 15px; /* Réduit de 20px à 15px */
            color: #555;
            font-size: 0.85em; /* Réduit de 0.9em à 0.85em */
            line-height: 1.4;
        }
        
        .paypal-error {
            color: #F44336;
            font-size: 0.8em;
            margin-top: 5px;
            display: none;
        }
        
        .sold-transaction {
            border-left: 3px solid #4CAF50 !important;
        }
        
        .payout-transaction {
            border-left: 3px solid #2196F3 !important;
        }
        
        @media (max-width: 500px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .title { font-size: 0.6rem; }
            .value { font-size: 1.1rem; }
            
            .button-container {
                justify-content: space-between;
                padding: 4px 10px;
            }
            
            .button {
                padding: 6px 10px;
                margin: 0 2px;
                min-width: 60px;
            }
            
            .modal-content {
                width: 80%;
                max-width: 250px;
            }
            
            .confirm-modal-content {
                width: 85%;
                max-width: 280px;
                padding: 18px;
            }
            
            .delete-button {
                font-size: 1em;
            }
            
            .toast {
                max-width: 250px;
                left: 20px;
                right: 20px;
            }
            
            .product-modal-content {
                width: 92%;
                padding: 15px;
                max-height: 95vh;
            }
            
            .file-upload-container {
                grid-template-columns: 1fr;
            }
            
            .paypal-modal-content {
                width: 90%;
                padding: 15px;
                max-width: 280px;
            }
            
            .links-modal-content {
                width: 92%;
                padding: 15px;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
<header>
    <h1 translate="no">Monetizelt</h1>
    <div class="icon-container">
        <div class="icon-container">
            <a class="icon" id="linksIcon" href="javascript:void(0);" aria-label="View links">
                <i class="fas fa-link" style="font-size: 23px;"></i>
            </a>
            <a class="icon" id="profileIcon" href="javascript:void(0);" aria-label="User profile">
                <i class="fas fa-user" style="font-size: 23px;"></i>
            </a>
        </div>
    </div>
</header>
<div class="divider"></div>
<div class="slogan">Your market, your rules! <br> Generate, share, cash in!</div>

<div class="button-container">
    <a class="button button-explorer disabled" id="generateBtn" href="javascript:void(0);"><i class="fas fa-link"></i> Generate</a>
    <a class="button" href="sellerfaq.html"><i class="fas fa-question-circle"></i> FAQ</a>
    <a class="button" href="sellerterms.html"><i class="fas fa-file-contract"></i> Terms</a>
    <a class="button" href="sellerprivacy.html"><i class="fas fa-file-contract"></i> Privacy</a>
</div>
<div id="paymentWarning" class="payment-warning" style="text-align: center;">Update your payment method to start generating links</div>

<div class="dashboard">
    <select class="year-select" aria-label="Select a year" id="yearSelect">
        <option value="">All years</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
        <option value="2026">2026</option>
    </select>

    <select class="month-select" aria-label="Select a month" id="monthSelect">
        <option value="">All months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>

    <div class="grid">
        <div class="card liens-generes small-card">
            <div class="splash-screen" id="linksCountSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Generated Links</div>
            <div class="value-wrapper">
                <div class="value" id="linksCount">0</div>
                <span id="linksIndicator" class="trend-indicator"></span>
            </div>
        </div>
        <div class="card vues small-card">
            <div class="splash-screen" id="viewsCountSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Views</div>
            <div class="value-wrapper">
                <div class="value" id="viewsCount">0</div>
                <span id="viewsIndicator" class="trend-indicator"></span>
            </div>
        </div>
        <div class="card commandes small-card">
            <div class="splash-screen" id="ordersCountSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Orders</div>
            <div class="value-wrapper">
                <div class="value" id="ordersCount">0</div>
                <span id="ordersIndicator" class="trend-indicator"></span>
            </div>
        </div>
        <div class="card traite small-card">
            <div class="splash-screen" id="shippedCountSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Processed</div>
            <div class="value-wrapper">
                <div class="value" id="shippedCount">0</div>
                <span id="shippedIndicator" class="trend-indicator"></span>
            </div>
        </div>
        <div class="card revenus small-card">
            <div class="splash-screen" id="revenueCountSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Revenue</div>
            <div class="value-wrapper">
                <div class="value" id="revenueCount">0$</div>
                <span id="revenueIndicator" class="trend-indicator"></span>
            </div>
        </div>
        <a class="card paiement small-card pulse-animation" id="paypalCard" href="javascript:void(0);" aria-label="PayPal Configuration">
            <span class="payment-status not-active" id="paypalStatus">Not Active</span>
            <div class="title">Payments</div>
            <i class="fab fa-paypal" style="font-size: 1.2em; color: #007BFF;"></i>
        </a>
        <div class="card history">
            <div class="splash-screen" id="transactionSplash" style="display:none;">
                <div class="spinner"></div>
            </div>
            <div class="title">Transactions</div>
            <div id="transactionList">
                <div class="no-transactions">No transactions</div>
            </div>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Account Options</div>
        <button id="deleteAccountBtn" class="delete-button">Delete Account</button>
    </div>
</div>

<div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
        <div class="modal-title">Confirm Account Deletion</div>
        <div class="modal-message">This action cannot be undone. All your data will be permanently removed.</div>
        <input type="email" id="emailInput" class="email-input" placeholder="Your email">
        <input type="password" id="passwordInput" class="password-input" placeholder="Your password">
        <div class="confirm-buttons">
            <button id="cancelDeleteBtn" class="cancel-delete">Cancel</button>
            <button id="confirmDeleteBtn" class="confirm-delete">Delete</button>
        </div>
    </div>
</div>

<div id="createProductModal" class="create-product-modal">
    <div class="product-modal-content">
        <div class="product-modal-title">Create New Product</div>
        
        <div class="form-group">
            <label for="productTitle" class="form-label">Title</label>
            <input type="text" id="productTitle" class="form-control" placeholder="Enter product title">
        </div>
        
        <div class="form-group">
            <label for="productCategory" class="form-label">Category</label>
            <select id="productCategory" class="form-select">
                <option value="">Select a category</option>
                <option value="video">Video Content</option>
                <option value="ebook">E-Book</option>
                <option value="music">Music/Song</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="productDescription" class="form-label">Description</label>
            <textarea id="productDescription" class="form-control" rows="3" placeholder="Describe your product" maxlength="500"></textarea>
            <div class="character-count"><span id="descriptionCharCount">0</span>/500</div>
        </div>
        
        <div class="form-group">
            <label for="productPrice" class="form-label">Price ($)</label>
            <div class="price-input-container">
                <input type="number" id="productPrice" class="form-control price-input" placeholder="0.00" min="0.50" step="0.01">
            </div>
            <div id="priceCalculation" class="price-calculation" style="display:none;">
                <div class="price-calculation-item">
                    <span>Base price:</span>
                    <span id="basePrice">$0.00</span>
                </div>
                <div class="price-calculation-item">
                    <span>Tax (7%):</span>
                    <span id="taxAmount">$0.00</span>
                </div>
                <div class="price-calculation-item">
                    <span>PayPal fees:</span>
                    <span id="paypalFees">$0.00</span>
                </div>
                <div class="price-calculation-item">
                    <span>Your earnings (80%):</span>
                    <span id="sellerEarnings">$0.00</span>
                </div>
                <div class="price-calculation-item price-calculation-total">
                    <span>Final price:</span>
                    <span id="finalPrice">$0.00</span>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Files</label>
            <div class="file-upload-container">
                <div class="file-upload-box" id="coverUploadBox">
                    <i class="fas fa-image file-upload-icon"></i>
                    <span class="file-upload-text">Cover Image</span>
                    <input type="file" id="coverFile" class="file-upload-input" accept="image/*">
                    <i class="fas fa-check-circle upload-success-icon" id="coverSuccessIcon"></i>
                    <div class="file-name" id="coverFileName"></div>
                </div>
                
                <div class="file-upload-box" id="productFileUploadBox">
                    <i class="fas fa-file file-upload-icon"></i>
                    <span class="file-upload-text">Product File</span>
                    <input type="file" id="productFile" class="file-upload-input">
                    <i class="fas fa-check-circle upload-success-icon" id="productFileSuccessIcon"></i>
                    <div class="file-name" id="productFileName"></div>
                </div>
            </div>
            <div class="character-count" id="fileUploadLimits">Max: 500MB for videos, 100MB for other files</div>
        </div>
        
        <button id="createProductBtn" class="create-product-button">Generate Link</button>
        <button id="cancelProductBtn" class="cancel-button">Cancel</button>
    </div>
</div>

<div id="linksModal" class="links-modal">
    <div class="links-modal-content">
        <div class="links-modal-title">Generated Links</div>
        <div id="linksList">
            <div style="text-align: center; color: #888;">No links generated yet</div>
        </div>
        <button id="closeLinksModal" class="cancel-button" style="margin-top: 15px;">Close</button>
    </div>
</div>

<div id="paypalModal" class="paypal-modal">
    <div class="paypal-modal-content">
        <div class="paypal-modal-title">PayPal Account Setup</div>
        <div class="paypal-modal-message">
            Please register your PayPal email address to receive your payments every Sunday 
            if your balance reaches a minimum of $10.
        </div>
        <div class="paypal-form-group">
            <label for="paypalEmail" class="paypal-form-label">PayPal Email</label>
            <input type="email" id="paypalEmail" class="paypal-form-control" placeholder="your@email.com">
            <div id="paypalEmailError" class="paypal-error">Please enter a valid email address</div>
        </div>
        <button id="savePaypalBtn" class="paypal-submit-btn">Save</button>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot, query, where, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-functions.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAF4I7E6-_z8y_8n8P35zyKbh9WOEtIzMQ",
        authDomain: "monetizelt-b235d.firebaseapp.com",
        projectId: "monetizelt-b235d",
        storageBucket: "monetizelt-b235d.appspot.com",
        messagingSenderId: "1040211471009",
        appId: "1:1040211471009:web:321898c7bdca6258ce9ee0",
        measurementId: "G-5NWKR1E9VY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'us-central1');
    const storage = getStorage(app);

    let currentUserData = null;
    let previousUserData = null;
    let realTimeListeners = [];
    let selectedYear = "";
    let selectedMonth = "";
    let isInitialLoad = true;
    let dataLoaded = false;
    let dataLoadingPromise = null;
    let userIdToken = null;
    let paypalAccountComplete = false;
    let generatedLinks = [];
    
    let coverFile = null;
    let productFile = null;
    let coverFileUrl = null;
    let productFileUrl = null;
    
    let hasRedirectedFromAccountCreation = false;
    let refreshInterval;
    let isSubmitting = false;

    // Function to show splash screen on dashboard elements
    function showSplashScreen(elementId, show = true) {
        const splashElement = document.getElementById(elementId);
        if (splashElement) {
            splashElement.style.display = show ? 'flex' : 'none';
        }
    }
    
    // Show loading state for all dashboard elements
    function showAllSplashScreens(show = true) {
        showSplashScreen('linksCountSplash', show);
        showSplashScreen('viewsCountSplash', show);
        showSplashScreen('ordersCountSplash', show);
        showSplashScreen('shippedCountSplash', show);
        showSplashScreen('revenueCountSplash', show);
        showSplashScreen('transactionSplash', show);
    }
    
    // Setup regular refresh of dashboard data
    function setupDataRefresh() {
        clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
            if (auth.currentUser) {
                showAllSplashScreens(true);
                setTimeout(() => {
                    refreshDashboardData(auth.currentUser.uid);
                }, 1000); // Reduced from 2000ms to 1000ms
            }
        }, 180000); // Refresh every 3 minutes
    }
    
    // Refresh dashboard data
    async function refreshDashboardData(userId) {
        try {
            await loadUserData(userId);
            await loadLinksData(userId);
            await loadOrdersData(userId);
            showAllSplashScreens(false);
        } catch (error) {
            console.error("Error refreshing data:", error);
            showAllSplashScreens(false);
        }
    }
    
    // Show notification toast
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = '';
        if (type === 'success') {
            icon = '<i class="fas fa-check-circle toast-icon"></i>';
        } else if (type === 'error') {
            icon = '<i class="fas fa-exclamation-circle toast-icon"></i>';
        } else if (type === 'info') {
            icon = '<i class="fas fa-info-circle toast-icon"></i>';
        }
        
        toast.innerHTML = `${icon}<div>${message}</div>`;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Animation for value updates
    function animateUpdate(element) {
        element.classList.add('pulse');
        setTimeout(() => {
            element.classList.remove('pulse');
        }, 500);
    }

    // Function to validate email format
    function isValidEmail(email) {
        const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }
    
    // Set up PayPal account
    async function setupPayPalAccount() {
        const paypalModal = document.getElementById('paypalModal');
        const paypalEmail = document.getElementById('paypalEmail');
        const paypalEmailError = document.getElementById('paypalEmailError');
        const savePaypalBtn = document.getElementById('savePaypalBtn');
        
        // Reset previous input
        paypalEmail.value = "";
        paypalEmailError.style.display = "none";
        savePaypalBtn.disabled = false;
        
        // If user already has PayPal set up, prefill the email
        if (currentUserData && currentUserData.paypalEmail) {
            paypalEmail.value = currentUserData.paypalEmail;
        }
        
        paypalModal.style.display = "flex";
    }
    
    // Save PayPal email
    async function savePayPalEmail() {
        if (isSubmitting) return;
        
        try {
            const paypalEmail = document.getElementById('paypalEmail').value.trim();
            const paypalEmailError = document.getElementById('paypalEmailError');
            const savePaypalBtn = document.getElementById('savePaypalBtn');
            
            if (!isValidEmail(paypalEmail)) {
                paypalEmailError.style.display = "block";
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showToast("Please log in to set up PayPal", "error");
                return;
            }
            
            isSubmitting = true;
            savePaypalBtn.disabled = true;
            
            showToast("Saving your PayPal email...", "info");
            
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, {
                paypalEmail: paypalEmail,
                onboardingComplete: true,
                lastUpdate: serverTimestamp()
            });
            
            document.getElementById('paypalModal').style.display = "none";
            showToast("PayPal email saved successfully!", "success");
            
            updatePayPalUI(true);
            
        } catch (error) {
            console.error("Error saving PayPal email:", error);
            showToast(`Error: ${error.message}`, "error");
            
            const savePaypalBtn = document.getElementById('savePaypalBtn');
            savePaypalBtn.disabled = false;
        } finally {
            isSubmitting = false;
        }
    }

    // Check PayPal account status
    async function checkPayPalStatus() {
        try {
            const user = auth.currentUser;
            if (!user) return false;
            
            userIdToken = await user.getIdToken(true);
            
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                await setDoc(userRef, {
                    uid: user.uid,
                    email: user.email,
                    createdAt: serverTimestamp(),
                    lastUpdate: serverTimestamp(),
                    onboardingComplete: false,
                    paypalEmail: null,
                    linksCount: 0,
                    viewsCount: 0,
                    ordersCount: 0,
                    shippedCount: 0,
                    revenueCount: 0,
                    transactions: []
                });
                
                updatePayPalUI(false);
                return false;
            }
            
            const userData = userSnap.data();
            const isComplete = userData && userData.onboardingComplete === true && userData.paypalEmail;
            
            updatePayPalUI(isComplete);
            
            return isComplete;
        } catch (error) {
            console.error("Error checking PayPal status:", error);
            
            updatePayPalUI(false);
            return false;
        }
    }
    
    // Update UI based on PayPal status
    function updatePayPalUI(isActive) {
        const paypalStatus = document.getElementById('paypalStatus');
        const paypalCard = document.getElementById('paypalCard');
        const generateBtn = document.getElementById('generateBtn');
        const paymentWarning = document.getElementById('paymentWarning');
        
        paypalAccountComplete = isActive;
        
        if (isActive) {
            paypalStatus.textContent = "Active";
            paypalStatus.className = "payment-status active";
            paypalCard.setAttribute("onclick", "setupPayPalAccount()");
            paypalCard.style.borderColor = "#4CAF50";
            paypalCard.classList.remove("pulse-animation");
            
            generateBtn.classList.remove("disabled");
            generateBtn.onclick = openProductModal;
            
            paymentWarning.style.display = "none";
        } else {
            paypalStatus.textContent = "Not Active";
            paypalStatus.className = "payment-status not-active";
            paypalCard.setAttribute("onclick", "setupPayPalAccount()");
            paypalCard.style.borderColor = "#007BFF";
            paypalCard.classList.add("pulse-animation");
            
            generateBtn.classList.add("disabled");
            generateBtn.onclick = function() {
                showToast("Please set up your PayPal account first", "error");
            };
            
            paymentWarning.style.display = "block";
        }
    }

    // Check if user was redirected from account creation
    function checkAccountCreationReferral() {
        const referrer = document.referrer;
        const hasCreationReferrer = referrer.includes('index.html');
        
        const hasBeenRedirected = localStorage.getItem('redirectedFromAccountCreation') === 'true';
        
        if (hasCreationReferrer && !hasBeenRedirected) {
            localStorage.setItem('redirectedFromAccountCreation', 'true');
            hasRedirectedFromAccountCreation = true;
            
            setTimeout(() => {
                showToast("Returning to previous page...", "info");
                history.back();
            }, 500);
        }
    }

    // Handle price input and calculate final prices
    function handlePriceCalculation() {
        const priceInput = document.getElementById('productPrice');
        const priceCalculation = document.getElementById('priceCalculation');
        const basePrice = document.getElementById('basePrice');
        const taxAmount = document.getElementById('taxAmount');
        const paypalFees = document.getElementById('paypalFees');
        const sellerEarnings = document.getElementById('sellerEarnings');
        const finalPrice = document.getElementById('finalPrice');
        
        const price = parseFloat(priceInput.value);
        
        if (isNaN(price) || price <= 0) {
            priceCalculation.style.display = 'none';
            return;
        }
        
        // Calculate tax (7%)
        const tax = price * 0.07;
        // Estimate PayPal fees (2.9% + $0.30)
        const priceWithTax = price + tax;
        const ppFees = (priceWithTax * 0.029) + 0.30;
        // Calculate seller's 80% of the price
        const earnings = price * 0.8;
        
        basePrice.textContent = `$${price.toFixed(2)}`;
        taxAmount.textContent = `$${tax.toFixed(2)}`;
        paypalFees.textContent = `$${ppFees.toFixed(2)}`;
        sellerEarnings.textContent = `$${earnings.toFixed(2)}`;
        finalPrice.textContent = `$${priceWithTax.toFixed(2)}`;
        
        priceCalculation.style.display = 'block';
    }

    // Open product creation modal
    function openProductModal() {
        const createProductModal = document.getElementById("createProductModal");
        createProductModal.style.display = "flex";
        
        document.getElementById("productTitle").value = "";
        document.getElementById("productCategory").value = "";
        document.getElementById("productDescription").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("descriptionCharCount").textContent = "0";
        document.getElementById("priceCalculation").style.display = "none";
        
        coverFile = null;
        productFile = null;
        coverFileUrl = null;
        productFileUrl = null;
        
        document.getElementById("coverFileName").textContent = "";
        document.getElementById("coverFileName").style.display = "none";
        document.getElementById("coverSuccessIcon").style.display = "none";
        
        document.getElementById("productFileName").textContent = "";
        document.getElementById("productFileName").style.display = "none";
        document.getElementById("productFileSuccessIcon").style.display = "none";
        
        const createProductBtn = document.getElementById("createProductBtn");
        createProductBtn.disabled = false;
    }
    
    // Open generated links modal
    async function openLinksModal() {
        const linksModal = document.getElementById("linksModal");
        const linksList = document.getElementById("linksList");
        
        // Clear previous links
        linksList.innerHTML = '<div style="text-align: center;"><div class="spinner"></div></div>';
        
        linksModal.style.display = "flex";
        
        try {
            const user = auth.currentUser;
            if (!user) {
                throw new Error("User not logged in");
            }
            
            const productsRef = collection(db, "products");
            const productsQuery = query(productsRef, where("uid", "==", user.uid));
            const querySnapshot = await getDocs(productsQuery);
            
            if (querySnapshot.empty) {
                linksList.innerHTML = '<div style="text-align: center; color: #888;">No links generated yet</div>';
                return;
            }
            
            generatedLinks = [];
            querySnapshot.forEach(doc => {
                const product = doc.data();
                if (product.shareableLink) {
                    generatedLinks.push({
                        id: doc.id,
                        title: product.title || `Product #${generatedLinks.length + 1}`,
                        link: product.shareableLink
                    });
                }
            });
            
            if (generatedLinks.length === 0) {
                linksList.innerHTML = '<div style="text-align: center; color: #888;">No links generated yet</div>';
                return;
            }
            
            linksList.innerHTML = '';
            generatedLinks.forEach((link, index) => {
                const linkItem = document.createElement('div');
                linkItem.className = 'link-item';
                linkItem.innerHTML = `
                    <span class="link-number">${index + 1})</span>
                    <span class="link-url" title="${link.link}">${link.link}</span>
                    <button class="copy-link-btn" data-link="${link.link}">
                        <i class="fas fa-copy"></i>
                    </button>
                `;
                linksList.appendChild(linkItem);
            });
            
            // Add click handlers for copy buttons
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const link = this.getAttribute('data-link');
                    navigator.clipboard.writeText(link).then(() => {
                        showToast("Link copied to clipboard!", "success");
                    });
                });
            });
            
        } catch (error) {
            console.error("Error loading links:", error);
            linksList.innerHTML = '<div style="text-align: center; color: #F44336;">Error loading links</div>';
        }
    }
    
    // Create a base64 image from file
    function convertFileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    // Create product and generate link
    async function createProduct() {
        if (isSubmitting) return;
        
        try {
            const createProductBtn = document.getElementById("createProductBtn");
            
            const user = auth.currentUser;
            if (!user) {
                showToast("Please log in to create a product", "error");
                return;
            }
            
            const title = document.getElementById("productTitle").value.trim();
            const category = document.getElementById("productCategory").value;
            const description = document.getElementById("productDescription").value.trim();
            const price = parseFloat(document.getElementById("productPrice").value);
            
            // Calculate price with tax
            const priceWithTax = price * 1.07;
            
            if (!title) {
                showToast("Please enter a product title", "error");
                return;
            }
            
            if (!category) {
                showToast("Please select a category", "error");
                return;
            }
            
            if (!description) {
                showToast("Please enter a description", "error");
                return;
            }
            
            if (isNaN(price) || price < 0.5) {
                showToast("Please enter a valid price (minimum $0.50)", "error");
                return;
            }
            
            if (!coverFile) {
                showToast("Please upload a cover image", "error");
                return;
            }
            
            if (!productFile) {
                showToast("Please upload your product file", "error");
                return;
            }
            
            // Check if user has set up PayPal
            if (!paypalAccountComplete) {
                showToast("Please set up your PayPal account first", "error");
                setupPayPalAccount();
                return;
            }
            
            isSubmitting = true;
            createProductBtn.disabled = true;
            
            showToast("Creating your product...", "info");
            
            document.getElementById("createProductModal").style.display = "none";
            
            // Convert files to base64
            let coverBase64;
            let productBase64;
            
            try {
                coverBase64 = await convertFileToBase64(coverFile);
                productBase64 = await convertFileToBase64(productFile);
            } catch (fileError) {
                console.error("Error converting files:", fileError);
                showToast("Error processing files. Please try again.", "error");
                isSubmitting = false;
                createProductBtn.disabled = false;
                return;
            }
            
            const createProductFn = httpsCallable(functions, 'createProduct');
            
            const result = await createProductFn({
                title: title,
                category: category,
                description: description,
                price: priceWithTax.toFixed(2), // Use price with tax
                coverData: coverBase64,
                fileData: productBase64,
                fileName: productFile.name
            });
            
            if (result.data && result.data.shareableLink) {
                showToast("Product created successfully!", "success");
                
                const shareableLink = result.data.shareableLink;
                
                const linkModal = document.createElement("div");
                linkModal.className = "modal";
                linkModal.style.display = "flex";
                linkModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-title">Your Product Link</div>
                        <div style="margin-bottom: 15px; word-break: break-all;">${shareableLink}</div>
                        <button id="copyLinkBtn" class="create-product-button">Copy Link</button>
                        <button id="closeLinkModalBtn" class="cancel-button">Close</button>
                    </div>
                `;
                
                document.body.appendChild(linkModal);
                
                document.getElementById("copyLinkBtn").addEventListener("click", function() {
                    navigator.clipboard.writeText(shareableLink).then(() => {
                        showToast("Link copied to clipboard!", "success");
                    });
                });
                
                document.getElementById("closeLinkModalBtn").addEventListener("click", function() {
                    linkModal.remove();
                });
                
                setTimeout(() => {
                    if (document.body.contains(linkModal)) {
                        linkModal.remove();
                    }
                }, 30000);
                
                // Refresh dashboard data
                showAllSplashScreens(true);
                setTimeout(() => {
                    refreshDashboardData(user.uid);
                }, 1000);
            } else {
                throw new Error("No shareable link provided");
            }
        } catch (error) {
            console.error("Error creating product:", error);
            showToast(`Error: ${error.message || "Unknown error"}`, "error");
        } finally {
            isSubmitting = false;
            const createProductBtn = document.getElementById("createProductBtn");
            if (createProductBtn) createProductBtn.disabled = false;
        }
    }

    // Authentication state listener
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            try {
                showAllSplashScreens(true);
                
                userIdToken = await user.getIdToken(true);
                
                cleanupListeners();
                
                checkAccountCreationReferral();
                
                if (hasRedirectedFromAccountCreation) {
                    return;
                }
                
                await checkPayPalStatus();
                
                dataLoadingPromise = loadUserData(user.uid);
                dataLoadingPromise.then(() => {
                    setupRealTimeListeners(user.uid);
                    dataLoaded = true;
                    showAllSplashScreens(false);
                    
                    if (isInitialLoad) {
                        isInitialLoad = false;
                        showToast("Welcome to your dashboard!", "success");
                    }
                    
                    setupDataRefresh();
                }).catch(error => {
                    console.error("Error loading data:", error);
                    showAllSplashScreens(false);
                    showToast("Error loading data: " + error.message, "error");
                });
            } catch (error) {
                console.error("Error during initialization:", error);
                showAllSplashScreens(false);
                showToast("An error occurred. Please try again.", "error");
            }
        } else {
            window.location.href = "index.html";
        }
    });

    // Clean up real-time listeners
    function cleanupListeners() {
        realTimeListeners.forEach(unsubscribe => unsubscribe());
        realTimeListeners = [];
    }

    // Load user data
    async function loadUserData(userId) {
        if (!userId) {
            throw new Error("User ID is required");
        }
        
        try {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                previousUserData = currentUserData;
                currentUserData = userData;
                
                updateDashboardUI(userData);
                
                if (selectedYear || selectedMonth) {
                    updateTransactionList(userData.transactions || [], selectedYear, selectedMonth);
                }
                
                if (userData.onboardingComplete && userData.paypalEmail) {
                    updatePayPalUI(true);
                } else {
                    updatePayPalUI(false);
                }
                
                return userData;
            } else {
                console.log("No user document found, creating new...");
                const newUserData = {
                    uid: userId,
                    email: auth.currentUser ? auth.currentUser.email : "",
                    linksCount: 0,
                    viewsCount: 0,
                    ordersCount: 0,
                    shippedCount: 0,
                    revenueCount: 0,
                    transactions: [],
                    createdAt: serverTimestamp(),
                    lastUpdate: serverTimestamp(),
                    onboardingComplete: false,
                    paypalEmail: null
                };
                
                await setDoc(userDocRef, newUserData);
                currentUserData = newUserData;
                updateDashboardUI(newUserData);
                updatePayPalUI(false);
                return newUserData;
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            throw error;
        }
    }

    // Set up real-time listeners
    function setupRealTimeListeners(userId) {
        if (!userId) {
            console.error("No user ID provided for real-time listeners");
            return;
        }
        
        try {
            const userDocRef = doc(db, "users", userId);
            const userUnsubscribe = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    previousUserData = currentUserData;
                    const newData = doc.data();
                    currentUserData = newData;
                    updateDashboardUI(newData);
                    
                    if (newData.onboardingComplete && newData.paypalEmail) {
                        updatePayPalUI(true);
                    } else {
                        updatePayPalUI(false);
                    }
                }
            }, (error) => {
                console.error("Error in real-time listener for user document:", error);
                showToast("Data synchronization issue", "error");
            });
            realTimeListeners.push(userUnsubscribe);
        } catch (error) {
            console.error("Error setting up listeners:", error);
        }
        
        try {
            loadLinksData(userId);
        } catch (error) {
            console.error("Error loading links:", error);
        }
        
        try {
            loadOrdersData(userId);
        } catch (error) {
            console.error("Error loading orders:", error);
        }
    }

    // Load links data
    async function loadLinksData(userId) {
        if (!userId) {
            console.error("No user ID provided for loading links");
            return;
        }
        
        try {
            showSplashScreen('linksCountSplash', true);
            showSplashScreen('viewsCountSplash', true);
            
            const linksRef = collection(db, "products");
            const linksQuery = query(linksRef, where("uid", "==", userId));
            
            const snapshot = await getDocs(linksQuery);
            let totalLinks = snapshot.size;
            let totalViews = 0;
            
            snapshot.forEach(doc => {
                const linkData = doc.data();
                totalViews += linkData.viewCount || 0;
            });
            
            updateCountWithAnimation("linksCount", "linksIndicator", totalLinks, "", previousUserData?.linksCount);
            updateCountWithAnimation("viewsCount", "viewsIndicator", totalViews, "", previousUserData?.viewsCount);
            
            if (currentUserData && (currentUserData.linksCount !== totalLinks || currentUserData.viewsCount !== totalViews)) {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, {
                    linksCount: totalLinks,
                    viewsCount: totalViews,
                    lastUpdate: serverTimestamp()
                }).catch(error => {
                    console.error("Error updating user data:", error);
                });
            }
            
            showSplashScreen('linksCountSplash', false);
            showSplashScreen('viewsCountSplash', false);
            
        } catch (error) {
            console.error("Error loading links:", error);
            showSplashScreen('linksCountSplash', false);
            showSplashScreen('viewsCountSplash', false);
            showToast("Error syncing products", "error");
        }
    }

    // Load orders data
    async function loadOrdersData(userId) {
        if (!userId) {
            console.error("No user ID provided for loading orders");
            return;
        }
        
        try {
            showSplashScreen('ordersCountSplash', true);
            showSplashScreen('shippedCountSplash', true);
            showSplashScreen('revenueCountSplash', true);
            showSplashScreen('transactionSplash', true);
            
            const ordersRef = collection(db, "orders");
            const ordersQuery = query(ordersRef, where("sellerId", "==", userId));
            
            const snapshot = await getDocs(ordersQuery);
            let totalOrders = snapshot.size;
            let shippedOrders = 0;
            let totalRevenue = 0;
            let transactions = [];
            
            snapshot.forEach(doc => {
                const orderData = doc.data();
                if (orderData.status === "shipped" || orderData.status === "delivered") {
                    shippedOrders++;
                }
                
                totalRevenue += orderData.totalAmount || 0;
                
                transactions.push({
                    id: doc.id,
                    title: orderData.productName || "Order #" + doc.id.substring(0, 8),
                    amount: orderData.totalAmount || 0,
                    date: orderData.createdAt || new Date(),
                    status: orderData.status || "pending",
                    type: "sale"
                });
            });
            
            // Add payout transactions
            const payoutsRef = collection(db, "payouts");
            const payoutsQuery = query(payoutsRef, where("sellerId", "==", userId));
            const payoutsSnapshot = await getDocs(payoutsQuery);
            
            payoutsSnapshot.forEach(doc => {
                const payoutData = doc.data();
                transactions.push({
                    id: doc.id,
                    title: "Weekly Payout",
                    amount: payoutData.amount || 0,
                    date: payoutData.createdAt || new Date(),
                    status: "completed",
                    type: "payout"
                });
            });
            
            updateCountWithAnimation("ordersCount", "ordersIndicator", totalOrders, "", previousUserData?.ordersCount);
            updateCountWithAnimation("shippedCount", "shippedIndicator", shippedOrders, "", previousUserData?.shippedCount);
            updateCountWithAnimation("revenueCount", "revenueIndicator", totalRevenue, "$", previousUserData?.revenueCount);
            
            updateTransactionList(transactions, selectedYear, selectedMonth);
            
            if (currentUserData && (
                currentUserData.ordersCount !== totalOrders || 
                currentUserData.shippedCount !== shippedOrders || 
                currentUserData.revenueCount !== totalRevenue
            )) {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, {
                    ordersCount: totalOrders,
                    shippedCount: shippedOrders,
                    revenueCount: totalRevenue,
                    transactions: transactions,
                    lastUpdate: serverTimestamp()
                }).catch(error => {
                    console.error("Error updating order data:", error);
                });
            }
            
            showSplashScreen('ordersCountSplash', false);
            showSplashScreen('shippedCountSplash', false);
            showSplashScreen('revenueCountSplash', false);
            showSplashScreen('transactionSplash', false);
            
        } catch (error) {
            console.error("Error loading orders:", error);
            showSplashScreen('ordersCountSplash', false);
            showSplashScreen('shippedCountSplash', false);
            showSplashScreen('revenueCountSplash', false);
            showSplashScreen('transactionSplash', false);
            showToast("Error syncing orders", "error");
        }
    }

    // Update counter with animation
    function updateCountWithAnimation(elementId, indicatorId, value, suffix, previousValue) {
        const element = document.getElementById(elementId);
        const indicator = document.getElementById(indicatorId);
        
        if (!element || !indicator) return;
        
        const currentText = element.textContent;
        const currentValue = currentText.replace(/[^0-9.-]+/g, "");
        
        if (currentValue !== "" && parseInt(currentValue) !== value) {
            animateUpdate(element);
            
            if (previousValue !== undefined) {
                if (value > previousValue) {
                    indicator.className = "trend-indicator trend-up";
                    indicator.innerHTML = '<i class="fas fa-arrow-up"></i>';
                } else if (value < previousValue) {
                    indicator.className = "trend-indicator trend-down";
                    indicator.innerHTML = '<i class="fas fa-arrow-down"></i>';
                } else {
                    indicator.className = "trend-indicator trend-neutral";
                    indicator.innerHTML = '<i class="fas fa-equals"></i>';
                }
            } else {
                indicator.className = "trend-indicator";
                indicator.innerHTML = '';
            }
        }
        
        if (elementId === "revenueCount") {
            element.textContent = value + "$";
        } else {
            element.textContent = value + suffix;
        }
    }

    // Update dashboard UI
    function updateDashboardUI(userData) {
        if (!userData) return;
        
        updateCountWithAnimation("linksCount", "linksIndicator", userData.linksCount || 0, "", previousUserData?.linksCount);
        updateCountWithAnimation("viewsCount", "viewsIndicator", userData.viewsCount || 0, "", previousUserData?.viewsCount);
        updateCountWithAnimation("ordersCount", "ordersIndicator", userData.ordersCount || 0, "", previousUserData?.ordersCount);
        updateCountWithAnimation("shippedCount", "shippedIndicator", userData.shippedCount || 0, "", previousUserData?.shippedCount);
        updateCountWithAnimation("revenueCount", "revenueIndicator", userData.revenueCount || 0, "$", previousUserData?.revenueCount);
        
        updateTransactionList(userData.transactions || [], selectedYear, selectedMonth);
    }

    // Update transaction list
    function updateTransactionList(transactions = [], year = "", month = "") {
        const transactionList = document.getElementById("transactionList");
        if (!transactionList) return;
        
        transactionList.innerHTML = "";

        if (!transactions || transactions.length === 0) {
            const noTransactions = document.createElement("div");
            noTransactions.className = "no-transactions";
            noTransactions.textContent = "No transactions";
            transactionList.appendChild(noTransactions);
            return;
        }

        let filteredTransactions = [...transactions]
            .sort((a, b) => {
                const dateA = a.date ? (a.date.toDate ? a.date.toDate() : new Date(a.date)) : new Date();
                const dateB = b.date ? (b.date.toDate ? b.date.toDate() : new Date(b.date)) : new Date();
                return dateB - dateA;
            })
            .filter(transaction => {
                if (!transaction.date) return false;
                
                const date = transaction.date.toDate ? transaction.date.toDate() : new Date(transaction.date);
                const transactionMonth = date.getMonth() + 1;
                const transactionYear = date.getFullYear();

                const yearMatch = !year || transactionYear.toString() === year.toString();
                const monthMatch = !month || transactionMonth.toString() === month.toString();
                
                return yearMatch && monthMatch;
            });

        if (filteredTransactions.length === 0) {
            const noTransactions = document.createElement("div");
            noTransactions.className = "no-transactions";
            noTransactions.textContent = "No transactions for this period";
            transactionList.appendChild(noTransactions);
            return;
        }

        filteredTransactions.forEach(transaction => {
            const date = transaction.date ? 
                (transaction.date.toDate ? transaction.date.toDate() : new Date(transaction.date)) : 
                new Date();
            
            const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            
            const item = document.createElement("div");
            item.className = "transaction-item";
            
            // Style based on transaction type
            if (transaction.type === "sale") {
                item.classList.add("sold-transaction");
                item.innerHTML = `
                    <div class="details">
                        <span>Sale</span>
                        <span class="date">${formattedDate}</span>
                    </div>
                    <span>$${transaction.amount || 0}</span>
                `;
            } else if (transaction.type === "payout") {
                item.classList.add("payout-transaction");
                item.innerHTML = `
                    <div class="details">
                        <span>Payout</span>
                        <span class="date">${formattedDate}</span>
                    </div>
                    <span>$${transaction.amount || 0}</span>
                `;
            } else {
                if (transaction.status === "shipped" || transaction.status === "delivered") {
                    item.style.borderLeft = "3px solid #4CAF50";
                } else if (transaction.status === "pending") {
                    item.style.borderLeft = "3px solid #FFC107";
                } else if (transaction.status === "cancelled") {
                    item.style.borderLeft = "3px solid #F44336";
                    item.style.opacity = "0.7";
                }
                
                item.innerHTML = `
                    <div class="details">
                        <span>${transaction.title || "Unspecified transaction"}</span>
                        <span class="date">${formattedDate}</span>
                    </div>
                    <span>$${transaction.amount || 0}</span>
                `;
            }
            
            transactionList.appendChild(item);
        });
    }

    // Set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const profileIcon = document.getElementById("profileIcon");
        const linksIcon = document.getElementById("linksIcon");
        const deleteModal = document.getElementById("deleteModal");
        const confirmModal = document.getElementById("confirmModal");
        const deleteAccountBtn = document.getElementById("deleteAccountBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const generateBtn = document.getElementById("generateBtn");
        const paypalCard = document.getElementById("paypalCard");
        const savePaypalBtn = document.getElementById("savePaypalBtn");
        const closeLinksModal = document.getElementById("closeLinksModal");
        
        document.getElementById("cancelProductBtn").addEventListener("click", function() {
            document.getElementById("createProductModal").style.display = "none";
        });
        
        document.getElementById("createProductBtn").addEventListener("click", createProduct);
        
        document.getElementById("productDescription").addEventListener("input", function() {
            const descLength = this.value.length;
            document.getElementById("descriptionCharCount").textContent = descLength;
        });
        
        document.getElementById("productPrice").addEventListener("input", handlePriceCalculation);
        
        document.getElementById("coverFile").addEventListener("change", function(e) {
            if (e.target.files.length > 0) {
                coverFile = e.target.files[0];
                
                if (!coverFile.type.startsWith('image/')) {
                    showToast("Please upload an image file for the cover", "error");
                    coverFile = null;
                    return;
                }
                
                if (coverFile.size > 5 * 1024 * 1024) {
                    showToast("Cover image must be less than 5MB", "error");
                    coverFile = null;
                    return;
                }
                
                const fileName = document.getElementById("coverFileName");
                fileName.textContent = "File added";
                fileName.style.display = "block";
                
                document.getElementById("coverSuccessIcon").style.display = "block";
            }
        });
        
        document.getElementById("productFile").addEventListener("change", function(e) {
            if (e.target.files.length > 0) {
                productFile = e.target.files[0];
                const category = document.getElementById("productCategory").value;
                
                if (category === "video" && productFile.size > 500 * 1024 * 1024) {
                    showToast("Video files must be less than 500MB", "error");
                    productFile = null;
                    return;
                } else if (productFile.size > 100 * 1024 * 1024) {
                    showToast("Files must be less than 100MB", "error");
                    productFile = null;
                    return;
                }
                
                const fileName = document.getElementById("productFileName");
                fileName.textContent = "File added";
                fileName.style.display = "block";
                
                document.getElementById("productFileSuccessIcon").style.display = "block";
            }
        });
        
        document.getElementById("productCategory").addEventListener("change", function() {
            const category = this.value;
            const fileUploadLimits = document.getElementById("fileUploadLimits");
            
            if (category === "video") {
                fileUploadLimits.textContent = "Max: 500MB for video content";
            } else if (category === "ebook") {
                fileUploadLimits.textContent = "Max: 100MB for e-books";
            } else if (category === "music") {
                fileUploadLimits.textContent = "Max: 100MB for music/songs";
            } else {
                fileUploadLimits.textContent = "Max: 100MB for files";
            }
        });
        
        savePaypalBtn.addEventListener("click", savePayPalEmail);
        
        closeLinksModal.addEventListener("click", function() {
            document.getElementById("linksModal").style.display = "none";
        });
        
        linksIcon.addEventListener("click", openLinksModal);
        
        window.openProductModal = openProductModal;
        window.setupPayPalAccount = setupPayPalAccount;
        
        generateBtn.addEventListener("click", function(e) {
            if (generateBtn.classList.contains("disabled")) {
                e.preventDefault();
                showToast("Please set up your PayPal account first", "error");
                
                paypalCard.style.animation = "pulse 1s ease 3";
                setTimeout(() => {
                    paypalCard.style.animation = paypalAccountComplete ? "none" : "pulse 2s infinite";
                }, 3000);
            }
        });
        
        profileIcon.addEventListener("click", function() {
            deleteModal.style.display = "flex";
        });
        
        window.addEventListener("click", function(event) {
            if (event.target === deleteModal) {
                deleteModal.style.display = "none";
            }
            if (event.target === confirmModal) {
                confirmModal.style.display = "none";
                emailInput.value = "";
                passwordInput.value = "";
            }
            if (event.target === document.getElementById("createProductModal")) {
                document.getElementById("createProductModal").style.display = "none";
            }
            if (event.target === document.getElementById("linksModal")) {
                document.getElementById("linksModal").style.display = "none";
            }
            if (event.target === document.getElementById("paypalModal")) {
                document.getElementById("paypalModal").style.display = "none";
            }
        });
        
        deleteAccountBtn.addEventListener("click", function() {
            deleteModal.style.display = "none";
            confirmModal.style.display = "flex";
            
            if (auth.currentUser && auth.currentUser.email) {
                emailInput.value = auth.currentUser.email;
            }
        });
        
        cancelDeleteBtn.addEventListener("click", function() {
            confirmModal.style.display = "none";
            emailInput.value = "";
            passwordInput.value = "";
        });
        
        confirmDeleteBtn.addEventListener("click", async function() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                showToast("Please enter your email and password", "error");
                return;
            }
            
            try {
                confirmModal.style.display = "none";
                
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("User not logged in");
                }
                
                const credential = EmailAuthProvider.credential(email, password);
                await reauthenticateWithCredential(user, credential);
                
                const userId = user.uid;
                
                showToast("Deleting account...", "info");
                
                // Delete user's products
                const productsRef = collection(db, "products");
                const productsQuery = query(productsRef, where("uid", "==", userId));
                const productsSnapshot = await getDocs(productsQuery);
                const productDeletions = [];
                
                productsSnapshot.forEach(productDoc => {
                    productDeletions.push(deleteDoc(doc(db, "products", productDoc.id)));
                });
                
                // Delete user's orders
                const ordersRef = collection(db, "orders");
                const ordersQuery = query(ordersRef, where("sellerId", "==", userId));
                const ordersSnapshot = await getDocs(ordersQuery);
                const orderDeletions = [];
                
                ordersSnapshot.forEach(orderDoc => {
                    orderDeletions.push(deleteDoc(doc(db, "orders", orderDoc.id)));
                });
                
                await Promise.all([
                    ...productDeletions,
                    ...orderDeletions
                ]);
                
                await deleteDoc(doc(db, "users", userId));
                
                await deleteUser(user);
                
                showToast("Account deleted successfully", "success");
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1500);
            } catch (error) {
                console.error("Error deleting account:", error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast("Incorrect password", "error");
                } else if (error.code === 'auth/user-mismatch') {
                    showToast("Email doesn't match current user", "error");
                } else if (error.code === 'auth/invalid-email') {
                    showToast("Invalid email format", "error");
                } else {
                    showToast("Error deleting account: " + error.message, "error");
                }
            }
        });
        
        document.getElementById("yearSelect").addEventListener("change", function() {
            showSplashScreen('transactionSplash', true);
            selectedYear = this.value;
            setTimeout(() => {
                if (currentUserData) {
                    updateTransactionList(currentUserData.transactions || [], selectedYear, selectedMonth);
                }
                showSplashScreen('transactionSplash', false);
            }, 500);
        });
        
        document.getElementById("monthSelect").addEventListener("change", function() {
            showSplashScreen('transactionSplash', true);
            selectedMonth = this.value;
            setTimeout(() => {
                if (currentUserData) {
                    updateTransactionList(currentUserData.transactions || [], selectedYear, selectedMonth);
                }
                showSplashScreen('transactionSplash', false);
            }, 500);
        });
        
        // Set default year to current year
        const currentYear = new Date().getFullYear().toString();
        const yearSelect = document.getElementById('yearSelect');
        if (yearSelect) {
            for (let i = 0; i < yearSelect.options.length; i++) {
                if (yearSelect.options[i].value === currentYear) {
                    yearSelect.selectedIndex = i;
                    selectedYear = currentYear;
                    break;
                }
            }
        }
    });
</script>
</body>
</html>
