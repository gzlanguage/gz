<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Create Account - G-Z</title>
    <link href="https://fonts.googleapis.com/css2?family=Billabong&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General styles */
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --background-color: #f5f5f5;
            --text-color: #333;
            --white: #ffffff;
            --error-color: #ff3333;
            --success-color: #28a745;
            --warning-color: #007bff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.4;
            font-size: 14px;
            /* To increase the base font size, modify this value (e.g.: 16px) */
        }
        header {
            background-color: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            /* To increase header height, increase padding value (e.g.: 15px 20px) */
        }
        .logo {
            font-size: 2.2em;
            font-family: 'Billabong', cursive;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 0px 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            /* To increase logo size, modify font-size value (e.g.: 2.5em) */
            /* To enlarge border, increase border-width (e.g.: 3px) */
        }
        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            width: 100%;
            margin: 2px 0;
            /* To increase divider thickness, modify height value (e.g.: 3px) */
        }
        .form-container {
            padding: 15px;
            text-align: center;
            background-color: #e9f5ff;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            margin: 10px auto;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            animation: slideUp 0.8s ease-out;
            position: relative;
            max-width: 400px;
            /* To enlarge form container, increase max-width (e.g.: 450px) */
            /* For more internal spacing, increase padding (e.g.: 20px) */
        }
        .button {
            display: block;
            background-color: #0077BE;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px;
            margin: 12px auto;
            text-decoration: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            text-align: center;
            height: 40px;
            /* For larger buttons, increase height (e.g.: 50px) and max-width (e.g.: 320px) */
            /* For a more visible button, increase font-size or padding */
        }
        .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .form-container input,
        .form-container select {
            padding: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 10px;
            font-size: 14px;
            height: 40px;
            /* To enlarge input fields, increase height (e.g.: 45px) */
            /* To increase text size, modify font-size (e.g.: 16px) */
        }
        .toggle-button {
            cursor: pointer;
            margin: 10px;
            color: var(--primary-color);
            text-decoration: underline;
            /* To increase link text size, modify font-size (e.g.: 15px) */
        }
        h2 {
            margin-bottom: 15px;
            font-size: 32px;
            color: var(--primary-dark);
            font-family: 'Billabong', cursive;
            font-weight: normal;
            /* To increase title size, modify font-size (e.g.: 36px) */
        }
        .forgot-password {
            margin-top: 10px;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            /* To increase text size, add font-size (e.g.: 15px) */
        }
        .message {
            margin: 10px auto;
            padding: 8px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 14px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            /* To increase message size, modify max-width and font-size */
        }
        .message i {
            margin-right: 8px;
            font-size: 16px;
            /* To enlarge icons, increase font-size (e.g.: 18px) */
        }
        .message.error {
            background-color: rgba(255, 51, 51, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(255, 51, 51, 0.3);
        }
        .message.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        .message.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .message.info {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(0, 123, 255, 0.3);
        }
        .footer-links {
            margin-top: 15px;
            font-size: 12px;
            /* To increase footer link size, modify font-size (e.g.: 14px) */
        }
        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
        }
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0;
            z-index: 1100;
            transition: width 0.3s ease;
            /* For a more visible progress bar, increase height (e.g.: 4px or 5px) */
        }
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            /* To enlarge spinner, increase width and height (e.g.: 22px) */
        }
        .spinner.hidden {
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loader {
            width: 27px;
            height: 27px;
            border: 3px solid rgba(0, 123, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            /* To enlarge loader, increase width and height (e.g.: 35px) */
        }
        .password-strength {
            width: 80%;
            max-width: 300px;
            height: 3px;
            background-color: #ddd;
            margin: 5px auto 10px;
            border-radius: 10px;
            overflow: hidden;
            /* For a more visible bar, increase height (e.g.: 5px) */
        }
        .password-strength-meter {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .password-feedback {
            font-size: 12px;
            margin-bottom: 10px;
            /* To increase feedback visibility, increase font-size (e.g.: 14px) */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: var(--primary-color);
            padding: 4px;
            border-radius: 3px;
            filter: invert(1);
            /* To enlarge calendar indicator, increase padding (e.g.: 6px) */
        }
        .optional-label {
            font-size: 12px;
            color: #777;
            margin-left: 5px;
            /* To increase visibility, modify font-size (e.g.: 13px) */
        }
        .required-field::after {
            content: '*';
            color: var(--error-color);
            margin-left: 3px;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        @media (max-width: 768px) {
            .logo {
                font-size: 1.8em;
                /* To enlarge logo on mobile, increase this value (e.g.: 2em) */
            }
            .form-container {
                margin: 10px;
                padding: px;
                /* For more space on mobile, increase padding (e.g.: 20px) */
            }
            .button {
                width: 80%;
                /* To enlarge buttons on mobile, increase width (e.g.: 90%) */
            }
            .form-container input,
            .form-container select {
                width: 80%;
                /* To enlarge fields on mobile, increase width (e.g.: 90%) */
            }
            h2 {
                font-size: 26px;
                /* To enlarge titles on mobile, increase font-size (e.g.: 30px) */
            }
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>
    
    <header>
        <span class="logo" translate="no"><b>G-Z</b></span>
    </header>
    <div class="divider"></div>

    <!-- Login Form -->
    <div class="form-container" id="loginForm">
        <h2><b>Welcome Back</b></h2>
        <div id="loginMessages"></div>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button class="button" id="loginUser">
            <span class="spinner hidden" id="loginSpinner"></span>
            Login
        </button>
        <p class="toggle-button" id="showSignup"><strong><b>No account? Create one</b></strong></p>
        <p class="forgot-password" id="forgotPassword"><strong><b>Forgot password?</b></strong></p>
        <div class="footer-links">
            <a href="Terms.html">Terms</a> | 
            <a href="Confidentialité.html">Privacy</a>
        </div>
    </div>

    <!-- Account Creation Form -->
    <div class="form-container" id="signupForm" style="display: none;">
        <h2><b>Welcome</b></h2>
        <div id="signupMessages"></div>
        <input type="text" id="fullName" placeholder="Full name" required>
        <select id="signupCountry" required>
            <option value="" disabled selected>Country of birth</option>
        </select>
        <input type="date" id="birthdate" placeholder="Date of birth" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="password" id="signupPassword" placeholder="Password" required>
        <div class="password-strength">
            <div class="password-strength-meter" id="passwordStrengthMeter"></div>
        </div>
        <div class="password-feedback" id="passwordFeedback"></div>
        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
        <button class="button" id="createAccount">
            <span class="spinner hidden" id="signupSpinner"></span>
            Create Account
        </button>
        <p class="toggle-button" id="showLogin"><strong><b>Already have an account? Login</b></strong></p>
        <div class="footer-links">
            <a href="Terms.html">Terms</a> | 
            <a href="Confidentialité.html">Privacy</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrPKQOqw4zciASa_5PbI_etfkvrBaDPDI",
            authDomain: "genz-abb36.firebaseapp.com",
            databaseURL: "https://genz-abb36-default-rtdb.firebaseio.com",
            projectId: "genz-abb36",
            storageBucket: "genz-abb36.appspot.com",
            messagingSenderId: "405021535683",
            appId: "1:405021535683:web:ee5a28fde27f5558046176",
            measurementId: "G-XZNQND2J00"
        };

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const progressBar = document.getElementById('progressBar');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginMessages = document.getElementById('loginMessages');
        const signupMessages = document.getElementById('signupMessages');
        const loginSpinner = document.getElementById('loginSpinner');
        const signupSpinner = document.getElementById('signupSpinner');
        const countrySelect = document.getElementById('signupCountry');
        
        let countriesLoaded = false;
        let authCheckComplete = false;

        // Function to display messages with shorter, more concise text
        function showMessage(container, message, type = 'error') {
            const iconClass = type === 'error' ? 'fa-circle-exclamation' : 
                            type === 'success' ? 'fa-circle-check' : 
                            type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-info';
            
            container.innerHTML = `
                <div class="message ${type}">
                    <i class="fas ${iconClass}"></i>
                    ${message}
                </div>
            `;
        }

        // Progress bar function
        function simulateProgress(start, end, duration) {
            const startTime = Date.now();
            progressBar.style.width = start + '%';
            
            function updateProgress() {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min((elapsed / duration) * (end - start) + start, end);
                
                progressBar.style.width = progress + '%';
                
                if (progress < end) {
                    requestAnimationFrame(updateProgress);
                } else if (end === 100) {
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 300);
                }
            }
            
            requestAnimationFrame(updateProgress);
        }

        // Function to show/hide global loader
        function toggleLoader(show) {
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        // Function to manage button states during loading
        function setBtnLoading(button, spinner, isLoading) {
            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Password strength evaluation
        document.getElementById('signupPassword').addEventListener('input', function() {
            evaluatePasswordStrength(this.value);
        });

        function evaluatePasswordStrength(password) {
            const meter = document.getElementById('passwordStrengthMeter');
            const feedback = document.getElementById('passwordFeedback');
            
            if (!password) {
                meter.style.width = '0%';
                feedback.textContent = '';
                return;
            }

            let strength = 0;
            let message = '';

            // Check length
            if (password.length > 5) strength += 20;
            if (password.length > 8) strength += 10;

            // Check complexity
            if (/[a-z]/.test(password)) strength += 10;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 20;

            // Set color and message
            let color;
            if (strength < 30) {
                color = '#ff4d4d';
                message = 'Very weak';
            } else if (strength < 50) {
                color = '#ffaa00';
                message = 'Weak';
            } else if (strength < 70) {
                color = '#ffdd00';
                message = 'Medium';
            } else if (strength < 90) {
                color = '#4CAF50';
                message = 'Strong';
            } else {
                color = '#4CAF50';
                message = 'Very strong';
            }

            meter.style.width = strength + '%';
            meter.style.backgroundColor = color;
            feedback.textContent = message;
            feedback.style.color = color;
        }

        // Load countries on initialization - make it more reliable
        async function loadCountries() {
            if (countriesLoaded) return;
            
            try {
                // Use a reliable local fallback countries array first
                const fallbackCountries = [
                    { name: { common: "France" } },
                    { name: { common: "United States" } },
                    { name: { common: "Canada" } },
                    { name: { common: "United Kingdom" } },
                    { name: { common: "Germany" } },
                    { name: { common: "Spain" } },
                    { name: { common: "Italy" } },
                    { name: { common: "Belgium" } },
                    { name: { common: "Switzerland" } },
                    { name: { common: "Morocco" } },
                    { name: { common: "Senegal" } },
                    { name: { common: "Ivory Coast" } },
                    { name: { common: "Algeria" } },
                    { name: { common: "Tunisia" } },
                    { name: { common: "Mali" } },
                    { name: { common: "Cameroon" } }
                ];
                
                // Populate with fallback countries first to ensure UI is responsive
                populateCountrySelect(fallbackCountries);
                countriesLoaded = true;
                
                // Then try to load the full list in the background
                fetch('https://restcountries.com/v3.1/all?fields=name')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load countries');
                        }
                        return response.json();
                    })
                    .then(countries => {
                        populateCountrySelect(countries);
                    })
                    .catch(error => {
                        console.error("Error loading full country list:", error);
                        // Already populated with fallback countries, so no further action needed
                    });
            } catch (error) {
                console.error("Error in country loading function:", error);
                // This shouldn't happen since we're using a local fallback
            }
        }

        function populateCountrySelect(countries) {
            countrySelect.innerHTML = '<option value="" disabled selected>Country of birth</option>';
            
            // Sort countries by name
            countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.name.common;
                option.textContent = country.name.common;
                countrySelect.appendChild(option);
            });
        }

        // Initialization
        function init() {
            // Set max date for birth date field
            const today = new Date();
            const maxDate = today.toISOString().split('T')[0];
            document.getElementById('birthdate').setAttribute('max', maxDate);
            
            // Load countries immediately
            loadCountries();
            
            // Check authentication state only once
            if (!authCheckComplete) {
                authCheckComplete = true;
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.location.href = "gz.html";
                    }
                });
            }
        }

        // Initialize immediately
        init();

        // Account creation
        document.getElementById("createAccount").addEventListener("click", async function() {
            const createAccountBtn = this;
            setBtnLoading(createAccountBtn, signupSpinner, true);
            simulateProgress(0, 40, 300);
            
            const fullName = document.getElementById("fullName").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const country = document.getElementById("signupCountry").value;
            const birthdate = document.getElementById("birthdate").value;
            const today = new Date();

            // Field validation with shorter messages
            if (!fullName) {
                showMessage(signupMessages, "Please enter your full name", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            if (!country) {
                showMessage(signupMessages, "Please select your country", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            if (!birthdate) {
                showMessage(signupMessages, "Please enter your birth date", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }

            // Check future date
            const birthdateObj = new Date(birthdate);
            if (birthdateObj > today) {
                showMessage(signupMessages, "Birth date cannot be in the future", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }

            // Email verification
            if (!email) {
                showMessage(signupMessages, "Please enter your email", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage(signupMessages, "Invalid email format", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            if (!password) {
                showMessage(signupMessages, "Please enter a password", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            // Check password strength
            if (password.length < 6) {
                showMessage(signupMessages, "Password must be at least 6 characters", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage(signupMessages, "Passwords don't match", "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(40, 100, 100);
                return;
            }

            simulateProgress(40, 60, 300);

            try {
                showMessage(signupMessages, "Creating account...", "info");
                
                // Create user with Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                simulateProgress(60, 80, 300);
                showMessage(signupMessages, "Saving information...", "info");

                // Creation date for easier filtering
                const currentDate = new Date();
                const timestamp = currentDate.getTime();
                const dateString = currentDate.toISOString();
                
                // Extract year, month, and day from birth date for easier filtering
                const birthdateComponents = birthdate.split('-');
                const birthYear = parseInt(birthdateComponents[0]);
                const birthMonth = parseInt(birthdateComponents[1]);
                const birthDay = parseInt(birthdateComponents[2]);
                
                // Reorganize data for better filtering
                const userData = {
                    uid: user.uid,
                    profile: {
                        fullName: fullName,
                        email: email,
                        countryOfBirth: country,
                        birthdate: birthdate,
                        birthYear: birthYear,
                        birthMonth: birthMonth,
                        birthDay: birthDay
                    },
                    metadata: {
                        createdAt: dateString,
                        createdAtTimestamp: timestamp,
                        accountStatus: "active",
                        accountType: "user",
                        lastLogin: serverTimestamp()
                    }
                };
                
                try {
                    // Optimized data structure in Firestore - save to multiple collections in parallel
                    const saveOperations = [
                        // 1. Main user document
                        setDoc(doc(db, 'users', user.uid), userData),
                        
                        // 2. Collection for statistics by country
                        setDoc(doc(db, 'usersByCountry', country, 'members', user.uid), {
                            uid: user.uid,
                            fullName: fullName,
                            email: email,
                            createdAt: serverTimestamp()
                        }),
                        
                        // 3. Collection for statistics by birth year
                        setDoc(doc(db, 'usersByBirthYear', birthYear.toString(), 'members', user.uid), {
                            uid: user.uid,
                            fullName: fullName,
                            birthMonth: birthMonth,
                            birthDay: birthDay
                        }),
                        
                        // 4. Simplified collection for easier searches
                        setDoc(doc(db, 'usersList', user.uid), {
                            uid: user.uid,
                            fullName: fullName,
                            email: email,
                            country: country,
                            createdAt: serverTimestamp()
                        }),
                        
                        // 5. User information document
                        setDoc(doc(db, 'userInformation', user.uid), {
                            uid: user.uid,
                            fullName: fullName,
                            email: email,
                            country: country,
                            birthdate: birthdate,
                            registrationDate: serverTimestamp(),
                            lastUpdated: serverTimestamp(),
                            preferences: {
                                language: "en",
                                notifications: true,
                                theme: "light"
                            }
                        })
                    ];
                    
                    // Execute all save operations in parallel
                    await Promise.all(saveOperations);
                    
                } catch (dbError) {
                    console.error("Error saving to Firestore:", dbError);
                    // Continue even if database operations fail - the auth account is created
                }
                
                simulateProgress(80, 100, 300);
                showMessage(signupMessages, "Account created! Redirecting...", "success");
                
                // Redirect to gz.html
                setTimeout(() => {
                    toggleLoader(true);
                    window.location.href = "gz.html";
                }, 1500);

            } catch (error) {
                let errorMessage = "Account creation failed";
                console.error("Firebase error code:", error.code);
                
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password too weak";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email already in use";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Operation not allowed";
                }
                
                showMessage(signupMessages, errorMessage, "error");
                setBtnLoading(createAccountBtn, signupSpinner, false);
                simulateProgress(60, 100, 100);
            }
        });

        // Login
        document.getElementById("loginUser").addEventListener("click", async function() {
            const loginBtn = this;
            setBtnLoading(loginBtn, loginSpinner, true);
            simulateProgress(0, 50, 500);
            
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;

            // Field validation with shorter messages
            if (!email) {
                showMessage(loginMessages, "Please enter your email", "error");
                setBtnLoading(loginBtn, loginSpinner, false);
                simulateProgress(50, 100, 100);
                return;
            }
            if (!password) {
                showMessage(loginMessages, "Please enter your password", "error");
                setBtnLoading(loginBtn, loginSpinner, false);
                simulateProgress(50, 100, 100);
                return;
            }

            try {
                showMessage(loginMessages, "Logging in...", "info");
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Update last login in Firestore - don't wait for this to complete
                try {
                    // Use Promise.all to run these operations in parallel
                    Promise.all([
                        setDoc(doc(db, 'users', user.uid), {
                            metadata: {
                                lastLogin: serverTimestamp()
                            }
                        }, { merge: true }),
                        
                        // Record this login in history
                        setDoc(doc(collection(db, 'users', user.uid, 'loginHistory')), {
                            timestamp: serverTimestamp(),
                            device: navigator.userAgent,
                            ipInfo: "Recorded via web application"
                        })
                    ]).catch(updateError => {
                        console.error("Error updating login info:", updateError);
                        // Continue anyway - this is non-critical
                    });
                } catch (updateError) {
                    console.error("Error starting login update:", updateError);
                    // Continue anyway - this is non-critical
                }
                
                simulateProgress(50, 100, 300);
                showMessage(loginMessages, "Success! Redirecting...", "success");
                
                setTimeout(() => {
                    toggleLoader(true);
                    window.location.href = "gz.html";
                }, 1000);
                
            } catch (error) {
                let errorMessage = "Login failed";
                console.error("Login error:", error);
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Account not found";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many attempts";
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = "Account disabled";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error";
                }
                
                showMessage(loginMessages, errorMessage, "error");
                setBtnLoading(loginBtn, loginSpinner, false);
                simulateProgress(50, 100, 100);
            }
        });

        // Forgot password - improved to be more responsive
        document.getElementById("forgotPassword").addEventListener("click", async function() {
            const email = document.getElementById("loginEmail").value.trim();

            if (!email) {
                showMessage(loginMessages, "Enter email to reset password", "warning");
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage(loginMessages, "Invalid email format", "error");
                return;
            }

            // Show success message immediately to improve UX
            showMessage(loginMessages, "Sending reset email...", "info");
            simulateProgress(0, 50, 400);
            
            try {
                // Send the request in the background
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        // Success case
                        simulateProgress(50, 100, 300);
                        showMessage(loginMessages, "Reset email sent", "success");
                        
                        // Record password reset request in Firestore (non-blocking)
                        try {
                            setDoc(doc(collection(db, 'passwordResetRequests')), {
                                email: email,
                                timestamp: serverTimestamp(),
                                status: "sent",
                                userAgent: navigator.userAgent
                            }).catch(dbError => {
                                console.error("Error recording reset request:", dbError);
                                // Non-critical, continue
                            });
                        } catch (dbError) {
                            console.error("Error starting record of reset request:", dbError);
                            // Non-critical, continue
                        }
                    })
                    .catch(error => {
                        // Handle error but don't block UI
                        console.error("Reset error:", error);
                        simulateProgress(50, 100, 100);
                        
                        let errorMessage = "Password reset failed";
                        if (error.code === 'auth/user-not-found') {
                            errorMessage = "Email not found";
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = "Invalid email";
                        } else if (error.code === 'auth/too-many-requests') {
                            errorMessage = "Too many requests";
                        }
                        
                        showMessage(loginMessages, errorMessage, "error");
                    });
                
                // Continue immediately - don't block UI
                simulateProgress(50, 80, 300);
                
            } catch (error) {
                // Synchronous errors (rare)
                console.error("Synchronous reset error:", error);
                simulateProgress(50, 100, 100);
                showMessage(loginMessages, "Reset request failed", "error");
            }
        });

        // Navigation between forms
        document.getElementById("showSignup").addEventListener("click", function() {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("signupForm").style.display = "block";
            loginMessages.innerHTML = "";
            document.getElementById("fullName").focus();
        });

        document.getElementById("showLogin").addEventListener("click", function() {
            document.getElementById("signupForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
            signupMessages.innerHTML = "";
            document.getElementById("loginEmail").focus();
        });
        
        // Add event listeners for submission with Enter
        document.getElementById("loginEmail").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("loginPassword").focus();
            }
        });
        
        document.getElementById("loginPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("loginUser").click();
            }
        });
        
        // Add navigation between registration form fields with Enter
        document.getElementById("fullName").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("signupCountry").focus();
            }
        });
        
        document.getElementById("signupCountry").addEventListener("change", function() {
            document.getElementById("birthdate").focus();
        });
        
        document.getElementById("birthdate").addEventListener("change", function() {
            document.getElementById("signupEmail").focus();
        });
        
        document.getElementById("signupEmail").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("signupPassword").focus();
            }
        });
        
        document.getElementById("signupPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("confirmPassword").focus();
            }
        });
        
        document.getElementById("confirmPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("createAccount").click();
            }
        });
    </script>
</body>
</html>
