<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Z</title>
    <link rel="icon" href="https://firebasestorage.googleapis.com/v0/b/genz-abb36.firebasestorage.app/o/photo_2025-03-09_13-00-43.jpg?alt=media&token=e3d3c543-164c-4c79-8cd1-0a9c710fb002"> <!-- Profile -->
    <link href="https://fonts.googleapis.com/css2?family=Billabong&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: white;
            position: relative;
        }
        header {
            background-color: white;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h1 {
            margin: 0;
            font-size: 1.4em;
            font-family: 'Billabong', cursive;
            color: #007bff;
            border: 2px solid #007bff;
            padding: 4px;
            border-radius: 12px;
        }
        .divider {
            height: 1px;
            background-color: #007bff;
            width: 100%;
            margin-top: 5px;
        }
        .button-container {
            display: flex;
            justify-content: flex-start;
            margin-top: 5px;
            padding: 5px 0;
            overflow-x: auto;
            white-space: nowrap;
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            margin: 0 3px;
            font-size: 0.8em;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .button i {
            margin-right: 2px;
        }
        .button#statisticsButton {
            border-bottom: 1px solid lawngreen;
        }
        .notification {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #0056b3;
            font-weight: bold;
        }
        .footer-title {
            text-align: center;
            color: black;
            margin-top: 40px;
            font-size: 1.1em;
        }
        .date-input, .country-select, .submit-button {
            display: block;
            width: 330px;
            margin: 19px auto;
            padding: 5px;
            border: 1px solid #007bff;
            border-radius: 11px;
            background-color: white;
            color: black;
            font-size: 1em;
        }
        .submit-button {
            padding: 7px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: gray;
            color: white;
        }
        .reset-icon {
            color: #007bff;
            cursor: pointer;
            font-size: 1.0em;
            display: none;
            margin: 10px auto;
            text-align: center;
        }
        .rectangle {
            width: 330px;
            min-height: 30px;
            background-color: #e7f3ff;
            margin: 10px auto;
            border-radius: 40px;
            border: 1px solid #007bff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 5px;
            text-align: center;
        }
        .text-line {
            font-size: 0.8em;
            color: #0056b3;
            margin: 5px 0;
        }
        .text-line.bold {
            font-weight: bold;
            text-decoration: underline;
        }
        .link {
            color: white;
            text-decoration: none;
            background-color: #007bff;
            border-radius: 5px;
            padding: 8px 12px;
            transition: background-color 0.3s;
        }
        .link:hover {
            background-color: #0056b3;
        }
        .share-icon {
            color: #007bff;
            cursor: pointer;
            font-size: 1.3em;
            border: 1px solid #007bff;
            border-radius: 7px;
            padding: 4px;
            background-color: white;
        }
        footer {
            background-color: white;
            color: black;
            padding: 10px 15px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
        }
        .logo {
            color: #007bff;
            font-size: 1.6em;
            margin-right: 10px;
            border: 1px solid #007bff;
            border-radius: 10px;
            padding: 5px;
            background-color: rgba(0, 119, 190, 0.1);
            transition: background-color 0.3s;
        }
        .logo:hover {
            background-color: #007bff;
            color: white;
        }

        /* Styles for the modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 29% auto;
            padding: 18px;
            border: 1px solid #007bff;
            border-radius: 60px;
            width: 280px;
            max-width: 70%;
            text-align: center;
            max-height: 60vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            font-size: 1.8em;
            font-family: 'Billabong', cursive;
            margin-bottom: 10px;
            font-weight: bold;
            color: #007bff;
            text-decoration: underline;
        }
        
        .modal-footer {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        .close-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.9em;
            width: 120px;
            margin: 4px;
        }
        .close-button:hover {
            background-color: #0056b3;
        }
        .gender-category {
            font-weight: bold;
            color: #007bff;
            margin-top: 16px;
            margin-bottom: 5px;
            text-align: center;
            width: 100%;
            font-size: 1em;
        }

        /* New style for the games modal */
        .games-modal-content {
            background-color: #e7f3ff;
            margin: 20% auto;
            padding: 15px;
            border: 1px solid #007bff;
            border-radius: 40px;
            width: 315px;
            max-width: 80%;
            text-align: center;
            position: relative;
        }
        
        .invite-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            margin-top: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        /* Style for the community modal */
        .community-modal-content {
            background-color: #e7f3ff;
            margin: 20% auto;
            padding: 13px;
            border: 1px solid #007bff;
            border-radius: 40px;
            width: 315px;
            max-width: 80%;
            text-align: center;
            position: relative;
        }
        
        .birthday-channels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            text-align: center;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .birthday-channel {
            background-color: white;
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 5px;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        .birthday-channel.active {
            background-color: #007bff;
            color: white;
        }

        /* Style for months in the community modal */
        .month-section {
            margin-top: 15px;
            text-align: left;
        }
        
        .month-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
            font-size: 1em;
            text-align: center;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .day-item {
            background-color: white;
            border: 1px solid #007bff;
            border-radius: 5px;
            padding: 4px;
            font-size: 0.8em;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .day-item:hover {
            background-color: #e7f3ff;
        }
        
        .day-item.current {
            background-color: #007bff;
            color: white;
        }
        
        .user-date-info {
            font-weight: bold;
            margin: 10px 0;
            color: #0056b3;
            font-size: 1.1em;
        }
        
        /* Styles for Billabong titles */
        .billabong-title {
            font-family: 'Billabong', cursive;
            color: #007bff;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        /* Style for disabled fields */
        .disabled-field {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Style for close cross in modals */
        .modal-close {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff0800;
            background-color: white;
            border: 1px solid #007bff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal-close:hover {
            background-color: #007bff;
            color: white;
        }
        
        .discord-link {
            display: inline-block;
            margin-top: 20px;
            background-color: #5865F2;
            color: white;
            border-radius: 5px;
            padding: 8px 15px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .discord-link:hover {
            background-color: #4752C4;
        }
        
        .discord-link i {
            margin-right: 5px;
        }
        
        .game-info {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
            font-size: 0.85em;
            color: #333;
        }
        
        .game-title {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

  <header>
    <h1 translate="no">G-Z</h1>
    <div>
      <a href="Partage.html">
        <i class="fas fa-share share-icon"></i> <!-- Share icon -->
      </a>
    </div>
  </header>

  <div class="divider"></div>

  <div class="button-container">
    <a class="button" href="Faq.html" translate="yes"><i class="fas fa-question-circle"></i>FAQ</a>
    <a class="button" href="Statistiques.html" id="statisticsButton">
      <i class="fas fa-chart-bar"></i> Discover</a>
    <a class="button" href="#" id="communityButton"><i class="fas fa-users"></i>Community</a>
    <a class="button" href="#" id="gamesButton"><i class="fas fa-gamepad"></i>Games</a>
    <a class="button" href="Contact.html"><i class="fas fa-envelope"></i>Contact</a>
    <a class="button" href="Terms.html"><i class="fas fa-file-contract"></i>Terms</a>
    <a class="button" href="Confidentialité.html"><i class="fas fa-file-contract"></i>Privacy</a>
  </div>
  <script>
    const button = document.getElementById('statisticsButton');
    let colors = ['lawngreen', 'white'];
    let index = 0;
    setInterval(() => {
      button.style.borderBottom = `4px solid ${colors[index]}`;
      index = (index + 1) % colors.length; // Cycle through colors
    }, 400); // Change color every 400ms
  </script>
  <div class="divider"></div>
  <div class="notification">
    <span class="notification-text">Let's discover together the secrets of our generations.</span>
    <div class="new-message-badge"></div>
  </div>

  <div class="divider"></div>

  <div class="footer-title">
    Join us to discover the secrets of our generation in just a few clicks!
  </div>

  <input type="date" class="date-input" id="birthdate" placeholder="Select your date of birth" min="1900-01-01" max="" />
  <select class="country-select" id="countrySelect">
    <option value="" disabled selected>Select your country of birth</option>
  </select>
  <p style="text-align: center; color: black; font-size: 0.7em; margin-top: 5px; text-decoration: underline; text-decoration-color: rgb(0, 123, 191);">
    By submitting, you accept our terms of use.
  </p>
  <button class="submit-button" type="submit">Submit</button>

  <i class="fas fa-redo reset-icon" id="resetButton" title="Reset"></i>

  <div class="divider"></div>

  <div class="rectangle">
    <div class="text-line bold" style="font-size: 1em; color: #0056b3;">How does it work?</div>
    <div class="text-line"> Two selectors are available to you: the first is a calendar to choose your date of birth, and the second is a selector for your country of birth. Once your selections are made, click on "Submit". After that, you will be asked to specify your gender; click on this option to become a contributor. Finally, click on the "Discover" button, which flashes green. You will then discover two new selectors: navigate according to your preferences to explore the statistics. </div>
  </div>

  <div class="text-line" style="text-align: center; color: black;">
    <span style="color: #007bff;">_____</span> Don't miss anything <span style="color: #007bff;">_____</span>
  </div>

  <footer>
    <div class="footer-content">
      <div class="logo-container">
        <a href="https://www.facebook.com/share/15nGTcCb4i/.html" target="_blank" class="logo">
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="https://x.com/GZWRD?t=g7yvHCDW2-xPLaTTgea-YA&s=09.html" target="_blank" class="logo">
          <i class="fab fa-twitter"></i>
        </a>
        <a href="https://www.instagram.com/gzw0orld?igsh=a3M3aWpob21qcmFn.html" target="_blank" class="logo">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://discord.gg/P8VdSWQm" target="_blank" class="logo">
          <i class="fab fa-discord"></i>
        </a>
      </div>
      <div class="copyright">
        ©️ 2025 G-Z
      </div>
    </div>
  </footer>

  <!-- Gender Modal -->
  <div id="genderModal" class="modal">
    <div class="modal-content">
      <div class="billabong-title"><strong>Your gender?</strong></div>
      
      <div class="gender-category">Binary genders</div>
      <div class="modal-footer">
        <button class="close-button gender-option" value="Man">Man</button>
        <button class="close-button gender-option" value="Woman">Woman</button>
      </div>
      
      <div class="gender-category">Non-binary genders</div>
      <div class="modal-footer">
        <button class="close-button gender-option" value="Non-binary">Non-binary</button>
        <button class="close-button gender-option" value="Genderqueer">Genderqueer</button>
        <button class="close-button gender-option" value="Genderfluid">Genderfluid</button>
        <button class="close-button gender-option" value="Agender">Agender</button>
      </div>
      
      <div class="gender-category">Other gender identities</div>
      <div class="modal-footer">
        <button class="close-button gender-option" value="Transgender">Transgender</button>
        <button class="close-button gender-option" value="Two-Spirit">Two-Spirit</button>
        <button class="close-button gender-option" value="Bigender">Bigender</button>
        <button class="close-button gender-option" value="Androgyne">Androgyne</button>
      </div>
    </div>
  </div>

  <!-- Games Modal -->
  <div id="gamesModal" class="modal">
    <div class="games-modal-content">
      <div class="modal-close" id="closeGamesModal"><i class="fas fa-times"></i></div>
      <div class="billabong-title" style="color: #0056b3; margin-top: 15px;"><strong>Games</strong></div>
      <div class="text-line">
        The games are not ready to start yet. Communities have not reached sufficient numbers. As soon as enough people join, the games will begin. In the meantime, you can invite more people to help communities get ready!
      </div>
      <div class="game-info">
        <div class="game-title">Coming Soon: Kahoot Quiz Competition</div>
        <p>Connect with your birthday community and compete in exciting interactive quizzes!</p>
      </div>
      <button class="invite-button" id="inviteButton">Invite</button>
    </div>
  </div>

  <!-- Community Modal -->
  <div id="communityModal" class="modal">
    <div class="community-modal-content">
      <div class="modal-close" id="closeCommunityModal"><i class="fas fa-times"></i></div>
      <div class="billabong-title" style="color: #0056b3; margin-top: 15px;"><strong>Birthday Community</strong></div>
      
      <div id="communityNotLoggedIn" style="display: block;">
        <div class="text-line">
          Please submit your birth information first to join your birthday community.
        </div>
      </div>
      
      <div id="communityLoggedIn" style="display: none;">
        <div class="user-date-info" id="userDateInfo"></div>
        <div class="text-line">
          The Birthday Community is a unique space where people born on the same day and month (regardless of the year) are brought together in a dedicated group. They can connect, share experiences, and discover fascinating things they have in common.
          We also organize fun quiz competitions between different birthday dates using Kahoot, to entertain members and strengthen the group spirit!
        </div>
        
        <div id="discordLinkContainer" style="margin-top: 20px; display: none;">
          <div class="text-line" style="font-weight: bold;">Join G-Z's Discord server:</div>
          <a href="https://discord.gg/P8VdSWQm" class="discord-link" id="discordLink" target="_blank">
            <i class="fab fa-discord"></i> Join Now
          </a>
        </div>
      </div>
      
      <div id="allBirthdayChannels" style="display: none; max-height: 400px; overflow-y: auto;">
        <!-- Months and days will be generated here -->
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, push, remove, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

    // Firebase configuration - needed for database connection
    const firebaseConfig = {
      apiKey: "AIzaSyCrPKQOqw4zciASa_5PbI_etfkvrBaDPDI",
      authDomain: "genz-abb36.firebaseapp.com",
      databaseURL: "https://genz-abb36-default-rtdb.firebaseio.com",
      projectId: "genz-abb36",
      storageBucket: "genz-abb36.firebasestorage.app",
      messagingSenderId: "405021535683",
      appId: "1:405021535683:web:ee5a28fde27f5558046176",
      measurementId: "G-XZNQND2J00"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    
    // Variables to store user information
    let userBirthdate = null;
    let userCountry = null;
    let userGender = null;
    let dataSubmitted = false;
    let userBirthdayDay = null;
    let userBirthdayMonth = null;
    let lastSubmittedId = null;
    let userUid = null;

    // Discord server link
    const discordServerLink = "https://discord.gg/P8VdSWQm";

    // Month names in English
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    
    // Days in each month (0-indexed)
    const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    // Cookie management functions
    function setCookie(name, value, days) {
      // Set a cookie with specified expiration
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
      // Get a cookie by name
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function eraseCookie(name) {
      // Delete a cookie by setting negative expiration
      document.cookie = name + '=; Max-Age=-99999999; path=/';
    }

    // Check for cookie acceptance
    function checkCookieConsent() {
      const cookiesAccepted = getCookie('cookiesAccepted');
      if (!cookiesAccepted) {
        // Automatically set cookie accepted
        setCookie('cookiesAccepted', 'true', 365);
      }
    }

    // Authenticate anonymously with Firebase
    signInAnonymously(auth)
      .then((userCredential) => {
        const user = userCredential.user;
        userUid = user.uid;
        console.log("User connected: ", userUid);
      })
      .catch((error) => {
        console.error("Error during anonymous connection: ", error);
        
        // Generate a pseudo-random ID as fallback
        userUid = "local_" + Date.now().toString(36) + Math.random().toString(36).substring(2);
      });

    // Set max date for birthdate to today
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("birthdate").setAttribute('max', today);

    // Load countries from REST API
    fetch('https://restcountries.com/v3.1/all')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network error: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        // Sort countries alphabetically
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));
        const countrySelect = document.getElementById('countrySelect');
        countrySelect.innerHTML = '<option value="" disabled selected>Select your country of birth</option>';
        
        // Add each country to the dropdown
        data.forEach(country => {
          const option = document.createElement('option');
          option.value = country.name.common;
          option.textContent = country.name.common;
          countrySelect.appendChild(option);
        });
        
        // Load user data from cookie after loading countries
        loadUserDataFromCookie();
      })
      .catch(error => {
        console.error('Error loading countries:', error);
        // Fallback with a basic list of common countries
        const commonCountries = [
          "United States", "United Kingdom", "Canada", "Australia", 
          "France", "Germany", "Italy", "Spain", "Japan", "China", 
          "India", "Brazil", "Mexico", "Russia", "South Africa"
        ];
        
        const countrySelect = document.getElementById('countrySelect');
        countrySelect.innerHTML = '<option value="" disabled selected>Select your country of birth</option>';
        
        commonCountries.forEach(country => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          countrySelect.appendChild(option);
        });
        
        // Load user data from cookie
        loadUserDataFromCookie();
      });

    // Save user data to cookie
    function saveUserDataToCookie() {
      if (userBirthdate && userCountry && userGender) {
        const userData = {
          birthdate: userBirthdate,
          country: userCountry,
          gender: userGender,
          birthdayDay: userBirthdayDay,
          birthdayMonth: userBirthdayMonth,
          dataSubmitted: true,
          lastSubmittedId: lastSubmittedId
        };
        setCookie('userData', JSON.stringify(userData), 365);
      }
    }

    // Load user data from cookie
    function loadUserDataFromCookie() {
      const userDataCookie = getCookie('userData');
      if (userDataCookie) {
        try {
          // Parse stored data
          const userData = JSON.parse(userDataCookie);
          userBirthdate = userData.birthdate;
          userCountry = userData.country;
          userGender = userData.gender;
          userBirthdayDay = userData.birthdayDay;
          userBirthdayMonth = userData.birthdayMonth;
          dataSubmitted = userData.dataSubmitted;
          lastSubmittedId = userData.lastSubmittedId;
          
          // Update UI with loaded data
          if (dataSubmitted) {
            document.getElementById('birthdate').value = userBirthdate;
            document.getElementById('countrySelect').value = userCountry;
            
            const submitButton = document.querySelector('.submit-button');
            submitButton.textContent = "Submitted";
            submitButton.style.backgroundColor = 'green';
            submitButton.disabled = true;
            
            document.getElementById('resetButton').style.display = "block";
            
            // Disable form fields
            document.getElementById('birthdate').classList.add('disabled-field');
            document.getElementById('countrySelect').classList.add('disabled-field');
          }
        } catch (error) {
          console.error("Error parsing user data from cookie:", error);
        }
      }
    }

    // Submit button click handler
    document.querySelector('.submit-button').addEventListener('click', function() {
      const birthdate = document.getElementById('birthdate').value;
      const country = document.getElementById('countrySelect').value;

      if (birthdate && country) {
        // Store user input
        userBirthdate = birthdate;
        userCountry = country;
        
        // Extract day and month from birthdate
        const birthdateParts = birthdate.split('-');
        userBirthdayDay = parseInt(birthdateParts[2]);
        userBirthdayMonth = parseInt(birthdateParts[1]);
        
        // Update UI to show loading state
        const submitButton = document.querySelector('.submit-button');
        submitButton.textContent = "Please wait...";
        submitButton.style.backgroundColor = 'orange';

        // Disable form fields during submission
        document.getElementById('birthdate').classList.add('disabled-field');
        document.getElementById('countrySelect').classList.add('disabled-field');

        // Show gender selection modal
        document.getElementById('genderModal').style.display = 'block';
      } else {
        alert("Please enter a date of birth and select a country!");
      }
    });

    // Gender option buttons click handlers
    document.querySelectorAll('.gender-option').forEach(button => {
      button.addEventListener('click', function() {
        userGender = this.value;
        submitData(this.value);
      });
    });

    // Submit data to Firebase with localStorage fallback
    function submitData(gender) {
      const birthdate = userBirthdate;
      const country = userCountry;
      const submitButton = document.querySelector('.submit-button');

      // Always submit to localStorage first as a reliable backup
      const localSuccess = submitToLocalStorage(gender);
      
      // Then try to submit to Firebase if localStorage succeeded
      if (localSuccess) {
        try {
          // Create a new database entry
          push(ref(database, 'birthdates'), {
            date: birthdate,
            country: country,
            gender: gender,
            birthdayDay: userBirthdayDay,
            birthdayMonth: userBirthdayMonth,
            uid: userUid,
            timestamp: Date.now()
          }).then((newEntryRef) => {
            // Store the ID for potential reset
            lastSubmittedId = newEntryRef.key;
            console.log("Data successfully submitted to Firebase:", lastSubmittedId);
          }).catch((error) => {
            console.warn("Firebase submission error:", error);
            // Already submitted to localStorage, so we continue
          });
        } catch (error) {
          console.warn("Firebase submission exception:", error);
          // Already submitted to localStorage, so we continue
        }
        
        // Update UI since localStorage submission succeeded
        finishSubmission(true);
      } else {
        // Both Firebase and localStorage failed
        finishSubmission(false);
      }
    }

    // Submit to localStorage - more reliable than Firebase with permission issues
    function submitToLocalStorage(gender) {
      try {
        // Generate a pseudo-random ID
        const randomId = Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        // Store data in localStorage
        const data = {
          date: userBirthdate,
          country: userCountry,
          gender: gender,
          birthdayDay: userBirthdayDay,
          birthdayMonth: userBirthdayMonth,
          uid: userUid || randomId,
          timestamp: Date.now()
        };
        
        // Create or append to submissions array
        const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
        submissions.push(data);
        localStorage.setItem('submissions', JSON.stringify(submissions));
        
        // Store ID for reset functionality
        lastSubmittedId = lastSubmittedId || "local_" + randomId;
        
        return true;
      } catch (error) {
        console.error("localStorage submission error:", error);
        return false;
      }
    }

    // Complete the submission process and update UI
    function finishSubmission(success) {
      const submitButton = document.querySelector('.submit-button');
      
      if (success) {
        // Update UI for successful submission
        submitButton.style.backgroundColor = 'green';
        submitButton.textContent = "Submitted";
        submitButton.disabled = true;
        document.getElementById('resetButton').style.display = "block";
        document.getElementById('genderModal').style.display = 'none';
        dataSubmitted = true;
        
        // Save to cookie for persistence
        saveUserDataToCookie();
      } else {
        // Handle submission error
        submitButton.style.backgroundColor = 'red';
        submitButton.textContent = "Error";
        console.error("Error during submission");
        
        // Re-enable form fields on error
        document.getElementById('birthdate').classList.remove('disabled-field');
        document.getElementById('countrySelect').classList.remove('disabled-field');
      }
    }

    // Reset button handler
    document.getElementById('resetButton').addEventListener('click', function() {
      // Always reset localStorage first
      resetLocalStorageData();
      
      // Then try to reset Firebase if it's a Firebase ID
      if (lastSubmittedId && !lastSubmittedId.startsWith('local_')) {
        try {
          remove(ref(database, `birthdates/${lastSubmittedId}`))
            .then(() => {
              console.log("Firebase data successfully reset");
            })
            .catch((error) => {
              console.warn("Firebase reset error:", error);
              // Already reset localStorage, so we continue
            });
        } catch (error) {
          console.warn("Firebase reset exception:", error);
          // Already reset localStorage, so we continue
        }
      }
      
      // Complete the reset process
      finishReset();
    });
    
    // Reset localStorage data
    function resetLocalStorageData() {
      try {
        const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
        const filteredSubmissions = submissions.filter(sub => 
          !sub.uid || sub.uid !== userUid
        );
        localStorage.setItem('submissions', JSON.stringify(filteredSubmissions));
        return true;
      } catch (error) {
        console.error("Error resetting localStorage data:", error);
        return false;
      }
    }
    
    // Complete the reset process
    function finishReset() {
      // Reset form and UI
      document.getElementById('birthdate').value = '';
      document.getElementById('countrySelect').value = '';
      const submitButton = document.querySelector('.submit-button');
      submitButton.textContent = "Submit";
      submitButton.style.backgroundColor = 'gray';
      submitButton.disabled = false;
      document.getElementById('resetButton').style.display = "none";
      
      // Reset all user variables
      dataSubmitted = false;
      userBirthdate = null;
      userCountry = null;
      userGender = null;
      userBirthdayDay = null;
      userBirthdayMonth = null;
      lastSubmittedId = null;
      
      // Re-enable form fields
      document.getElementById('birthdate').classList.remove('disabled-field');
      document.getElementById('countrySelect').classList.remove('disabled-field');
      
      // Remove saved cookie
      eraseCookie('userData');
    }

    // Community button handler
    document.getElementById('communityButton').addEventListener('click', function() {
      const communityModal = document.getElementById('communityModal');
      
      if (!dataSubmitted) {
        // User hasn't submitted data yet
        document.getElementById('communityNotLoggedIn').style.display = 'block';
        document.getElementById('communityLoggedIn').style.display = 'none';
        document.getElementById('allBirthdayChannels').style.display = 'none';
      } else {
        // User has submitted data, show their community
        document.getElementById('communityNotLoggedIn').style.display = 'none';
        document.getElementById('communityLoggedIn').style.display = 'block';
        
        // Update date information
        const userDateInfo = document.getElementById('userDateInfo');
        const monthName = monthNames[userBirthdayMonth - 1];
        const formattedDay = userBirthdayDay.toString().padStart(2, '0');
        userDateInfo.textContent = `Your birthday: ${monthName} - ${formattedDay}`;
        
        // Show Discord link
        document.getElementById('discordLinkContainer').style.display = 'block';
        document.getElementById('discordLink').href = discordServerLink;
        
        // Generate month/day sections
        generateBirthdayChannels();
      }
      
      communityModal.style.display = 'block';
    });
    
    // Generate birthday channels organized by month and day
    function generateBirthdayChannels() {
      const container = document.getElementById('allBirthdayChannels');
      container.style.display = 'block';
      container.innerHTML = '';
      
      // Create sections for each month
      for (let i = 0; i < 12; i++) {
        const monthSection = document.createElement('div');
        monthSection.className = 'month-section';
        
        // Month title
        const monthTitle = document.createElement('div');
        monthTitle.className = 'month-title';
        monthTitle.textContent = monthNames[i];
        monthSection.appendChild(monthTitle);
        
        // Days grid
        const daysGrid = document.createElement('div');
        daysGrid.className = 'days-grid';
        
        // Add days for this month
        for (let day = 1; day <= daysInMonth[i]; day++) {
          const dayItem = document.createElement('div');
          dayItem.className = 'day-item';
          
          // Format day with leading zero
          const formattedDay = day.toString().padStart(2, '0');
          dayItem.textContent = formattedDay;
          
          // Highlight current user's birthday
          if (i + 1 === userBirthdayMonth && day === userBirthdayDay) {
            dayItem.classList.add('current');
          }
          
          // Add click event to navigate to Discord
          dayItem.addEventListener('click', function() {
            window.open(discordServerLink, '_blank');
          });
          
          daysGrid.appendChild(dayItem);
        }
        
        monthSection.appendChild(daysGrid);
        container.appendChild(monthSection);
      }
    }

    // Games button handler
    document.getElementById('gamesButton').addEventListener('click', function() {
      const gamesModal = document.getElementById('gamesModal');
      gamesModal.style.display = 'block';
    });

    // Close modal with X buttons
    document.getElementById('closeGamesModal').addEventListener('click', function() {
      document.getElementById('gamesModal').style.display = 'none';
    });

    document.getElementById('closeCommunityModal').addEventListener('click', function() {
      document.getElementById('communityModal').style.display = 'none';
    });

    // Redirect to share page from invite button
    document.getElementById('inviteButton').addEventListener('click', function() {
      window.location.href = 'Partage.html';
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const genderModal = document.getElementById('genderModal');
      const gamesModal = document.getElementById('gamesModal');
      const communityModal = document.getElementById('communityModal');
      
      if (event.target == genderModal) {
        genderModal.style.display = "none";
        const submitButton = document.querySelector('.submit-button');
        submitButton.style.backgroundColor = 'red';
        submitButton.textContent = "Error";
        
        // Re-enable fields if user closes modal without choosing
        document.getElementById('birthdate').classList.remove('disabled-field');
        document.getElementById('countrySelect').classList.remove('disabled-field');
      }
      
      if (event.target == gamesModal) {
        gamesModal.style.display = "none";
      }
      
      if (event.target == communityModal) {
        communityModal.style.display = "none";
      }
    };

    // Run on page load
    checkCookieConsent();
  </script>
</body>
</html>
