<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login / Sign Up - Monetizelt</title>
    <link href="https://fonts.googleapis.com/css2?family=Billabong&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --background-color: #f5f5f5;
            --text-color: #333;
            --white: #ffffff;
            --error-color: #ff3333;
            --success-color: #28a745;
            --warning-color: #ffc107;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.3;
            font-size: 13px;
        }
        header {
            background-color: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            font-size: 4.9em;
            font-family: 'Billabong', cursive;
            color: var(--primary-color);
            border: 1.5px solid var(--primary-color);
            padding: 0px 11px;
            border-radius: 13px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            width: 100%;
            margin: 2px 0;
        }
        .form-container {
            padding: 12px;
            text-align: center;
            background-color: #e9f5ff;
            border: 1px solid var(--primary-color);
            border-radius: 30px;
            margin: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            animation: slideUp 0.8s ease-out;
            position: relative;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .button {
            display: block;
            background-color: #0077BE;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px;
            margin: 12px auto;
            text-decoration: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            text-align: center;
            position: relative;
        }
        .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .form-container input,
        .form-container select,
        .form-container textarea {
            padding: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 12px;
            font-size: 13px;
            -webkit-appearance: none;
            appearance: none;
        }
        .toggle-button {
            cursor: pointer;
            margin: 12px;
            color: var(--primary-color);
            text-decoration: underline;
        }
        h2 {
            margin-bottom: 20px;
            font-size: 32px;
            color: var(--primary-dark);
            font-family: 'Billabong', cursive;
            font-weight: normal;
        }
        .forgot-password {
            margin-top: 12px;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }
        .message {
            margin: 12px auto;
            padding: 10px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 13px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s ease;
            line-height: 1.4;
        }
        .message i {
            margin-right: 8px;
            font-size: 15px;
        }
        .message.error {
            background-color: rgba(255, 51, 51, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(255, 51, 51, 0.3);
        }
        .message.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        .message.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .message.info {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(0, 123, 255, 0.3);
        }
        .footer-links {
            margin-top: 18px;
            font-size: 11px;
        }
        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
        }
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0;
            z-index: 1100;
            transition: width 0.3s ease;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
        }
        .spinner.hidden {
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 123, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        .password-strength {
            width: 80%;
            max-width: 300px;
            height: 4px;
            background-color: #ddd;
            margin: 4px auto 12px;
            border-radius: 10px;
            overflow: hidden;
        }
        .password-strength-meter {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .password-feedback {
            font-size: 11px;
            margin-bottom: 12px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: var(--primary-color);
            padding: 5px;
            border-radius: 3px;
            filter: invert(1);
        }
        .account-type-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .account-type-btn {
            padding: 8px 16px;
            border: 1px solid var(--primary-color);
            background-color: var(--white);
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .account-type-btn:first-child {
            border-radius: 15px 0 0 15px;
        }
        .account-type-btn:last-child {
            border-radius: 0 15px 15px 0;
        }
        .account-type-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .field-group {
            display: none;
        }
        .field-group.active {
            display: block;
        }
        .form-section {
            margin-bottom: 15px;
        }
        .form-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }
        .loading-dots {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            height: 16px;
        }
        .loading-dots .dot {
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            margin: 0 3px;
            animation: dotPulse 1.4s infinite ease-in-out;
        }
        .loading-dots .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        .loading-dots.hidden {
            display: none;
        }
        @keyframes dotPulse {
            0%, 80%, 100% { 
                transform: scale(0);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1); 
                opacity: 1;
            }
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        @media (max-width: 768px) {
            .logo {
                font-size: 1.8em;
            }
            .form-container {
                margin: 12px;
                padding: 16px;
            }
            .button {
                width: 90%;
            }
            .form-container input,
            .form-container select,
            .form-container textarea {
                width: 90%;
            }
            h2 {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>
    
    <header>
        <span class="logo" translate="no"><b>Monetizelt</b></span>
    </header>
    <div class="divider"></div>

    <div class="form-container" id="loginForm">
        <h2><b>Welcome Back</b></h2>
        <div id="loginMessages"></div>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button class="button" id="loginUser">
            <div class="loading-dots hidden" id="loginDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            Login
        </button>
        <p class="toggle-button" id="showSignup"><strong><b>No account? Sign up</b></strong></p>
        <p class="forgot-password" id="forgotPassword"><strong><b>Forgot password?</b></strong></p>
        <div class="footer-links">
            <a href="terms.html">Terms of Use</a> | 
            <a href="privacy.html">Privacy Policy</a>
        </div>
    </div>

    <div class="form-container" id="signupForm" style="display: none;">
        <h2><b>Welcome</b></h2>
        <div id="signupMessages"></div>
        
        <div class="account-type-selector">
            <button class="account-type-btn active" id="individualBtn">Individual</button>
            <button class="account-type-btn" id="businessBtn">Business</button>
        </div>
        
        <div class="form-section">
            <div class="form-section-title">Account Information</div>
            <input type="text" id="fullName" placeholder="Full name" required>
            <select id="signupCountry" required>
                <option value="" disabled selected>Select your country</option>
            </select>
            <input type="date" id="birthdate" required>
            <input type="email" id="signupEmail" placeholder="Enter your email" required>
            <input type="password" id="signupPassword" placeholder="Create a password" required>
            <div class="password-strength">
                <div class="password-strength-meter" id="passwordStrengthMeter"></div>
            </div>
            <div class="password-feedback" id="passwordFeedback"></div>
            <input type="password" id="confirmPassword" placeholder="Confirm password" required>
        </div>
        
        <div class="field-group active" id="individualFields">
            <div class="form-section">
                <div class="form-section-title">Personal Information</div>
                <input type="tel" id="individualPhone" placeholder="Phone number" required>
                <textarea id="individualAddress" placeholder="Home address" rows="3" required></textarea>
                <select id="individualOccupation" required>
                    <option value="" disabled selected>Select your occupation</option>
                    <option value="student">Student</option>
                    <option value="employed">Employed</option>
                    <option value="self-employed">Self-employed</option>
                    <option value="unemployed">Unemployed</option>
                    <option value="retired">Retired</option>
                </select>
            </div>
        </div>
        
        <div class="field-group" id="businessFields">
            <div class="form-section">
                <div class="form-section-title">Business Information</div>
                <input type="text" id="companyName" placeholder="Company name" required>
                <input type="text" id="businessRegistrationNumber" placeholder="Business registration number" required>
                <select id="companySize" required>
                    <option value="" disabled selected>Company size</option>
                    <option value="1-10">1-10 employees</option>
                    <option value="11-50">11-50 employees</option>
                    <option value="51-200">51-200 employees</option>
                    <option value="201-500">201-500 employees</option>
                    <option value="500+">500+ employees</option>
                </select>
                <input type="tel" id="businessPhone" placeholder="Business phone" required>
                <textarea id="businessAddress" placeholder="Business address" rows="3" required></textarea>
                <input type="text" id="businessWebsite" placeholder="Business website (optional)">
            </div>
        </div>
        
        <button class="button" id="createAccount">
            <div class="loading-dots hidden" id="signupDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            Create Account
        </button>
        <p class="toggle-button" id="showLogin"><strong><b>Already have an account? Log in</b></strong></p>
        <div class="footer-links">
            <a href="terms.html">Terms of Use</a> | 
            <a href="privacy.html">Privacy Policy</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF4I7E6-_z8y_8n8P35zyKbh9WOEtIzMQ",
            authDomain: "monetizelt-b235d.firebaseapp.com",
            databaseURL: "https://monetizelt-b235d-default-rtdb.firebaseio.com",
            projectId: "monetizelt-b235d",
            storageBucket: "monetizelt-b235d.firebasestorage.app",
            messagingSenderId: "1040211471009",
            appId: "1:1040211471009:web:321898c7bdca6258ce9ee0",
            measurementId: "G-5NWKR1E9VY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const progressBar = document.getElementById('progressBar');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginMessages = document.getElementById('loginMessages');
        const signupMessages = document.getElementById('signupMessages');
        const loginDots = document.getElementById('loginDots');
        const signupDots = document.getElementById('signupDots');
        const countrySelect = document.getElementById('signupCountry');
        const individualBtn = document.getElementById('individualBtn');
        const businessBtn = document.getElementById('businessBtn');
        const individualFields = document.getElementById('individualFields');
        const businessFields = document.getElementById('businessFields');
        
        let currentAccountType = 'individual';
        let countriesLoaded = false;
        let redirectionActive = false;

        // Fonction pour générer un ID utilisateur unique de 6 caractères
        function generateUserId() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = '';
            
            // Assure qu'il y a au moins 3 lettres et 3 chiffres
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const numbers = "0123456789";
            
            // Ajoute 3 lettres aléatoires
            for (let i = 0; i < 3; i++) {
                result += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            
            // Ajoute 3 chiffres aléatoires
            for (let i = 0; i < 3; i++) {
                result += numbers.charAt(Math.floor(Math.random() * numbers.length));
            }
            
            // Mélange les caractères pour obtenir un ID moins prévisible
            return result.split('').sort(() => 0.5 - Math.random()).join('');
        }
        
        // Fonction pour vérifier si un userId existe déjà
        async function isUserIdUnique(userId) {
            try {
                const userSnapshot = await getDoc(doc(db, "users", `userId_${userId}`));
                return !userSnapshot.exists();
            } catch (error) {
                console.error("Error checking userId uniqueness:", error);
                return false;
            }
        }
        
        // Fonction pour générer un userId unique
        async function generateUniqueUserId() {
            let userId;
            let isUnique = false;
            let attempts = 0;
            
            // Essaie jusqu'à trouver un ID unique (maximum 10 tentatives)
            while (!isUnique && attempts < 10) {
                userId = generateUserId();
                isUnique = await isUserIdUnique(userId);
                attempts++;
            }
            
            return userId;
        }

        function showMessage(container, message, type = 'error') {
            const iconClass = type === 'error' ? 'fa-circle-exclamation' : 
                            type === 'success' ? 'fa-circle-check' : 
                            type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-info';
            
            container.innerHTML = `
                <div class="message ${type}">
                    <i class="fas ${iconClass}"></i>
                    ${message}
                </div>
            `;
        }

        function simulateProgress(start, end, duration) {
            const startTime = Date.now();
            progressBar.style.width = start + '%';
            
            function updateProgress() {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min((elapsed / duration) * (end - start) + start, end);
                
                progressBar.style.width = progress + '%';
                
                if (progress < end) {
                    requestAnimationFrame(updateProgress);
                } else if (end === 100) {
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 300);
                }
            }
            
            requestAnimationFrame(updateProgress);
        }

        function toggleLoader(show) {
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function setBtnLoading(button, dots, isLoading) {
            if (isLoading) {
                button.disabled = true;
                dots.classList.remove('hidden');
            } else {
                button.disabled = false;
                dots.classList.add('hidden');
            }
        }

        document.getElementById('signupPassword').addEventListener('input', function() {
            evaluatePasswordStrength(this.value);
        });

        function evaluatePasswordStrength(password) {
            const meter = document.getElementById('passwordStrengthMeter');
            const feedback = document.getElementById('passwordFeedback');
            
            if (!password) {
                meter.style.width = '0%';
                feedback.textContent = '';
                return;
            }

            let strength = 0;
            let message = '';

            if (password.length > 5) strength += 20;
            if (password.length > 8) strength += 10;

            if (/[a-z]/.test(password)) strength += 10;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 20;

            let color;
            if (strength < 30) {
                color = '#ff4d4d';
                message = 'Very weak password';
            } else if (strength < 50) {
                color = '#ffaa00';
                message = 'Weak password';
            } else if (strength < 70) {
                color = '#ffdd00';
                message = 'Medium password';
            } else if (strength < 90) {
                color = '#4CAF50';
                message = 'Strong password';
            } else {
                color = '#4CAF50';
                message = 'Very strong password';
            }

            meter.style.width = strength + '%';
            meter.style.backgroundColor = color;
            feedback.textContent = message;
            feedback.style.color = color;
        }

        individualBtn.addEventListener('click', function() {
            individualBtn.classList.add('active');
            businessBtn.classList.remove('active');
            individualFields.classList.add('active');
            businessFields.classList.remove('active');
            currentAccountType = 'individual';
        });

        businessBtn.addEventListener('click', function() {
            businessBtn.classList.add('active');
            individualBtn.classList.remove('active');
            businessFields.classList.add('active');
            individualFields.classList.remove('active');
            currentAccountType = 'business';
        });

        async function loadCountries() {
            if (countriesLoaded) return;
            
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
                
                if (!response.ok) {
                    throw new Error('Failed to load countries');
                }
                
                const countries = await response.json();
                populateCountrySelect(countries);
                countriesLoaded = true;
            } catch (error) {
                console.error("Error loading countries:", error);
                const fallbackCountries = [
                    { name: { common: "United States" } },
                    { name: { common: "United Kingdom" } },
                    { name: { common: "Canada" } },
                    { name: { common: "Australia" } },
                    { name: { common: "Germany" } },
                    { name: { common: "France" } },
                    { name: { common: "Spain" } },
                    { name: { common: "Italy" } },
                    { name: { common: "Japan" } },
                    { name: { common: "China" } }
                ];
                populateCountrySelect(fallbackCountries);
                countriesLoaded = true;
            }
        }

        function populateCountrySelect(countries) {
            countrySelect.innerHTML = '<option value="" disabled selected>Select your country</option>';
            
            countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.name.common;
                option.textContent = country.name.common;
                countrySelect.appendChild(option);
            });
        }

        function init() {
            const today = new Date();
            const maxDate = today.toISOString().split('T')[0];
            document.getElementById('birthdate').setAttribute('max', maxDate);
            
            loadCountries();
            
            onAuthStateChanged(auth, (user) => {
                if (user && !redirectionActive) {
                    checkUserProfileAndRedirect(user);
                }
            });
        }
        
        async function checkUserProfileAndRedirect(user) {
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    window.location.href = "dashboard.html";
                }
            } catch (error) {
                console.error("Error checking user profile:", error);
            }
        }

        init();

        document.getElementById("createAccount").addEventListener("click", async function() {
            const createAccountBtn = this;
            setBtnLoading(createAccountBtn, signupDots, true);
            simulateProgress(0, 40, 300);
            
            const fullName = document.getElementById("fullName").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const country = document.getElementById("signupCountry").value;
            const birthdate = new Date(document.getElementById("birthdate").value);
            const today = new Date();

            if (!fullName) {
                showMessage(signupMessages, "Please enter your full name", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            if (!country) {
                showMessage(signupMessages, "Please select your country", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            if (!birthdate || isNaN(birthdate.getTime())) {
                showMessage(signupMessages, "Please enter a valid birth date", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }

            const age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            const adjustedAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate()) ? age - 1 : age;

            if (adjustedAge < 18) {
                showMessage(signupMessages, "You must be at least 18 years old", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }

            if (!email) {
                showMessage(signupMessages, "Please enter your email address", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage(signupMessages, "Please enter a valid email address", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            if (!password) {
                showMessage(signupMessages, "Please enter a password", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            if (password.length < 6) {
                showMessage(signupMessages, "Password must be at least 6 characters", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage(signupMessages, "Passwords don't match", "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(40, 100, 100);
                return;
            }

            let userData = {
                fullName: fullName,
                email: email,
                country: country,
                birthdate: birthdate.toISOString().split('T')[0],
                accountType: currentAccountType,
                createdAt: serverTimestamp(),
                lastLogin: serverTimestamp(),
                products: [],
                linksCount: 0,
                viewsCount: 0,
                ordersCount: 0,
                shippedCount: 0,
                revenueCount: 0,
                onboardingComplete: false,
                transactions: [],
            };
            
            if (currentAccountType === 'individual') {
                const phone = document.getElementById("individualPhone").value.trim();
                const address = document.getElementById("individualAddress").value.trim();
                const occupation = document.getElementById("individualOccupation").value;
                
                if (!phone) {
                    showMessage(signupMessages, "Please enter your phone number", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!address) {
                    showMessage(signupMessages, "Please enter your address", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!occupation) {
                    showMessage(signupMessages, "Please select your occupation", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                // Ajout des données individuelles directement dans l'objet userData
                userData = {
                    ...userData,
                    phone: phone,
                    address: address,
                    occupation: occupation
                };
            } else { // business
                const companyName = document.getElementById("companyName").value.trim();
                const registrationNumber = document.getElementById("businessRegistrationNumber").value.trim();
                const companySize = document.getElementById("companySize").value;
                const businessPhone = document.getElementById("businessPhone").value.trim();
                const businessAddress = document.getElementById("businessAddress").value.trim();
                const website = document.getElementById("businessWebsite").value.trim();
                
                if (!companyName) {
                    showMessage(signupMessages, "Please enter your company name", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!registrationNumber) {
                    showMessage(signupMessages, "Please enter business registration number", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!companySize) {
                    showMessage(signupMessages, "Please select your company size", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!businessPhone) {
                    showMessage(signupMessages, "Please enter business phone", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                if (!businessAddress) {
                    showMessage(signupMessages, "Please enter business address", "error");
                    setBtnLoading(createAccountBtn, signupDots, false);
                    simulateProgress(40, 100, 100);
                    return;
                }
                
                // Ajout des données business directement dans l'objet userData
                userData = {
                    ...userData,
                    companyName: companyName,
                    registrationNumber: registrationNumber,
                    companySize: companySize,
                    phone: businessPhone,
                    address: businessAddress,
                    website: website || null
                };
            }

            simulateProgress(40, 60, 300);

            try {
                showMessage(signupMessages, "Creating your account...", "info");
                
                // Création du compte utilisateur
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                simulateProgress(60, 80, 400);
                showMessage(signupMessages, "Generating your unique ID...", "info");

                // Génération d'un ID utilisateur unique
                const userId = await generateUniqueUserId();
                
                if (!user || !user.uid) {
                    throw new Error("Failed to get user UID");
                }

                // Mise à jour des données utilisateur avec uid et userId
                userData = {
                    ...userData,
                    uid: user.uid,
                    userId: userId
                };

                // Enregistrement des données utilisateur dans la collection users
                await setDoc(doc(db, "users", user.uid), userData);
                
                // Sauvegarde de l'ID utilisateur pour vérifier l'unicité
                await setDoc(doc(db, "users", `userId_${userId}`), {
                    uid: user.uid,
                    createdAt: serverTimestamp()
                });
                
                simulateProgress(80, 100, 300);
                showMessage(signupMessages, "Your account has been created successfully! Redirecting in 5 seconds...", "success");
                
                // Définir que la redirection est active pour éviter des doubles redirections
                redirectionActive = true;

                // Délai de 5 secondes avant la redirection vers le dashboard
                setTimeout(() => {
                    toggleLoader(true);
                    window.location.href = "dashboard.html"; 
                }, 5000);
                
            } catch (error) {
                let errorMessage = "Error creating account";
                
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email address format";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password should be at least 6 characters";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already associated with an account";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your internet connection";
                } else {
                    console.error("Signup error:", error);
                    errorMessage = "Error: " + (error.message || "Failed to create account. Please try again.");
                }
                
                showMessage(signupMessages, errorMessage, "error");
                setBtnLoading(createAccountBtn, signupDots, false);
                simulateProgress(60, 100, 100);
            }
        });

        document.getElementById("loginUser").addEventListener("click", async function() {
            const loginBtn = this;
            setBtnLoading(loginBtn, loginDots, true);
            simulateProgress(0, 50, 500);
            
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;

            if (!email) {
                showMessage(loginMessages, "Please enter your email", "error");
                setBtnLoading(loginBtn, loginDots, false);
                simulateProgress(50, 100, 100);
                return;
            }
            if (!password) {
                showMessage(loginMessages, "Please enter your password", "error");
                setBtnLoading(loginBtn, loginDots, false);
                simulateProgress(50, 100, 100);
                return;
            }

            try {
                showMessage(loginMessages, "Logging in...", "info");
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                try {
                    await setDoc(doc(db, "users", user.uid), {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                } catch (updateError) {
                    console.error("Error updating last login:", updateError);
                }
                
                simulateProgress(50, 100, 300);
                showMessage(loginMessages, "Login successful! Redirecting...", "success");
                
                // Définir que la redirection est active
                redirectionActive = true;
                
                // Délai de 2 secondes avant la redirection vers le dashboard
                setTimeout(() => {
                    toggleLoader(true);
                    window.location.href = "dashboard.html"; 
                }, 2000);
            } catch (error) {
                let errorMessage;
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email address";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password. Please try again";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your internet connection";
                } else {
                    errorMessage = "Login error. Please try again later";
                    console.error("Login error:", error);
                }
                
                showMessage(loginMessages, errorMessage, "error");
                setBtnLoading(loginBtn, loginDots, false);
                simulateProgress(50, 100, 100);
            }
        });

        document.getElementById("forgotPassword").addEventListener("click", async function() {
            const email = document.getElementById("loginEmail").value.trim();

            if (!email) {
                showMessage(loginMessages, "Please enter your email address to reset your password", "warning");
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage(loginMessages, "Please enter a valid email address", "error");
                return;
            }

            try {
                toggleLoader(true);
                simulateProgress(0, 70, 800);
                
                await sendPasswordResetEmail(auth, email);
                
                simulateProgress(70, 100, 300);
                toggleLoader(false);
                
                showMessage(loginMessages, "Password reset email has been sent. Please check your inbox and spam folder", "success");
            } catch (error) {
                toggleLoader(false);
                
                let errorMessage;
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email address";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many requests. Please try again later";
                } else {
                    errorMessage = "Error sending password reset email. Please try again";
                }
                
                showMessage(loginMessages, errorMessage, "error");
                simulateProgress(70, 100, 100);
            }
        });

        document.getElementById("showSignup").addEventListener("click", function() {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("signupForm").style.display = "block";
            loginMessages.innerHTML = "";
            document.getElementById("fullName").focus();
        });

        document.getElementById("showLogin").addEventListener("click", function() {
            document.getElementById("signupForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
            signupMessages.innerHTML = "";
            document.getElementById("loginEmail").focus();
        });
        
        document.getElementById("loginEmail").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("loginPassword").focus();
            }
        });
        
        document.getElementById("loginPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("loginUser").click();
            }
        });
        
        document.getElementById("fullName").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("signupCountry").focus();
            }
        });
        
        document.getElementById("signupCountry").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("birthdate").focus();
            }
        });
        
        document.getElementById("birthdate").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("signupEmail").focus();
            }
        });
        
        document.getElementById("signupEmail").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("signupPassword").focus();
            }
        });
        
        document.getElementById("signupPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                document.getElementById("confirmPassword").focus();
            }
        });
        
        document.getElementById("confirmPassword").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                if (currentAccountType === 'individual') {
                    document.getElementById("individualPhone").focus();
                } else {
                    document.getElementById("companyName").focus();
                }
            }
        });
    </script>
</body>
</html>
